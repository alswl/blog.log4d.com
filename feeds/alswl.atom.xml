<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Log4D</title><link href="https://blog.alswl.com/" rel="alternate"></link><link href="https://blog.alswl.com/feeds/alswl.atom.xml" rel="self"></link><id>https://blog.alswl.com/</id><updated>2018-06-20T20:18:52+08:00</updated><entry><title>从 SQL Server 到 MySQL （三）：愚公移山 - 开源力量</title><link href="https://blog.alswl.com/2018/06/sql-server-migration-3/" rel="alternate"></link><published>2018-06-20T20:18:52+08:00</published><updated>2018-06-20T20:18:52+08:00</updated><author><name>alswl</name></author><id>tag:blog.alswl.com,2018-06-20:2018/06/sql-server-migration-3/</id><summary type="html">&lt;p&gt;&lt;img alt="201806/refactor.png" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201806/refactor.png"/&gt;&lt;/p&gt;
&lt;p&gt;我们用了两章文章
&lt;a href="https://blog.alswl.com/2018/03/sql-server-migration-1/"&gt;从 SQL Server 到 MySQL（一）：异构数据库迁移&lt;/a&gt;
/
&lt;a href="https://blog.alswl.com/2018/05/sql-server-migration-2/"&gt;从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机&lt;/a&gt;
介绍我们遇到问题和解决方案。
不管是离线全量迁移还是在线无缝迁移，
核心 ETL 工具就是 yugong。&lt;/p&gt;
&lt;p&gt;Yugong 是一个成熟工具， 在阿里巴巴去 IOE 行动中起了重要作用，
它与 Otter / Canal 都是阿里中间件团队出品。
它们三者各有分工：
Yugong 设计目标是异构数据库迁移；
Canal 设计用来解决 MySQL binlog 订阅和消费问题；
Otter 则是在 Canal 之上，以准实时标准解决数据库同步问题。
Otter 配备了相对 yugong 更健壮管理工具、分布式协调工具，
从而长期稳定运行。Yugong 设计目标则是一次性迁移工作，偏 Job 类型。
当然 yugong 本身质量不错，长期运行也没问题。
我们有个产线小伙伴使用我们魔改后 yugong，
用来将数据从管理平台同步数据到用户前台，已经稳定跑了半年多了。&lt;/p&gt;

&lt;h2 id="yugong-xi-tong-jie-gou"&gt;yugong 系统结构&lt;/h2&gt;
&lt;p&gt;这里我不赘述如何使用 yugong，有需求同学直接去
&lt;a href="https://github.com/alibaba/yugong"&gt;官方文档&lt;/a&gt; 查看使用文档。&lt;/p&gt;
&lt;p&gt;我直接进入关键环节：解剖 yugong 核心模块。
Yugong 数据流是标准 ETL 流程，分别有 Extractor / Translator / Applier
这三个大类来实现 ETL 过程:&lt;/p&gt;
&lt;p&gt;&lt;img alt="ETL &amp;amp; Java Class" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201806/etl.png"/&gt;&lt;/p&gt;
&lt;p&gt;我们依次来看看这三大类具体设计。&lt;/p&gt;
&lt;h3 id="extractor"&gt;Extractor&lt;/h3&gt;
&lt;p&gt;&lt;img alt="Extractor Class" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201806/extractor.png"/&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;YuGongLifeCycle&lt;/code&gt;：Yugong 组件生命周期声明&lt;/li&gt;
&lt;li&gt;&lt;code&gt;AbstractYuGongLifeCycle&lt;/code&gt;：Yugong 组件生命周期一些实现&lt;/li&gt;
&lt;li&gt;&lt;code&gt;RecordExtractor&lt;/code&gt;：基础 Extractor Interface&lt;/li&gt;
&lt;li&gt;&lt;code&gt;AbstractRecordExtractor&lt;/code&gt;：基础 Extractor 虚拟类，做了一部分实现&lt;/li&gt;
&lt;li&gt;&lt;code&gt;AbstractOracleRecordExtractor&lt;/code&gt;：Oracle Extractor 虚拟类，做了一部分 Oracle 相关实现&lt;/li&gt;
&lt;li&gt;&lt;code&gt;OracleOnceFullRecordExtractor&lt;/code&gt;：Oracle 基于特定 SQL 一次性 Extractor&lt;/li&gt;
&lt;li&gt;&lt;code&gt;OracleFullRecordExtractor&lt;/code&gt;：Oracle 全量 Extractor&lt;/li&gt;
&lt;li&gt;&lt;code&gt;OracleRecRecordExtractor&lt;/code&gt;：Oracle 记录 Extractor，用来创建物化视图&lt;/li&gt;
&lt;li&gt;&lt;code&gt;OracleMaterializedIncRecordExtractor&lt;/code&gt;：基于（已有）物化视图 Oracle 增量 Extrator&lt;/li&gt;
&lt;li&gt;&lt;code&gt;OracleAllRecordExtractor&lt;/code&gt;：Oracle 自动化 Extractor，先 Mark 再 Full，再 Inc&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Exctractor 从 Source DB 读取数据写入内存，
Yugong 官方提供 Extractor 抽象出 &lt;code&gt;AbstractRecordExtractor&lt;/code&gt; 类，
其余类都是围绕 Oracle 实现。
另外 Yugong 设计了 &lt;code&gt;YuGongLifeCycle&lt;/code&gt; 类实现了组件生命周期管理。&lt;/p&gt;
&lt;h3 id="translator"&gt;Translator&lt;/h3&gt;
&lt;p&gt;&lt;img alt="Translator Class" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201806/translator.png"/&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;DataTranslator&lt;/code&gt;：Translator 基类，为 Row 级别数据处理&lt;/li&gt;
&lt;li&gt;&lt;code&gt;TableTranslator&lt;/code&gt;：Translator 基类，为 Table 级别提供处理（官方代码中没有使用）&lt;/li&gt;
&lt;li&gt;&lt;code&gt;AbstractDataTranslator&lt;/code&gt;：Data Translator 虚拟类，做了部分实现&lt;/li&gt;
&lt;li&gt;&lt;code&gt;EncodeDataTranslator&lt;/code&gt;：转换编码格式 Translator&lt;/li&gt;
&lt;li&gt;&lt;code&gt;OracleIncreamentDataTranslator&lt;/code&gt;：为 Oracle 增量数据准备 Translator，会调整一些数据状态&lt;/li&gt;
&lt;li&gt;&lt;code&gt;BackTableDataTranslator&lt;/code&gt;：Demo，允许在 Translator 中做回写数据操作&lt;/li&gt;
&lt;li&gt;&lt;code&gt;BillOutDataTranslator&lt;/code&gt;：Demo，包含一些阿里业务逻辑 Translator&lt;/li&gt;
&lt;li&gt;&lt;code&gt;MidBillOutDetailDataTranslator&lt;/code&gt;：Demo，包含一些阿里业务逻辑 Translator&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Translator 读取内存中 RowData 然后变换，
大部分 Translator 做一些无状态操作，比如编码转换。
另外还有一小部分 Translator 做了业务逻辑操作，比如做一些数据回写。&lt;/p&gt;
&lt;h3 id="applier"&gt;Applier&lt;/h3&gt;
&lt;p&gt;&lt;img alt="Applier Class" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201806/applier.png"/&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;RecordApplier&lt;/code&gt;：基础 Applier Interface&lt;/li&gt;
&lt;li&gt;&lt;code&gt;AbstractRecordApplier&lt;/code&gt;：基础 Applier 虚拟类，做了一部分实现&lt;/li&gt;
&lt;li&gt;&lt;code&gt;CheckRecordRecordApplier&lt;/code&gt;：检查数据一致性 Applier，不做数据写入&lt;/li&gt;
&lt;li&gt;&lt;code&gt;FullRecordRecordApplier&lt;/code&gt;：全量数据 Applier，使用 UPSERT 做数据更新&lt;/li&gt;
&lt;li&gt;&lt;code&gt;IncreamentRecordApplier&lt;/code&gt;：增量 Applier，使用 Oracle 物化视图为数据源&lt;/li&gt;
&lt;li&gt;&lt;code&gt;AllRecordRecordApplier&lt;/code&gt;：自动化 Applier，先使用全量数据 Applier，然后使用增量数据 Applier&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Applier 将经过 Translator 处理过的数据写入 Target DB。
Yugong 提供了一致性检查、全量、增量 Applier。
比较特殊是 &lt;code&gt;AllRecordRecordApplier&lt;/code&gt; 提供了全套自动化操作。&lt;/p&gt;
&lt;h2 id="others_1"&gt;Others&lt;/h2&gt;
&lt;p&gt;除了 ETL 三个要素，yugong 还有一些重要类：控制类和工具类。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;SqlTemplate&lt;/code&gt;：提供 CRUD / UPSERT 等操作的基类 SQL 模板&lt;/li&gt;
&lt;li&gt;&lt;code&gt;OracleSqlTemplate&lt;/code&gt;：基于 SqlTemplate 实现的 Oracle SQL 模板&lt;/li&gt;
&lt;li&gt;&lt;code&gt;RecordDiffer&lt;/code&gt;：一致性检查 differ&lt;/li&gt;
&lt;li&gt;&lt;code&gt;YugongController&lt;/code&gt;：应用控制器，控制整个应用数据流向&lt;/li&gt;
&lt;li&gt;&lt;code&gt;YugongInstance&lt;/code&gt;：控制单个迁移任务实例，一张表对应一个 YugongInstance&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="lao-zhan-shi-de-wen-ti"&gt;老战士的问题&lt;/h2&gt;
&lt;p&gt;说 yugong 有问题会有些标题党，毕竟它是久经考验老战士了。
但对我们来说，开源版本 yugong 还有一些不足：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;不支持 SQL Server 读取&lt;/li&gt;
&lt;li&gt;不支持 SQL Server 写入（Rollback 需要写入 SQL Server）&lt;/li&gt;
&lt;li&gt;不支持 MySQL 读取&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;除了数据库支持，Yugong 在工程上面倒是也有一些改善空间。
我们最后花费了不少时间，做了工程上改进。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;抛弃默认打包方式（基于 maven-assembly-plugin 生成类似 LFS 结构 tar.gz 文件），
    改为使用 fat jar 模式打包，仅生成单文件可执行 jar 包&lt;/li&gt;
&lt;li&gt;抛弃 ini 配置文件，使用 YAML 配置文件格式（已有老配置仍然使用 ini 文件，YAML 主要管理表结构变更）&lt;/li&gt;
&lt;li&gt;改造 Plugin 模式，将 Java 运行时编译改为反射获取 Java 类&lt;/li&gt;
&lt;li&gt;拆分 Unit Test / Integration Test，降低重构成本&lt;/li&gt;
&lt;li&gt;重构 Oracle 继承结构，使其开放 SQL Server / MySQL 接口&lt;/li&gt;
&lt;li&gt;支持 Canal Redis 格式数据作为 MySQL 在线增量数据源&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="gai-zao-zhi-hou-jie-gou"&gt;改造之后结构&lt;/h2&gt;
&lt;h3 id="extractor_1"&gt;Extractor&lt;/h3&gt;
&lt;p&gt;&lt;img alt="Extractor New Class" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201806/extractor-new.png"/&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;AbstractSqlServerExtractor&lt;/code&gt;：新增抽象 SqlServer Extractor&lt;/li&gt;
&lt;li&gt;&lt;code&gt;AbstractMysqlExtractor&lt;/code&gt;：新增抽象 MySQL Extractor&lt;/li&gt;
&lt;li&gt;&lt;code&gt;AbstractFullRecordExtractor&lt;/code&gt;：新增抽象 Full 模式 Extractor&lt;/li&gt;
&lt;li&gt;&lt;code&gt;SqlServerCdcExtractor&lt;/code&gt;：新增 SQL Server CDC 增量模式 Extractor&lt;/li&gt;
&lt;li&gt;&lt;code&gt;MysqlCanalExtractor&lt;/code&gt;：新增 MySQL Canal 格式增量消费 Extractor&lt;/li&gt;
&lt;li&gt;&lt;code&gt;MysqlCanalRedisExtractor&lt;/code&gt;：新增 MySQL Canal 格式增量消费 Extractor，使用 Redis 做回溯&lt;/li&gt;
&lt;li&gt;&lt;code&gt;MysqlFullExtractor&lt;/code&gt;：新增 MySQL 全量 Extractor&lt;/li&gt;
&lt;li&gt;&lt;code&gt;SqlServerFullExtractor&lt;/code&gt;：新增 SQL Server 全量 Extractor&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在抽象出三个抽象类之后，整体逻辑更为清晰，如果未来要增加新数据库格式支持，也更为简单。&lt;/p&gt;
&lt;h3 id="translator_1"&gt;Translator&lt;/h3&gt;
&lt;p&gt;&lt;img alt="Translator New Class" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201806/translator-new.png"/&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Sha1ShardingTranslator&lt;/code&gt;：根据 Sha1 Sharding Translator&lt;/li&gt;
&lt;li&gt;&lt;code&gt;ModShardingTranslator&lt;/code&gt;：根据 Value Mode Sharding Translator&lt;/li&gt;
&lt;li&gt;&lt;code&gt;RangeShardingTranslator&lt;/code&gt;：根据范围 Sharding Translator&lt;/li&gt;
&lt;li&gt;&lt;code&gt;UserRouterMapShardingTranslator&lt;/code&gt;：特定业务使用， 用户分表 Sharding Translator&lt;/li&gt;
&lt;li&gt;&lt;code&gt;UserRouterMapMobileShardingTranslator&lt;/code&gt;：特定业务使用， 用户分表 Sharding Translator&lt;/li&gt;
&lt;li&gt;&lt;code&gt;ClassLearningNoteInfoShardingTranslator&lt;/code&gt;：特定业务使用自定义 Translator&lt;/li&gt;
&lt;li&gt;&lt;code&gt;ClassLearningIsActiveReverseShardingTranslator&lt;/code&gt;：特定业务使用自定义 Translator&lt;/li&gt;
&lt;li&gt;&lt;code&gt;ColumnFixDataTranslator&lt;/code&gt;：调整表结构 Translator&lt;/li&gt;
&lt;li&gt;&lt;code&gt;NameStyleDataTranslator&lt;/code&gt;：调整表字段名 Translator，支持按风格对整个表自动转换&lt;/li&gt;
&lt;li&gt;&lt;code&gt;CompositeIndexesDataTranslator&lt;/code&gt;：解决复合主键下唯一 PK 确定问题的 Translator&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;新增了一系列 Translator。&lt;/p&gt;
&lt;h3 id="applier_1"&gt;Applier&lt;/h3&gt;
&lt;p&gt;&lt;img alt="Applier New Class" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201806/applier-new.png"/&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;SqlServerIncreamentRecordApplier&lt;/code&gt;：新增 SQL Server 增量消费 Applier&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Applier 结构调整挺小，主要是增加了 SQL Server 的支持。&lt;/p&gt;
&lt;h2 id="er-ci-kai-fa-xin-de_1"&gt;二次开发心得&lt;/h2&gt;
&lt;p&gt;如何快速了解一个开源项目？很多同学第一反应就是阅读源码。
看源码固然是有效果，但是性价比太低。
如果项目设计不合理，很快会迷失在代码细节之中。
我的经验是先阅读官方出品的一些 Slide 分享，然后阅读官方核心文档。
Slide 含金量高，在讲述核心中核心。&lt;/p&gt;
&lt;p&gt;如果真要去了解细节去阅读源码，那我建议要善用工具，
比如使用 IntelliJ 的 Diagram 功能，抽象出核心类。
还有一些插件比如 SequencePluginReload 方便地生成函数之间调用，实为查看数据流利器。
我在这次开发过程中，也根据生成类图发现了一些问题，
从而在进入 Coding 之前，先对框架继承结构重构。提高了整体开发效率&lt;/p&gt;
&lt;p&gt;根据代码风格判断，Yugong 并非是出自一个人之手。这多少会导致代码风格和设计上面不一致。
我自己也常年在业务线里面摸爬滚打，能想象到在快速推进项目中需要糙快猛。
但后人接受开发，多少会有些头疼。
于是我在进入开发之前，引入标准化 CheckStyle，用 Google Style 全局格式化，
使用 Sonar 扫描保证一个代码质量基线。
同时这也是一把双刃剑，格式化项目会导致大量 diff，
这也给我自己埋下了一个苦果，在后期给上游提交 PR 引入无尽问题。&lt;/p&gt;
&lt;p&gt;开发过程中我也犯了一些错误。最为头疼是没有在早期考虑到向开源社区贡献，
导致未来向上游合并困难重重，现在还在头疼合并代码中。
另外，由于整体项目时间紧，我贪图实现速度，没有做更详尽单元测试覆盖。
这里没有遵循开源软件的最佳实践。&lt;/p&gt;
&lt;p&gt;经过我改造的 Yugong 版本开源地址是：https://github.com/alswl/yugong 。
我也提交了 Pull Request https://github.com/alibaba/yugong/pull/66 ，
正在与官方沟通如何将这部分提交并入上游。&lt;/p&gt;
&lt;hr&gt;
&lt;div class="panel"&gt;
&lt;div class="panel-body"&gt;
   &lt;small&gt;原文链接: &lt;a href="https://blog.alswl.com/2018/06/sql-server-migration-3/"&gt;https://blog.alswl.com/2018/06/sql-server-migration-3/&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;3a1ff193cee606bd1e2ea554a16353ee&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;欢迎关注我的微信公众号：&lt;a href="http://mp.weixin.qq.com/mp/getmasssendmsg?__biz=MzIyNTIwMTU3MQ==#wechat_webview_type=1&amp;wechat_redirect"&gt;窥豹&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/201605/qrcode_for_gh_17e2f9c2caa4_258.jpg"/&gt;&lt;/small&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/meta/wechat-pay-s-crop.png"/&gt;&lt;/small&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="SQLServer"></category><category term="MySQL"></category><category term="DB-Migration"></category></entry><entry><title>从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机</title><link href="https://blog.alswl.com/2018/05/sql-server-migration-2/" rel="alternate"></link><published>2018-05-21T11:24:36+08:00</published><updated>2018-05-21T11:24:36+08:00</updated><author><name>alswl</name></author><id>tag:blog.alswl.com,2018-05-21:2018/05/sql-server-migration-2/</id><summary type="html">&lt;p&gt;&lt;img alt="flying-tanker" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201805/flying-tanker.png"/&gt;&lt;/p&gt;
&lt;p&gt;&lt;smaill&gt;（image via https://pixabay.com/en/military-stealth-bomber-refueling-602729/ ）&lt;/smaill&gt;&lt;/p&gt;
&lt;p&gt;在上篇文章
&lt;a href="https://blog.alswl.com/2018/03/sql-server-migration-1/"&gt;从 SQL Server 到 MySQL （一）：异构数据库迁移 - Log4D&lt;/a&gt;
中，我们给大家介绍了从 SQL Server 到 MySQL 异构数据库迁移的基本问题和全量解决方案。
全量方案可以满足一部分场景的需求，但是这个方案仍然是有缺陷的：
迁移过程中需要停机，停机的时长和数据量相关。
对于核心业务来说，停机就意味着损失。
比如用户中心的服务，以它的数据量来使用全量方案，会导致迁移过程中停机若干个小时。
而一旦用户中心停止服务，几乎所有依赖于这个中央服务的系统都会停摆。&lt;/p&gt;
&lt;p&gt;能不能做到无缝的在线迁移呢？系统不需要或者只需要极短暂的停机？
作为有追求的技术人，我们一定要想办法解决上面的问题。&lt;/p&gt;

&lt;h2 id="zai-xian-qian-yi-de-yuan-li-he-liu-cheng"&gt;在线迁移的原理和流程&lt;/h2&gt;
&lt;p&gt;针对 Oracle 到 MySQL，市面上已经有比较成熟的解决方案 - alibaba 的
&lt;a href="https://github.com/alibaba/yugong"&gt;yugong&lt;/a&gt;
项目。
在解决 SQL Server 到 MySQL 在线迁移之前，我们先研究一下 yugong 是如何做到 Oracle
的在线迁移。&lt;/p&gt;
&lt;p&gt;下图是 yugong 针对 Oracle 到 MySQL 的增量迁移流程：&lt;/p&gt;
&lt;p&gt;&lt;img alt="yugong-oracle.png" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201805/yugong-oracle.png"/&gt;&lt;/p&gt;
&lt;p&gt;这其中有四个步骤：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;增量数据收集 (创建 Oracle 表的增量物化视图)&lt;/li&gt;
&lt;li&gt;进行全量复制&lt;/li&gt;
&lt;li&gt;进行增量复制 (可并行进行数据校验)&lt;/li&gt;
&lt;li&gt;原库停写，切到新库&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Oracle 物化视图（Materialized View）是 Oracle 提供的一个机制。
一个物化视图就是主库在某一个时间点上的复制，可以理解为是这个时间点上的 Snapshot。
当主库的数据持续更新时，物化视图的更新可以通过独立的批量更新完成，称之为 &lt;code&gt;refreshes&lt;/code&gt;。
一批 &lt;code&gt;refreshes&lt;/code&gt; 之间的变化，就对应到数据库的内容变化情况。
物化视图经常用来将主库的数据复制到从库，也常常在数据仓库用来缓存复杂查询。&lt;/p&gt;
&lt;p&gt;物化视图有多种配置方式，这里比较关心刷新方式和刷新时间。
刷新方式有三种：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Complete Refresh：删除所有数据记录重新生成物化视图&lt;/li&gt;
&lt;li&gt;Fast Refresh：增量刷新&lt;/li&gt;
&lt;li&gt;Force Refresh：根据条件判断使用 Complete Refresh 和 Fast Refres&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;刷新机制有两种模式： Refresh-on-commit 和 Refresh-On-Demand。&lt;/p&gt;
&lt;p&gt;Oracle 基于物化视图，就可以完成增量数据的获取，从而满足阿里的数据在线迁移。
将这个技术问题泛化一下，想做到在线增量迁移需要有哪些特性？
我们得到如下结论（针对源数据库）：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;增量变化：支持增量获得增量数据库变化&lt;/li&gt;
&lt;li&gt;延迟：获取变化数据这个动作耗时需要尽可能低&lt;/li&gt;
&lt;li&gt;幂等一致性：变化数据的消费应当做到幂等，即不管目标数据库已有数据什么状态，都可以无差别消费&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;回到我们面临的问题上来，SQL Server 是否有这个机制满足这三个特性呢？
答案是肯定的，SQL Server 官方提供了 CDC 功能。&lt;/p&gt;
&lt;h2 id="cdc-de-gong-zuo-yuan-li"&gt;CDC 的工作原理&lt;/h2&gt;
&lt;p&gt;什么是 CDC？
CDC 全称 Change Data Capture，设计目的就是用来解决增量数据的。
它是 SQL Server 2008 新增的特性，
在这之前只能使用 SQl Server 2005 中的 &lt;code&gt;after insert&lt;/code&gt; / &lt;code&gt;after delete&lt;/code&gt;
/ &lt;code&gt;after update&lt;/code&gt; Trigger 功能来获得数据变化。&lt;/p&gt;
&lt;p&gt;CDC 的工作原理如下：&lt;/p&gt;
&lt;p&gt;&lt;img alt="cdc-data-flow.png" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201805/cdc-data-flow.png"/&gt;&lt;/p&gt;
&lt;p&gt;当数据库表发生变化时候，Capture process 会从 transaction log 里面获取数据变化，
然后将这些数据记录到 Change Table 里面。
有了这些数据，用户可以通过特定的 CDC 查询函数将这些变化数据查出来。&lt;/p&gt;
&lt;h2 id="cdc-de-shu-ju-jie-gou-he-ji-ben-shi-yong"&gt;CDC 的数据结构和基本使用&lt;/h2&gt;
&lt;p&gt;CDC 的核心数据就是那些 Change Table 了，这里我们给大家看一下
Change Table 长什么样，可以有个直观的认识。&lt;/p&gt;
&lt;p&gt;通过以下的函数打开一张表（fruits）的 CDC 功能。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;-- enable cdc for db&lt;/span&gt;
&lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sp_cdc_enable_db&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="c1"&gt;-- enable by table&lt;/span&gt;
&lt;span class="k"&gt;EXEC&lt;/span&gt; &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sp_cdc_enable_table&lt;/span&gt; &lt;span class="o"&gt;@&lt;/span&gt;&lt;span class="n"&gt;source_schema&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;N&lt;/span&gt;&lt;span class="s1"&gt;'dbo'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;@&lt;/span&gt;&lt;span class="n"&gt;source_name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;N&lt;/span&gt;&lt;span class="s1"&gt;'fruits'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;@&lt;/span&gt;&lt;span class="n"&gt;role_name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;NULL&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="c1"&gt;-- list cdc enabled table&lt;/span&gt;
&lt;span class="k"&gt;SELECT&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;is_cdc_enabled&lt;/span&gt; &lt;span class="k"&gt;from&lt;/span&gt; &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;databases&lt;/span&gt; &lt;span class="k"&gt;where&lt;/span&gt; &lt;span class="n"&gt;is_cdc_enabled&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;至此 CDC 功能已经开启，如果需要查看哪些表开启了 CDC 功能，可以使用一下 SQL：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;-- list cdc enabled table&lt;/span&gt;
&lt;span class="k"&gt;SELECT&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;is_cdc_enabled&lt;/span&gt; &lt;span class="k"&gt;from&lt;/span&gt; &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;databases&lt;/span&gt; &lt;span class="k"&gt;where&lt;/span&gt; &lt;span class="n"&gt;is_cdc_enabled&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;开启 CDC 会导致产生一张 Change Table 表 &lt;code&gt;cdc.dbo_fruits_CT&lt;/code&gt;，这张表的表结构如何呢？&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="k"&gt;schema&lt;/span&gt; &lt;span class="n"&gt;cdc&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;dbo_fruits_CT&lt;/span&gt;
&lt;span class="n"&gt;name&lt;/span&gt;            &lt;span class="k"&gt;default&lt;/span&gt;  &lt;span class="k"&gt;nullable&lt;/span&gt;  &lt;span class="k"&gt;type&lt;/span&gt;          &lt;span class="k"&gt;length&lt;/span&gt;  &lt;span class="n"&gt;indexed&lt;/span&gt;
&lt;span class="c1"&gt;--------------  -------  --------  ------------  ------  -------&lt;/span&gt;
&lt;span class="n"&gt;__$end_lsn&lt;/span&gt;      &lt;span class="k"&gt;null&lt;/span&gt;     &lt;span class="n"&gt;YES&lt;/span&gt;       &lt;span class="nb"&gt;binary&lt;/span&gt;        &lt;span class="mi"&gt;10&lt;/span&gt;      &lt;span class="k"&gt;NO&lt;/span&gt;
&lt;span class="n"&gt;__$operation&lt;/span&gt;    &lt;span class="k"&gt;null&lt;/span&gt;     &lt;span class="k"&gt;NO&lt;/span&gt;        &lt;span class="nb"&gt;int&lt;/span&gt;           &lt;span class="mi"&gt;4&lt;/span&gt;       &lt;span class="k"&gt;NO&lt;/span&gt;
&lt;span class="n"&gt;__$seqval&lt;/span&gt;       &lt;span class="k"&gt;null&lt;/span&gt;     &lt;span class="k"&gt;NO&lt;/span&gt;        &lt;span class="nb"&gt;binary&lt;/span&gt;        &lt;span class="mi"&gt;10&lt;/span&gt;      &lt;span class="k"&gt;NO&lt;/span&gt;
&lt;span class="n"&gt;__$start_lsn&lt;/span&gt;    &lt;span class="k"&gt;null&lt;/span&gt;     &lt;span class="k"&gt;NO&lt;/span&gt;        &lt;span class="nb"&gt;binary&lt;/span&gt;        &lt;span class="mi"&gt;10&lt;/span&gt;      &lt;span class="n"&gt;YES&lt;/span&gt;
&lt;span class="n"&gt;__$update_mask&lt;/span&gt;  &lt;span class="k"&gt;null&lt;/span&gt;     &lt;span class="n"&gt;YES&lt;/span&gt;       &lt;span class="n"&gt;varbinary&lt;/span&gt;     &lt;span class="mi"&gt;128&lt;/span&gt;     &lt;span class="k"&gt;NO&lt;/span&gt;
&lt;span class="n"&gt;id&lt;/span&gt;              &lt;span class="k"&gt;null&lt;/span&gt;     &lt;span class="n"&gt;YES&lt;/span&gt;       &lt;span class="nb"&gt;int&lt;/span&gt;           &lt;span class="mi"&gt;4&lt;/span&gt;       &lt;span class="k"&gt;NO&lt;/span&gt;
&lt;span class="n"&gt;name&lt;/span&gt;            &lt;span class="k"&gt;null&lt;/span&gt;     &lt;span class="n"&gt;YES&lt;/span&gt;       &lt;span class="nb"&gt;varchar&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;255&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;  &lt;span class="mi"&gt;255&lt;/span&gt;     &lt;span class="k"&gt;NO&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这张表中以 &lt;code&gt;__&lt;/code&gt; 开头的字段是 CDC 所记录的元数据，&lt;code&gt;id&lt;/code&gt; 和 &lt;code&gt;name&lt;/code&gt; 是 fruits 表的原始字段。
这意味着 CDC 的表结构和原始表结构是一一对应的。&lt;/p&gt;
&lt;p&gt;接下来我们做一些业务操作，让数据库的数据发生一些变化，然后查看 CDC 的 Change Table：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;-- 1 step&lt;/span&gt;
&lt;span class="k"&gt;DECLARE&lt;/span&gt; &lt;span class="o"&gt;@&lt;/span&gt;&lt;span class="n"&gt;begin_time&lt;/span&gt; &lt;span class="n"&gt;datetime&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;@&lt;/span&gt;&lt;span class="n"&gt;end_time&lt;/span&gt; &lt;span class="n"&gt;datetime&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;@&lt;/span&gt;&lt;span class="n"&gt;begin_lsn&lt;/span&gt; &lt;span class="nb"&gt;binary&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="o"&gt;@&lt;/span&gt;&lt;span class="n"&gt;end_lsn&lt;/span&gt; &lt;span class="nb"&gt;binary&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="c1"&gt;-- 2 step&lt;/span&gt;
&lt;span class="k"&gt;SET&lt;/span&gt; &lt;span class="o"&gt;@&lt;/span&gt;&lt;span class="n"&gt;begin_time&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;'2017-09-11 14:03:00.000'&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;SET&lt;/span&gt; &lt;span class="o"&gt;@&lt;/span&gt;&lt;span class="n"&gt;end_time&lt;/span&gt;   &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;'2017-09-11 14:10:00.000'&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="c1"&gt;-- 3 step&lt;/span&gt;
&lt;span class="k"&gt;SELECT&lt;/span&gt; &lt;span class="o"&gt;@&lt;/span&gt;&lt;span class="n"&gt;begin_lsn&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fn_cdc_map_time_to_lsn&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'smallest greater than'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;@&lt;/span&gt;&lt;span class="n"&gt;begin_time&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="k"&gt;SELECT&lt;/span&gt; &lt;span class="o"&gt;@&lt;/span&gt;&lt;span class="n"&gt;end_lsn&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fn_cdc_map_time_to_lsn&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'largest less than or equal'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;@&lt;/span&gt;&lt;span class="n"&gt;end_time&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="c1"&gt;-- 4 step&lt;/span&gt;
&lt;span class="k"&gt;SELECT&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="k"&gt;FROM&lt;/span&gt; &lt;span class="n"&gt;cdc&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fn_cdc_get_all_changes_dbo_fruits&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;@&lt;/span&gt;&lt;span class="n"&gt;begin_lsn&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;@&lt;/span&gt;&lt;span class="n"&gt;end_lsn&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'all'&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这里的操作含义是：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;定义存储过程中需要使用的 4 个变量&lt;/li&gt;
&lt;li&gt;begin_time / end_time 是 Human Readable 的字符串格式时间&lt;/li&gt;
&lt;li&gt;begin_lsn / end_lsn 是通过 CDC 函数转化过的 Log Sequence Number，代表数据库变更的唯一操作 ID&lt;/li&gt;
&lt;li&gt;根据 begin_lsn / end_lsn 查询到 CDC 变化数据&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;查询出来的数据如下所示：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;__$start_lsn&lt;/span&gt;          &lt;span class="n"&gt;__$end_lsn&lt;/span&gt;  &lt;span class="n"&gt;__$seqval&lt;/span&gt;             &lt;span class="n"&gt;__$operation&lt;/span&gt;  &lt;span class="n"&gt;__$update_mask&lt;/span&gt;  &lt;span class="n"&gt;id&lt;/span&gt;  &lt;span class="n"&gt;name&lt;/span&gt;
&lt;span class="c1"&gt;--------------------  ----------  --------------------  ------------  --------------  --  ------&lt;/span&gt;
&lt;span class="mi"&gt;0000&lt;/span&gt;&lt;span class="n"&gt;dede0000019f001a&lt;/span&gt;  &lt;span class="k"&gt;null&lt;/span&gt;        &lt;span class="mi"&gt;0000&lt;/span&gt;&lt;span class="n"&gt;dede0000019f0018&lt;/span&gt;  &lt;span class="mi"&gt;2&lt;/span&gt;             &lt;span class="mi"&gt;03&lt;/span&gt;              &lt;span class="mi"&gt;1&lt;/span&gt;   &lt;span class="n"&gt;apple&lt;/span&gt;
&lt;span class="mi"&gt;0000&lt;/span&gt;&lt;span class="n"&gt;dede000001ad0004&lt;/span&gt;  &lt;span class="k"&gt;null&lt;/span&gt;        &lt;span class="mi"&gt;0000&lt;/span&gt;&lt;span class="n"&gt;dede000001ad0003&lt;/span&gt;  &lt;span class="mi"&gt;2&lt;/span&gt;             &lt;span class="mi"&gt;03&lt;/span&gt;              &lt;span class="mi"&gt;2&lt;/span&gt;   &lt;span class="n"&gt;apple2&lt;/span&gt;
&lt;span class="mi"&gt;0000&lt;/span&gt;&lt;span class="n"&gt;dede000001ba0003&lt;/span&gt;  &lt;span class="k"&gt;null&lt;/span&gt;        &lt;span class="mi"&gt;0000&lt;/span&gt;&lt;span class="n"&gt;dede000001ba0002&lt;/span&gt;  &lt;span class="mi"&gt;3&lt;/span&gt;             &lt;span class="mi"&gt;02&lt;/span&gt;              &lt;span class="mi"&gt;2&lt;/span&gt;   &lt;span class="n"&gt;apple2&lt;/span&gt;
&lt;span class="mi"&gt;0000&lt;/span&gt;&lt;span class="n"&gt;dede000001ba0003&lt;/span&gt;  &lt;span class="k"&gt;null&lt;/span&gt;        &lt;span class="mi"&gt;0000&lt;/span&gt;&lt;span class="n"&gt;dede000001ba0002&lt;/span&gt;  &lt;span class="mi"&gt;4&lt;/span&gt;             &lt;span class="mi"&gt;02&lt;/span&gt;              &lt;span class="mi"&gt;2&lt;/span&gt;   &lt;span class="n"&gt;apple3&lt;/span&gt;
&lt;span class="mi"&gt;0000&lt;/span&gt;&lt;span class="n"&gt;dede000001c10003&lt;/span&gt;  &lt;span class="k"&gt;null&lt;/span&gt;        &lt;span class="mi"&gt;0000&lt;/span&gt;&lt;span class="n"&gt;dede000001c10002&lt;/span&gt;  &lt;span class="mi"&gt;2&lt;/span&gt;             &lt;span class="mi"&gt;03&lt;/span&gt;              &lt;span class="mi"&gt;3&lt;/span&gt;   &lt;span class="n"&gt;apple4&lt;/span&gt;
&lt;span class="mi"&gt;0000&lt;/span&gt;&lt;span class="n"&gt;dede000001cc0005&lt;/span&gt;  &lt;span class="k"&gt;null&lt;/span&gt;        &lt;span class="mi"&gt;0000&lt;/span&gt;&lt;span class="n"&gt;dede000001cc0002&lt;/span&gt;  &lt;span class="mi"&gt;1&lt;/span&gt;             &lt;span class="mi"&gt;03&lt;/span&gt;              &lt;span class="mi"&gt;3&lt;/span&gt;   &lt;span class="n"&gt;apple4&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;可以看到 Change Table 已经如实的记录了我们操作内容，注意 &lt;code&gt;__$operation&lt;/code&gt;
代表了数据库操作：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1  =&amp;gt; 删除&lt;/li&gt;
&lt;li&gt;2  =&amp;gt; 插入&lt;/li&gt;
&lt;li&gt;3  =&amp;gt; 更新前数据&lt;/li&gt;
&lt;li&gt;4  =&amp;gt; 更新后数据&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;根据查出来的数据，我们可以重现这段时间数据库的操作：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;新增了 &lt;code&gt;id&lt;/code&gt; 为 1 / 2 的两条数据&lt;/li&gt;
&lt;li&gt;更新了 &lt;code&gt;id&lt;/code&gt; 为 2 的数据&lt;/li&gt;
&lt;li&gt;插入了 &lt;code&gt;id&lt;/code&gt; 为 3 的数据&lt;/li&gt;
&lt;li&gt;删除了 &lt;code&gt;id&lt;/code&gt; 为 3 的数据&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="cdc-diao-you"&gt;CDC 调优&lt;/h2&gt;
&lt;p&gt;有了 CDC 这个利器，终于意味着我们的方向是没有问题的，我们终于稍稍吁了一口气。
但除了了解原理和使用方式，我们还需要深入了解 CDC 的工作机制，对其进行压测、调优，
了解其极限和边界，否则一旦线上出现不可控的情况，就会对业务带来巨大损失。&lt;/p&gt;
&lt;p&gt;我们先看看 CDC 的工作流程，就可以知道有哪些核心参数可以调整：&lt;/p&gt;
&lt;p&gt;&lt;img alt="Influence of capture job parameters" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201805/cdc-influence.png"/&gt;&lt;/p&gt;
&lt;p&gt;上图是 CDC Job 的工作流程：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;蓝色区域是一次 Log 扫描执行的最大扫描次数：maxscans number（&lt;code&gt;maxscans&lt;/code&gt;）&lt;/li&gt;
&lt;li&gt;蓝色区域同时被最大扫描 transcation 数量控制：&lt;code&gt;maxtrans&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;浅蓝色区域是扫描间隔时间，单位是秒：&lt;code&gt;pollinginterval&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这三个参数平衡着 CDC 的服务器资源消耗、吞吐量和延迟，
根据具体场景，比如大字段，宽表，BLOB 表，可以调整从而达到满足业务需要。
他们的默认值如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;maxscan&lt;/code&gt; 默认值 10&lt;/li&gt;
&lt;li&gt;&lt;code&gt;maxtrans&lt;/code&gt; 默认值 500&lt;/li&gt;
&lt;li&gt;&lt;code&gt;pollinginterval&lt;/code&gt; 默认值 5 秒&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="cdc-ya-ce"&gt;CDC 压测&lt;/h2&gt;
&lt;p&gt;掌握了能够调整的核心参数，我们即将对 CDC 进行了多种形式的测试。
在压测之前，我们还需要确定关键的健康指标，这些指标有：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;内存：buffer-cache-hit / page-life-expectancy / page-split 等&lt;/li&gt;
&lt;li&gt;吞吐：batch-requets / sql-compilations / sql-re-compilations / transactions count&lt;/li&gt;
&lt;li&gt;资源消耗：user-connections / processes-blocked / lock-waits / checkpoint-pages&lt;/li&gt;
&lt;li&gt;操作系统层面：CPU 利用率、磁盘 IO&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;出于篇幅考虑，我们无法将所有测试结果贴出来，
这里放一个在并发 30 下面插入一百万数据（随机数据）进行展示：&lt;/p&gt;
&lt;p&gt;&lt;img alt="cdc-metrics.png" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201805/cdc-metrics.png"/&gt;&lt;/p&gt;
&lt;p&gt;&lt;img alt="cdc-system-load.png" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201805/cdc-system-load.png"/&gt;&lt;/p&gt;
&lt;p&gt;测试结论是，在默认的 CDC 参数下面：&lt;/p&gt;
&lt;p&gt;CDC 的开启/关闭过程中会导致若干个 Process Block，
大流量请求下面（15k TPS）过程会导致约 20 个左右 Process Block。
这个过程中对服务器的 IO / CPU 无明显波动，
开启/关闭瞬间会带来 mssql.sql-statistics.sql-compilations 剧烈波动。
CDC 开启后，在大流量请求下面对 QPS / Page IO 无明显波动，
对服务器的 IO / CPU 也无明显波动， CDC 开启后可以在 16k TPS 下正常工作。&lt;/p&gt;
&lt;p&gt;如果对性能不达标，官方有一些简单的优化指南：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;调整 maxscan maxtrans pollinginterval&lt;/li&gt;
&lt;li&gt;减少在插入后立刻插入&lt;/li&gt;
&lt;li&gt;避免大批量写操作&lt;/li&gt;
&lt;li&gt;限制需要记录的字段&lt;/li&gt;
&lt;li&gt;尽可能关闭 net changes&lt;/li&gt;
&lt;li&gt;没任务压力时跑 cleanup&lt;/li&gt;
&lt;li&gt;监控 log file 大小和 IO 压力，确保不会写爆磁盘&lt;/li&gt;
&lt;li&gt;要设置 filegroup_name&lt;/li&gt;
&lt;li&gt;开启 sp_cdc_enable_table 之前设置 filegroup&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="yugong-de-zai-xian-qian-yi-ji-zhi"&gt;yugong 的在线迁移机制&lt;/h2&gt;
&lt;p&gt;OK，截目前位置，我们已经具备了 CDC 这个工具，但是这仅仅提供了一种可能性，
我们还需要一个工具将 CDC 的数据消费出来，并喂到 MySQL 里面去。&lt;/p&gt;
&lt;p&gt;好在有 yugong。
Yugong 官方提供了 Oracle 到 MySQL 的封装，并且抽象了 Source / Target /
SQL Tempalte 等接口，
我们只要实现相关接口，就可以完成从 SQL Server 消费数据到 MySQL 了。&lt;/p&gt;
&lt;p&gt;这里我们不展开，我还会花专门的一篇文章讲如何在 yugong 上面进行开发。
可以提前剧透一下，我们已经将支持 SQL Server 的 yugong 版本开源了。&lt;/p&gt;
&lt;h2 id="ru-he-hui-gun"&gt;如何回滚&lt;/h2&gt;
&lt;p&gt;数据库迁移这样的项目，我们不仅仅要保证单向从 SQL Server 到 MySQL 的写入，
同时要从 MySQL 写入 SQL Server。&lt;/p&gt;
&lt;p&gt;这个流程同样考虑增量写入的要素：增量消费，延迟，幂等一致性。&lt;/p&gt;
&lt;p&gt;MySQL 的 binlog 可以满足这三个要素，需要注意的是，MySQL binlog 有三种模式，
Statement based，Row based 和 Mixed。只有 Row based 才能满足幂等一致性的要求。&lt;/p&gt;
&lt;p&gt;确认理论上可行之后，我们一样需要一个工具将 binlog 读取出来，并且将其转化为
SQL Server 可以消费的数据格式，然后写入 SQL Server。&lt;/p&gt;
&lt;p&gt;我们目光转到 alibaba 的另外一个项目 Canal。
Canal 是阿里中间件团队提供的 binlog 增量订阅 &amp;amp; 消费组件。
之所以叫组件，是由于 Canal 提供了 Canal-Server 应用和 Canal Client Library，
Canal 会模拟成一个 MySQL 实例，作为 Slave 连接到 Master 上面，
然后实时将 binlog 读取出来。
至于 binlog 读出之后想怎么使用，权看用户如何使用。&lt;/p&gt;
&lt;p&gt;我们基于 Canal 设计了一个简单的数据流，在 yugong 中增加了这么几个功能：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;SQL Server 的写入功能&lt;/li&gt;
&lt;li&gt;消费 Canal 数据源的功能&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Canal Server 中的 binlog 只能做一次性消费，
内部实现是一个 Queue，
为了满足我们可以重复消费数据的能力，我们还额外设计了一个环节，将 Canal
的数据放到 Queue 中，在未来任意时间可以重复消费数据。
我们选择了 Redis 作为这个 Queue，数据流如下。&lt;/p&gt;
&lt;p&gt;&lt;img alt="canal.png" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201805/canal.png"/&gt;&lt;/p&gt;
&lt;h2 id="zui-jia-shi-jian"&gt;最佳实践&lt;/h2&gt;
&lt;p&gt;数据库的迁移在去 Windows 中，是最不容得出错的环节。
应用是无状态的，出现问题可以通过回切较快地回滚。
但数据库的迁移就需要考虑周到，做好资源准备，发布流程，
故障预案处理。&lt;/p&gt;
&lt;p&gt;考虑到多个事业部都需要经历这个一个过程，我们项目组将每一个步骤都固化下来，
形成了一个最佳实践。我们的迁移步骤如下，供大家参考：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;大阶段&lt;/th&gt;
&lt;th&gt;阶段&lt;/th&gt;
&lt;th&gt;事项&lt;/th&gt;
&lt;th&gt;是否完成&lt;/th&gt;
&lt;th&gt;负责人&lt;/th&gt;
&lt;th&gt;耗时&lt;/th&gt;
&lt;th&gt;开始时间&lt;/th&gt;
&lt;th&gt;完成时间&lt;/th&gt;
&lt;th&gt;备注&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;白天&lt;/td&gt;
&lt;td&gt;存量数据阶段&lt;/td&gt;
&lt;td&gt;创建 MySQL 数据库，准备相关账号资源&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;DBA&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;开启 CDC&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;DBA&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;从 Slave SQLServer dump 一份 snapshot 到 Backup SQL Server&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;DBA&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Backup SQL Server 消费数据， ETL 到 MySQL&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;DBA&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;增量数据阶段&lt;/td&gt;
&lt;td&gt;确认 ETL 数据已经消费完成，检查数据总条数&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;DBA&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;从 Slave SQLServer 开始消费 CDC 数据，持续写入 MySQL&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;DBA&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;使用 yugong 检查一天内数据的一致性&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;DBA&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;检查不一致的数据，10 分钟之后人工进行检查，确认是 CDC 延迟带来的问题&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;DBA&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;检查数据总量条目&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;DBA&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;使用 yugong 对抽样表进行全量检查&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;DBA&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;凌晨&lt;/td&gt;
&lt;td&gt;应用发布阶段&lt;/td&gt;
&lt;td&gt;停止 SQL Server 的应用&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;技术经理&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;检查没有连接进入 SQL Server&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;DBA&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;使用 yugong 检查一天内数据的一致性&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;DBA&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;检查数据总量条目&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;DBA&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;启用基于 MySQL 的应用&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;运维&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;测试阶段&lt;/td&gt;
&lt;td&gt;测试应用是否正常，回归所有功能&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;QA&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;（临时新增）测试 ReadOnly DB 的应用访问情况&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;QA&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;完成阶段&lt;/td&gt;
&lt;td&gt;接入流量&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;运维&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;（可选）回滚阶段&lt;/td&gt;
&lt;td&gt;发现问题，直接将应用切回 SQL Server&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;运维&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;事后进行数据审计，进行新增数据补偿&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;DBA&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;（可选）回滚过程中，使用 Canal 读取 binlog，并使用 Canal Client 重放到 SQL Server&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;DBA&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h2 id="reference"&gt;Reference&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://docs.oracle.com/cd/B10500_01/server.920/a96567/repmview.htm"&gt;Materialized View Concepts and Architecture&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://docs.microsoft.com/en-us/previous-versions/sql/sql-server-2008/dd266396(v=sql.100)"&gt;Tuning the Performance of Change Data Capture in SQL Server 2008 | Microsoft Docs&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/alibaba/yugong"&gt;alibaba/yugong: 阿里巴巴去Oracle数据迁移同步工具(全量+增量,目标支持MySQL/DRDS)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/alibaba/canal"&gt;alibaba/canal: 阿里巴巴mysql数据库binlog的增量订阅&amp;amp;消费组件 。阿里云DRDS( https://www.aliyun.com/product/drds )、阿里巴巴TDDL 二级索引、小表复制powerd by canal.&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;div class="panel"&gt;
&lt;div class="panel-body"&gt;
   &lt;small&gt;原文链接: &lt;a href="https://blog.alswl.com/2018/05/sql-server-migration-2/"&gt;https://blog.alswl.com/2018/05/sql-server-migration-2/&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;3a1ff193cee606bd1e2ea554a16353ee&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;欢迎关注我的微信公众号：&lt;a href="http://mp.weixin.qq.com/mp/getmasssendmsg?__biz=MzIyNTIwMTU3MQ==#wechat_webview_type=1&amp;wechat_redirect"&gt;窥豹&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/201605/qrcode_for_gh_17e2f9c2caa4_258.jpg"/&gt;&lt;/small&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/meta/wechat-pay-s-crop.png"/&gt;&lt;/small&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="SQLServer"></category><category term="MySQL"></category><category term="DB-Migration"></category></entry><entry><title>如何逃离死海效应</title><link href="https://blog.alswl.com/2018/04/death-sea-effect/" rel="alternate"></link><published>2018-04-09T23:13:03+08:00</published><updated>2018-04-09T23:13:03+08:00</updated><author><name>alswl</name></author><id>tag:blog.alswl.com,2018-04-09:2018/04/death-sea-effect/</id><summary type="html">&lt;p&gt;&lt;img alt="201804/death-sea.jpg" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201804/death-sea.jpg"/&gt;&lt;/p&gt;
&lt;p&gt;（图片来自 &lt;a href="https://www.flickr.com/photos/tsaiproject/8298557641"&gt;The Dead Sea, Israel | One of the lowest, saltiest and unusu&amp;hellip; | Flickr&lt;/a&gt;）&lt;/p&gt;
&lt;p&gt;最近听团队老大的一个分享，介绍公司提倡的工程师的核心价值观，受益良多。
这也让我想起了一篇文章，
Bruce F. Webster 在 2008 年写了一篇文章「The Wetware Crisis: the Dead Sea effect」，
翻译过来是「死海效应」。&lt;/p&gt;

&lt;p&gt;Bruce 在文章中阐述了一个概念：一个团队可能陷入一种反模式，称之为死海效应。
死海是位于约旦的一个高盐分水域，由于水分被蒸发，这里的盐度是正常海水的 8 倍。
将水分比喻为高质量人才，盐分比喻为低质量人才。
水分容易被蒸发，而补入不足，盐分不容易蒸发日积月累，进而导致整个团队的人才质量劣化。&lt;/p&gt;
&lt;p&gt;借用经济学里面的一个概念：劣币驱逐良币。&lt;/p&gt;
&lt;h2 id="xing-cheng"&gt;形成&lt;/h2&gt;
&lt;p&gt;为什么会形成这样的状况呢？&lt;/p&gt;
&lt;p&gt;在一个正常运作的团队中，整个人才系统应该是循环的。有新的成员加入，也有老的成员离开。
只要市场上人才质量不发生剧烈的波动，团队内人才质量应该是平稳的。
但死海效应中不这样，好的人才不断流失，低质量人才被留存，这个团队素质越来越差。
形成这种状况的原因其实挺简单：环境恶化，高质量人才有更强的实力，可以自由地选择满足自己期望的团队。
而低质量人才没有更多选择空间，从而只能在当前的环境下继续生存。&lt;/p&gt;
&lt;p&gt;死海效应导致的恶劣后果是显而易见的。
现代组织中人是生产第一要素。
如果人才质量持续降低，那么整个团队会缺乏战斗力，商业上得不到发展，这个团队将面临瓦解的风险。&lt;/p&gt;
&lt;p&gt;什么样的团队容易滋生死海效应，我总结了几个点：无压、不透明、人情。&lt;/p&gt;
&lt;p&gt;第一个点是无压，当一个公司的业务发展进入瓶颈期，战略上面没有远见，
抑或是已经占据了市场中的有利地形，温饱不愁，那么就容易失去压力。
我对商业的理解有限，就拿技术团队来做比喻：
当一个技术团队给业务提供的支撑足够并且业务发展平稳，
那么技术团队有两个选择：维持平稳的状态；给自己提出更高的技术要求。
前者是舒适的，后者长期带来回报，但是短期辛苦并且有风险。
前者的团队空间有限，挑战难度低，更容易产生死海效应。&lt;/p&gt;
&lt;p&gt;第二个滋生死海效应的点是不透明。这种不透明体现在多个方面：
战略上是否向全体员工透明？业绩结果是否向全体员工透明？团队和个人绩效结果是否透明？评价标准是否透明？
不透明会会导致团队的不公平。
一线员工看不到未来发展的方向和业绩，无法感受到个体被组织所尊重。
也许有些人尸位素餐，却能获得高收益，自然无法让团队的高贡献者认可。
Google 有一系列方法，包括 OKR 透明化，TGIF（Thank God It&amp;rsquo;s Friday） 全体沟通会，有效的解决这个问题。&lt;/p&gt;
&lt;p&gt;第三个点是人情。大家在一起工作，时间一长或多或少会产生羁绊。
中国社会又特别讲究人情来往，今天你帮我一些忙，那我就得记在心上，未来有机会要还给你。
这当然是一种人和人之间沟通的一种黏合剂和缓冲，但是也是职业化程度低的表现。
企业的存在是有使命和目的，营造一种大家庭的氛围一定不在其使命中。
小团队早期可以家族化管理，但是一旦走上正轨，一定要规范化管理。
人情其实是对标准和制度的破坏，而企业的正常运转，恰恰最是需要对标准和制度的遵守。
讲究人情，也会对职责和评价产生破坏，这又会导致不公平，死海效应也会应运而生。
这点我是非常佩服阿里，它有一个出名的职务轮换制度，管理层不能长期担任同一职位，需要定期轮换。
这样就能保证关键人才在企业内部是流动的，不会锁定在特定岗位。
也就避免了长期锁定带来的人情账户、内部小团体。&lt;/p&gt;
&lt;h2 id="ru-he-tao-chi"&gt;如何逃离&lt;/h2&gt;
&lt;p&gt;那么如何来解决「死海效应」呢？有这么些方法：追求卓越、制度和透明、人才标准和流动。&lt;/p&gt;
&lt;p&gt;我以前和一个候选人沟通，他的一句话让我印象深刻：公司业务高速发展时，就不会存在复杂的管理问题。
这是一种理想情况。
但业务发展需要时间，进入瓶颈期之后，想继续保持团队活力，改怎么办？追求卓越。
效率能否再提高一些？自动化的程度是否能够再提高？能不能向一流团队 FLAG 看齐？
这样就开阔了团队和个人的发展空间。
一旦有了追求卓越的信念，即便业务发展稍缓，仍然能够抵御死海效应。&lt;/p&gt;
&lt;p&gt;高质量人才离开往往是觉得受了委屈才离开，那么公平的制度和透明的实施就尤其重要。
保证不由某个个体的意志力转移，而是像机器一样可以运转，像数学一样可以被计算。
这个需要自上而下的贯彻，否则实施起来非常困难。
举一个例子，如果团队大部分成员会在月末调整绩效目标而获得更高的评分。
那么坚持不调整的人可能获得较低评分，这不是个体能够影响的局面。
没有自上而下的推动，制度和透明就只能是一阵清风。&lt;/p&gt;
&lt;p&gt;最后是人才标准和流动。人才流动并非是一个坏事，如同人的生理循环，吸收有益物质，排除有害物质。
这个循环必须正向运行，设定合理的准入标准和淘汰标准，高质量输入，低质量淘汰。
末尾淘汰制听起来残酷，其实在广泛实施，比如阿里的 3.25 的考核，腾讯的年末淘汰一人。
对于大部分非家族公司来说，如果真的出现害群之马，难道不淘汰么？
淘汰应该制度化，让所有人看到并且重视，而不是担心会造成集体不安就隐性操作，
这反而更容易产生猜测和担忧。&lt;/p&gt;
&lt;h2 id="zui-hou"&gt;最后&lt;/h2&gt;
&lt;p&gt;一旦进入死海效应的恶性循环，我认为乱世用重典为佳，小打小闹不能形成大影响。
关键时刻就必须搞运动，做动员，大张旗鼓。
当然这需要高层有足够的决心和意志力。如果管理层计划偏安一隅，没有宏伟愿景，
那么十几年的企业寿命也能为股东赚回足够的钱，死海效应是存在即合理的现象。
低质量的人才管理成本也低，人才死海效应和业务劣化恶性循环，
最后进入企业衰老期，天道轮回，有生必有死，看开就好。&lt;/p&gt;
&lt;hr&gt;
&lt;div class="panel"&gt;
&lt;div class="panel-body"&gt;
   &lt;small&gt;原文链接: &lt;a href="https://blog.alswl.com/2018/04/death-sea-effect/"&gt;https://blog.alswl.com/2018/04/death-sea-effect/&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;3a1ff193cee606bd1e2ea554a16353ee&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;欢迎关注我的微信公众号：&lt;a href="http://mp.weixin.qq.com/mp/getmasssendmsg?__biz=MzIyNTIwMTU3MQ==#wechat_webview_type=1&amp;wechat_redirect"&gt;窥豹&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/201605/qrcode_for_gh_17e2f9c2caa4_258.jpg"/&gt;&lt;/small&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/meta/wechat-pay-s-crop.png"/&gt;&lt;/small&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="management"></category><category term="team"></category></entry><entry><title>从 SQL Server 到 MySQL（一）：异构数据库迁移</title><link href="https://blog.alswl.com/2018/03/sql-server-migration-1/" rel="alternate"></link><published>2018-03-12T21:08:56+08:00</published><updated>2018-03-12T21:08:56+08:00</updated><author><name>alswl</name></author><id>tag:blog.alswl.com,2018-03-12:2018/03/sql-server-migration-1/</id><summary type="html">&lt;p&gt;&lt;img alt="201803/migration-bird.png" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201803/migration-bird.png"/&gt;&lt;/p&gt;
&lt;h2 id="bei-jing"&gt;背景&lt;/h2&gt;
&lt;p&gt;沪江成立于 2001 年，作为较早期的教育学习网站，
当时技术选型范围并不大：
Java 的版本是 1.2，C# 尚未诞生，MySQL 还没有被 Sun 收购，
版本号是 3.23。
工程师们选择了当时最合适的微软体系，并在日后的岁月里，
逐步从 ASP 过度到 .net，数据库也跟随 SQL Server 进行版本升级。&lt;/p&gt;
&lt;p&gt;十几年过去了，技术社区已经发生了天翻地覆的变化。
沪江的技术栈还基本在 .net 体系上，这给业务持续发展带来了一些限制。
人才招聘、社区生态、架构优化、成本风险方面都面临挑战。
集团经过慎重考虑，发起了大规模的去 Windows 化项目。
这其中包含两个重点子项目：开发语言从 C# 迁移到 Java，
数据库从 SQL Server 迁移到 MySQL。&lt;/p&gt;
&lt;p&gt;本系列文章就是向大家介绍，
从 SQL Server 迁移到 MySQL 所面临的问题和我们的解决方案。&lt;/p&gt;

&lt;h2 id="qian-yi-fang-an-de-ji-ben-liu-cheng"&gt;迁移方案的基本流程&lt;/h2&gt;
&lt;p&gt;设计迁移方案需要考量以下几个指标：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;迁移前后的数据一致性&lt;/li&gt;
&lt;li&gt;业务停机时间&lt;/li&gt;
&lt;li&gt;迁移项目是否对业务代码有侵入&lt;/li&gt;
&lt;li&gt;需要提供额外的功能：表结构重构、字段调整&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;经过仔细调研，在平衡复杂性和业务方需求后，
迁移方案设计为两种：停机数据迁移和在线数据迁移。
如果业务场景允许数小时的停机，那么使用停机迁移方案，
复杂度低，数据损失风险低。
如果业务场景不允许长时间停机，或者迁移数据量过大，
无法在几个小时内迁移完成，那么就需要使用在线迁移方案了。&lt;/p&gt;
&lt;p&gt;数据库停机迁移的流程：&lt;/p&gt;
&lt;p&gt;&lt;img alt="201803/migration-db-offline-readonly.png" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201803/migration-db-offline-readonly.png"/&gt;&lt;/p&gt;
&lt;p&gt;停机迁移逻辑比较简单，使用 ETL（Extract Translate Load）
工具从 Source 写入 Target，然后进行一致性校验，最后确认应用运行 OK，
将 Source 表名改掉进行备份。&lt;/p&gt;
&lt;p&gt;在线迁移的流程：&lt;/p&gt;
&lt;p&gt;&lt;img alt="201803/migration-db-online.png" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201803/migration-db-online.png"/&gt;&lt;/p&gt;
&lt;p&gt;在线迁移的方案稍微复杂一些，流程上有准备全量数据，然后实时同步增量数据，
在数据同步跟上（延迟秒级别）之后，进行短暂停机（Hang 住，确保没有流量），
就可以使用新的应用配置，并使用新的数据库。&lt;/p&gt;
&lt;h2 id="xu-yao-jie-jue-de-wen-ti"&gt;需要解决的问题&lt;/h2&gt;
&lt;p&gt;从 SQL Server 迁移到 MySQL，核心是完成异构数据库的迁移。&lt;/p&gt;
&lt;p&gt;基于两种数据迁移方案，我们需要解决以下问题：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;两个数据库的数据结构是否可以一一对应？出现不一致如何处理？&lt;/li&gt;
&lt;li&gt;MySQL 的使用方式和 SQL Server 使用方式是否一致？有哪些地方需要注意？&lt;/li&gt;
&lt;li&gt;如何确保迁移前后的数据一致性？&lt;/li&gt;
&lt;li&gt;在迁移中，如何支持数据结构调整？&lt;/li&gt;
&lt;li&gt;如何保证业务不停情况下面，实现在线迁移？&lt;/li&gt;
&lt;li&gt;数据迁移后如果发现业务异常需要回滚，如何处理新产生的数据？&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;为了解决以上的问题，我们需要引入一整套解决方案，包含以下部分：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;指导文档 A：SQL Server 转换 MySQL 的数据类型对应表&lt;/li&gt;
&lt;li&gt;指导文档 B：MySQL 的使用方式以及注意点&lt;/li&gt;
&lt;li&gt;支持表结构变更，从 SQL Server 到 MySQL 的 ETL 工具&lt;/li&gt;
&lt;li&gt;支持 SQL Server 到 MySQL 的在线 ETL 工具&lt;/li&gt;
&lt;li&gt;一致性校验工具&lt;/li&gt;
&lt;li&gt;一个回滚工具&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;让我们一一来解决这些问题。&lt;/p&gt;
&lt;h2 id="sql-server-dao-mysql-zhi-dao-wen-dang"&gt;SQL Server 到 MySQL 指导文档&lt;/h2&gt;
&lt;p&gt;非常幸运的是，MySQL 官方早就准备了一份如何其他数据库迁移到
MySQL 的白皮书。
&lt;a href="https://www.mysql.com/it/why-mysql/white-papers/guide-to-migrating-from-sql-server-to-mysql/"&gt;MySQL :: Guide to Migrating from Microsoft SQL Server to MySQL&lt;/a&gt;
里提供了详尽的 SQL Server 到 MySQL 的对应方案。
包含了：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;SQL Server to MySQL - Datatypes 数据类型对应表&lt;/li&gt;
&lt;li&gt;SQL Server to MySQL - Predicates 逻辑算子对应表&lt;/li&gt;
&lt;li&gt;SQL Server to MySQL &amp;ndash; Operators and Date Functions 函数对应表&lt;/li&gt;
&lt;li&gt;T-SQL Conversion Suggestions 存储过程转换建议&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;需要额外处理的数据类型：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;SQL Server&lt;/th&gt;
&lt;th&gt;MySQL&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;IDENTITY&lt;/td&gt;
&lt;td&gt;AUTO_INCREMENT&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;NTEXT, NATIONAL TEXT&lt;/td&gt;
&lt;td&gt;TEXT CHARACTER SET UTF8&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;SMALLDATETIME&lt;/td&gt;
&lt;td&gt;DATETIME&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;MONEY&lt;/td&gt;
&lt;td&gt;DECIMAL(19,4)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;SMALL MONEY&lt;/td&gt;
&lt;td&gt;DECIMAL(10,4)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;UNIQUEIDENTIFIER&lt;/td&gt;
&lt;td&gt;BINARY(16)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;SYSNAME&lt;/td&gt;
&lt;td&gt;CHAR(256)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;在实际进行中，还额外遇到了一个用来解决树形结构存储的字段类型
Hierarchyid。这个场景需要额外进行业务调整。&lt;/p&gt;
&lt;p&gt;我们在内部做了针对 MySQL 知识的摸底排查工作，
并进行了若干次的 MySQL 使用技巧培训，
将工程师对 MySQL 的认知拉到一根统一的线。&lt;/p&gt;
&lt;p&gt;关于存储过程使用，我们和业务方也达成了一致：所有 SQL Server
存储过程使用业务代码进行重构，不能在 MySQL 中使用存储过程。
原因是存储过程增加了业务和 DB 的耦合，会让维护成本变得极高。
另外 MySQL 的存储过程功能和性能都较弱，无法大规模使用。&lt;/p&gt;
&lt;p&gt;最后我们提供了一个 MySQL 开发规范文档，借数据库迁移的机会，
将之前相对混乱的表结构设计做了统一了约束（部分有业务绑定的设计，
在考虑成本之后没有做调整）。&lt;/p&gt;
&lt;h2 id="etl-gong-ju"&gt;ETL 工具&lt;/h2&gt;
&lt;p&gt;ETL 的全称是 Extract Translate Load（读取、转换、载入），
数据库迁移最核心过程就是 ETL 过程。
如果将 ETL 过程简化，去掉 Translate 过程，
就退化为一个简单的数据导入导出工具。
我们可以先看一下市面上常见的导入导出工具，
了解他们的原理和特性，方便我们选型。&lt;/p&gt;
&lt;p&gt;MySQL 同构数据库数据迁移工具：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://dev.mysql.com/doc/refman/5.7/en/mysqldump.html"&gt;mysqldump&lt;/a&gt;
    和 &lt;a href="https://dev.mysql.com/doc/refman/5.7/en/mysqlimport.html"&gt;mysqlimport&lt;/a&gt;
    MySQL 官方提供的 SQL 导出导出工具&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.percona.com/doc/percona-toolkit/LATEST/pt-table-sync.html"&gt;pt-table-sync&lt;/a&gt;
    Percona 提供的主从同步工具&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.percona.com/software/mysql-database/percona-xtrabackup"&gt;XtraBackup&lt;/a&gt;
    Percona 提供的备份工具&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;异构数据库迁移工具：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://www.convert-in.com/"&gt;Database migration and synchronization tools&lt;/a&gt;
    ：国外一家提供数据库迁移解决方案的公司&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/alibaba/DataX"&gt;DataX&lt;/a&gt;
    ：阿里巴巴开发的数据库同步工具&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/alibaba/yugong"&gt;yugong&lt;/a&gt;
    ：阿里巴巴开发的数据库迁移工具&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.mysql.com/cn/products/workbench/"&gt;MySQL Workbench&lt;/a&gt;
    ：MySQL 提供的 GUI 管理工具，包含数据库迁移功能&lt;/li&gt;
&lt;li&gt;&lt;a href="https://community.hds.com/docs/DOC-1009855"&gt;Data Integration - Kettle&lt;/a&gt;
    ：国外的一款 GUI ETL 工具&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.ispirer.cn/products/sql-server-to-mysql-migration"&gt;Ispirer&lt;/a&gt;
    ：提供应用程序、数据库异构迁移方案的公司&lt;/li&gt;
&lt;li&gt;&lt;a href="http://www.szmesoft.com/DB2DB"&gt;DB2DB 数据库转换工具&lt;/a&gt; 
    ：一个国产的商业数据库迁移软件&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.navicat.com/en/products/navicat-premium"&gt;Navicat Premium&lt;/a&gt;
    ：经典的数据库管理工具，带数据迁移功能&lt;/li&gt;
&lt;li&gt;&lt;a href="http://www.cnblogs.com/cyq1162/p/5637978.html"&gt;DBImport&lt;/a&gt;
    ：个人维护的迁移工具，非常简陋，需要付费&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;看上去异构数据库迁移工具和方案很多，但是经过我们调研，其中不少是为老派的传统行业服务的。
比如 Kettle / Ispirerer，他们关注的特性，不能满足互联网公司对性能、迁移耗时的要求。
简单筛选后，以下几个工具进入我们候选列表（为了做特性对比，加入几个同构数据库迁移工具）：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;工具名称&lt;/th&gt;
&lt;th&gt;热数据备份保证一致性&lt;/th&gt;
&lt;th&gt;batch 操作&lt;/th&gt;
&lt;th&gt;支持异构数据库&lt;/th&gt;
&lt;th&gt;断点续接&lt;/th&gt;
&lt;th&gt;开源&lt;/th&gt;
&lt;th&gt;开发语言&lt;/th&gt;
&lt;th&gt;GUI&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;mysqldump&lt;/td&gt;
&lt;td&gt;V 使用 &lt;code&gt;single-transaction&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;X&lt;/td&gt;
&lt;td&gt;X&lt;/td&gt;
&lt;td&gt;X&lt;/td&gt;
&lt;td&gt;V&lt;/td&gt;
&lt;td&gt;C&lt;/td&gt;
&lt;td&gt;X&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;pt-table-sync&lt;/td&gt;
&lt;td&gt;V 使用 transaction 或 &lt;code&gt;lock table&lt;/code&gt; 的 FTWRL&lt;/td&gt;
&lt;td&gt;V&lt;/td&gt;
&lt;td&gt;X&lt;/td&gt;
&lt;td&gt;V&lt;/td&gt;
&lt;td&gt;V&lt;/td&gt;
&lt;td&gt;Pell&lt;/td&gt;
&lt;td&gt;X&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;DataX&lt;/td&gt;
&lt;td&gt;X&lt;/td&gt;
&lt;td&gt;V&lt;/td&gt;
&lt;td&gt;V&lt;/td&gt;
&lt;td&gt;X&lt;/td&gt;
&lt;td&gt;V&lt;/td&gt;
&lt;td&gt;Java&lt;/td&gt;
&lt;td&gt;X&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;yugong&lt;/td&gt;
&lt;td&gt;X&lt;/td&gt;
&lt;td&gt;V&lt;/td&gt;
&lt;td&gt;V&lt;/td&gt;
&lt;td&gt;V&lt;/td&gt;
&lt;td&gt;V&lt;/td&gt;
&lt;td&gt;Java&lt;/td&gt;
&lt;td&gt;X&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;DB2DB&lt;/td&gt;
&lt;td&gt;X&lt;/td&gt;
&lt;td&gt;V&lt;/td&gt;
&lt;td&gt;V&lt;/td&gt;
&lt;td&gt;X&lt;/td&gt;
&lt;td&gt;X&lt;/td&gt;
&lt;td&gt;.net&lt;/td&gt;
&lt;td&gt;V&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;MySQL Workbench&lt;/td&gt;
&lt;td&gt;X&lt;/td&gt;
&lt;td&gt;?&lt;/td&gt;
&lt;td&gt;V&lt;/td&gt;
&lt;td&gt;X&lt;/td&gt;
&lt;td&gt;V&lt;/td&gt;
&lt;td&gt;C++&lt;/td&gt;
&lt;td&gt;V&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;由于异构数据库迁移，真正能够进入我们选型的只有
DataX / yugong / DB2DB / MySQL Workbench。
经过综合考虑，我们最终选用了三种方案，
DB2DB 提供小数据量、简单模式的停机模式支持，
足以应付小数据量的停机迁移，开发工程师可以自助完成。
DataX 为大数据量的停机模式提供服务，
使用 JSON 进行配置，通过修改查询 SQL，可以完成一部分结构调整工程。
yugong 的强大可定制性也为在线迁移提供了基础，
我们在官方开源版本的基础之上，增加了以下额外功能：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;支持 SQL Server 作为 Source 和 Target&lt;/li&gt;
&lt;li&gt;支持 MySQL 作为 Source&lt;/li&gt;
&lt;li&gt;支持 SQL Server 增量更新&lt;/li&gt;
&lt;li&gt;支持使用 YAML 作为配置格式&lt;/li&gt;
&lt;li&gt;调整 yugong 为 fat jar 模式运行&lt;/li&gt;
&lt;li&gt;支持表名、字段名大小写格式变化，驼峰和下划线自由转换&lt;/li&gt;
&lt;li&gt;支持表名、字段名细粒度自定义&lt;/li&gt;
&lt;li&gt;支持复合主键迁移&lt;/li&gt;
&lt;li&gt;支持迁移过程中完成 Range / Time / Mod / Hash 分表&lt;/li&gt;
&lt;li&gt;支持新增、删除字段&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;关于 yugong 的二次开发，我们也积累了一些经验，这个我们下篇文章会来分享。&lt;/p&gt;
&lt;h2 id="yi-zhi-xing-xiao-yan-gong-ju"&gt;一致性校验工具&lt;/h2&gt;
&lt;p&gt;在 ETL 之后，需要有一个流程来确认数据迁移前后是否一致。
虽然理论上不会有差异，但是如果中间有程序异常，
或者数据库在迁移过程中发生操作，数据就会不一致。&lt;/p&gt;
&lt;p&gt;业界有没有类似的工具呢？
有，Percona 提供了 pt-table-checksum 这样的工具，
这个工具设计从 master 使用 &lt;code&gt;checksum&lt;/code&gt; 来和 slave 进行数据对比。
这个设计场景是为 MySQL 主从同步设计，
显然无法完成从 SQL Server 到 MySQL 的一致性校验。
尽管如此，它的一些技术设计特性也值得参考：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;一次检查一张表&lt;/li&gt;
&lt;li&gt;每次检查表，将表数据拆分为多个 trunk 进行检查&lt;/li&gt;
&lt;li&gt;使用 &lt;code&gt;REPLACE...SELECT&lt;/code&gt; 查询，避免大表查询的长时间带来的不一致性&lt;/li&gt;
&lt;li&gt;每个 trunk 的查询预期时间是 0.5s&lt;/li&gt;
&lt;li&gt;动态调整 trunk 大小，使用指数级增长控制大小&lt;/li&gt;
&lt;li&gt;查询超时时间 1s / 并发量 25&lt;/li&gt;
&lt;li&gt;支持故障后断点恢复&lt;/li&gt;
&lt;li&gt;在数据库内部维护 src / diff，meta 信息&lt;/li&gt;
&lt;li&gt;通过 Master 提供的信息自动连接上 slave&lt;/li&gt;
&lt;li&gt;必须 Schema 结构一致&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;我们选择 yugong 作为 ETL 工具的一大原因也是因为它提供了多种模式。
支持 CHECK / FULL / INC / AUTO 四种模式。
其中 CHECK 模式就是将 yugong 作为数据一致性检查工具使用。
yugong 工作原理是通过 JDBC 根据主键范围变化，将数据取出进行批量对比。&lt;/p&gt;
&lt;p&gt;这个模式会遇到一点点小问题，如果数据库表没有主键，将无法进行顺序对比。
其实不同数据库有自己的逻辑主键，Oracle 有 &lt;code&gt;rowid&lt;/code&gt;，
SQL Server 有 &lt;code&gt;physloc&lt;/code&gt;。这种方案可以解决无主键进行比对的问题。&lt;/p&gt;
&lt;h2 id="ru-he-hui-gun"&gt;如何回滚&lt;/h2&gt;
&lt;p&gt;我们需要考虑一个场景，在数据库迁移成功之后业务已经运行了几个小时，
但是遇到了一些 Critical 级别的问题，必须回滚到迁移之前状态。
这时候如何保证这段时间内的数据更新到老的数据库里面去？&lt;/p&gt;
&lt;p&gt;最朴素的做法是，在业务层面植入 DAO 层的打点，
将 SQL 操作记录下来到老数据库进行重放。
这种方式虽然直观，但是要侵入业务系统，直接被我们否决了。
其实这种方式是 binlog statement based 模式，
理论上我们可以直接从 MySQL 的 binlog 里面获取数据变更记录。
以 row based 方式重放到 SQL Server。&lt;/p&gt;
&lt;p&gt;这时候又涉及到逆向 ETL 过程，
因为很可能 Translate 过程中，做了表结构重构。
我们的解决方法是，使用 Canal 对 MySQL binlog 进行解析，
然后将解析之后的数据作为数据源，
将其中的变更重放到 SQL Server。&lt;/p&gt;
&lt;p&gt;由于回滚的过程也是 ETL，基于 yugong，
我们继续定制了 SQL Server 的写入功能，
这个模式类似于在线迁移，只不过方向是从 MySQL 到 SQL Server。&lt;/p&gt;
&lt;h2 id="qi-ta-shi-jian"&gt;其他实践&lt;/h2&gt;
&lt;p&gt;我们在迁移之前做了大量压测工作，
并针对每个迁移的 DB 进行线上环境一致的全真演练。
我们构建了和生产环境机器配置一样，
数据量一样的测试环境，并要求每个系统在上线之前都进行若干次演练。
演练之前准备详尽的操作手册和事故处理方案。
演练准出的标准是：能够在单次演练中不出任何意外，时间在估计范围内。
通过演练我们保证了整个操作时间可控，减少操作时候的风险。&lt;/p&gt;
&lt;p&gt;为了让数据库的状态更为直观的展现出来，
我们对 MySQL / SQL Server 添加了细致的 Metrics 监控。
在测试和迁移过程中，可以便利地看到数据库的响应情况。&lt;/p&gt;
&lt;p&gt;&lt;img alt="201803/sql-server-metrics.png" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201803/sql-server-metrics.png"/&gt;&lt;/p&gt;
&lt;p&gt;&lt;img alt="201803/mysql-metrics.png" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201803/mysql-metrics.png"/&gt;&lt;/p&gt;
&lt;p&gt;为了方便 DBA 快速 Review SQL。
我们提供了一些工具，直接将代码库中的 SQL 拎出来，
可以方便地进行 SQL Review。
再配合其他 SQL Review 工具，
比如 &lt;a href="https://github.com/Meituan-Dianping/SQLAdvisor"&gt;Meituan-Dianping/SQLAdvisor&lt;/a&gt;，
可以实现一部分自动化，提高 DBA 效率，避免线上出现明显的 Slow SQL。&lt;/p&gt;
&lt;h2 id="zui-hou"&gt;最后&lt;/h2&gt;
&lt;p&gt;基于这几种方案我们打了一套组合拳。经过将近一年的使用，
进行了 28 个通宵，迁移了 42 个系统，
完成了包括用户、订单、支付、电商、学习、社群、内容和工具的迁移。
迁移的数据总规模接近百亿，所有迁移项目均一次成功。
迁移过程中积累了丰富的实战经验，保障了业务快速向前发展。&lt;/p&gt;
&lt;p&gt;下一篇：&lt;a href="https://blog.alswl.com/2018/05/sql-server-migration-2/"&gt;从 SQL Server 到 MySQL（二）：在线迁移，空中换发动机 - Log4D&lt;/a&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;div class="panel"&gt;
&lt;div class="panel-body"&gt;
   &lt;small&gt;原文链接: &lt;a href="https://blog.alswl.com/2018/03/sql-server-migration-1/"&gt;https://blog.alswl.com/2018/03/sql-server-migration-1/&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;3a1ff193cee606bd1e2ea554a16353ee&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;欢迎关注我的微信公众号：&lt;a href="http://mp.weixin.qq.com/mp/getmasssendmsg?__biz=MzIyNTIwMTU3MQ==#wechat_webview_type=1&amp;wechat_redirect"&gt;窥豹&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/201605/qrcode_for_gh_17e2f9c2caa4_258.jpg"/&gt;&lt;/small&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/meta/wechat-pay-s-crop.png"/&gt;&lt;/small&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="SQLServer"></category><category term="MySQL"></category><category term="DB-Migration"></category></entry><entry><title>从 2017 到 2018</title><link href="https://blog.alswl.com/2018/01/2017-2018/" rel="alternate"></link><published>2018-01-21T22:57:26+08:00</published><updated>2018-01-21T22:57:26+08:00</updated><author><name>alswl</name></author><id>tag:blog.alswl.com,2018-01-21:2018/01/2017-2018/</id><summary type="html">&lt;p&gt;&lt;img alt="2017 年 2 月摄于瑞虹月亮湾" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201801/moon.png"/&gt;&lt;/p&gt;
&lt;p&gt;&lt;small&gt;（2017 年 2 月摄于瑞虹月亮湾）&lt;/small&gt;&lt;/p&gt;
&lt;p&gt;我有两年没公开年终总结了，原因很简单：年终结果无法让自己满意，
生活持续呈线性发展。那今年为什么又要将总结发出来呢？
并非是我的 2017 过得如何充实、有成就感，而是出于两个目的。
第一是我认识到 OKR 需要平和对待，我目前对自己的生活是缺乏完全掌控力的，
我无法既渴求爆炸性的增长，又期望在这一过程中低风险，我需要接受这种现状。
第二是曝光自己的目标，让回顾和计划透明化。
从社会心理学的角度上来看，公开的承诺有助于个体更努力地驱动目标的完成。&lt;/p&gt;

&lt;h2 id="2017"&gt;2017&lt;/h2&gt;
&lt;p&gt;2017 年我将个人生活纳入了 OKR 管理的范围，在这之前是琐碎的 Checklist 管理方法。
OKR 管理的优势在于年初可以关注大方向，保持全年的路线连贯性。
同时 OKR 可以量化的追踪每事项的进展，促进执行。&lt;/p&gt;
&lt;p&gt;我在 2017 年的 OKR 大致如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;阅读  &lt;ul&gt;
&lt;li&gt;精读书籍&lt;/li&gt;
&lt;li&gt;粗读书籍&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;写作  &lt;ul&gt;
&lt;li&gt;写博客&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;健康  &lt;ul&gt;
&lt;li&gt;游泳&lt;/li&gt;
&lt;li&gt;跑步&lt;/li&gt;
&lt;li&gt;素食&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;习惯  &lt;ul&gt;
&lt;li&gt;冥想&lt;/li&gt;
&lt;li&gt;英语&lt;/li&gt;
&lt;li&gt;计划性&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;技术  &lt;ul&gt;
&lt;li&gt;操作系统理论&lt;/li&gt;
&lt;li&gt;新语言学习&lt;/li&gt;
&lt;li&gt;分布式系统&lt;/li&gt;
&lt;li&gt;大数据和人工智能&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;创业准备    &lt;ul&gt;
&lt;li&gt;行业思考&lt;/li&gt;
&lt;li&gt;思维模型&lt;/li&gt;
&lt;li&gt;人脉认识&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;工作  &lt;ul&gt;
&lt;li&gt;普通任务的完成&lt;/li&gt;
&lt;li&gt;突破型任务的完成&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;家庭生活    &lt;ul&gt;
&lt;li&gt;家庭旅行（国内/国外）&lt;/li&gt;
&lt;li&gt;下一代&lt;/li&gt;
&lt;li&gt;上海话&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;财务  &lt;ul&gt;
&lt;li&gt;投资入门&lt;/li&gt;
&lt;li&gt;投资学习学习&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;我就不将 Key Result 一一罗列出来了，加权平均之后，年度最终的得分是 0.40895。
我不觉得自己的目标设置得过高，过低的分数的原因是执行力不够。&lt;/p&gt;
&lt;p&gt;人的一身充满许多轻易就能够改变自己人生轨迹的事件，比如高考、恋爱，工作变动。
在 2017 年，我面临最重大事情就是我离开堆糖，在沪江开始了一段新的职业生涯。
不像那些足够理性的人，离开堆糖我非常不舍，过程中充满挣扎，最后还是做了决定。
到沪江之后，整个环境发生了变化，我从一百人不到的精英团队进入一个几千人、
具有许多历史包袱的大团队，一度压力很大。
在经历了冲突、沟通、推动这些状态之后，我也逐渐适应了。
此时又出现了新的焦虑：如何在一个相对迟缓的环境推动有效的变化。
这是一个大课题，也是我 2018 年想尝试解决的问题。&lt;/p&gt;
&lt;p&gt;17 年工作内容，主要围绕这么几块内容：将这个集团的 SQL Server 迁移到 MySQL 上。
核心需要解决的是将大规模异构数据进行离线/在线迁移，目标是缩短停机时间。
在迁移过程中还要提供一些数据重构功能，以便数据结构进行调整。
这个问题和当年阿里巴巴的去 IOE 有些相似，他们是 Oracle 到 MySQL，而我是从
SQL Server 到 MySQL。
我投入不少时间，好在结果挺不错，项目前后持续了半年时间，没有发生一例问题。
现在已经可以脱离我独立运作了。
除此之外我还在集团引入了 Metrics 系统；在集团开展一个每周的技术分享活动：沪江技术之夜。&lt;/p&gt;
&lt;p&gt;2017 全年看书有 48 本，是我近年来读书较多的一年。读书速度加快的主要原因是：
我主动追求更快的读书速度，提升索引归纳能力。
为此反复学习了「如何阅读一本书」/「如何高效学习」等方法。&lt;/p&gt;
&lt;p&gt;今年推荐阅读的几本书是：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;「讲理 : 作文四书之一」 - 王鼎钧&lt;ul&gt;
&lt;li&gt;教你如何写论说文，让每个作者能挥洒自如表达自己思想和态度。
    作者有一套「作文四书」，感谢余晟老师赠书。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;「人类简史」 - 尤瓦尔&amp;middot;赫拉利&lt;ul&gt;
&lt;li&gt;开脑洞的人类历史学研究，作者妙笔生花，将复杂事情以形象和有趣的方法呈现给大家。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;「腾讯传 : 中国互联网公司进化论」- 吴晓波&lt;ul&gt;
&lt;li&gt;中国互联网企业发家史，虽然大环境在不断变化，但当时决策的逻辑还有相当参考价值。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;「解读中国经济 - 林毅夫」&lt;ul&gt;
&lt;li&gt;作为高参，林毅夫对中国当代经济环境理解深刻。
    书中讲述了从 78 年改革开放到现在的制度变迁。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;17 写了 7 篇文章，低于预期。虽然在我的 inbox 里面存了不少草稿，
但觉得自己的逻辑还不流畅，修辞也不够优雅，还不好意思拿出来给大家看。
文字驾驭能力差这个问题我也意识到了，恰好边上有位写作高手，推荐了一些相关书籍。
期望接下来通过学习写作得到改善。&lt;/p&gt;
&lt;p&gt;2017 年去了一趟香港，不幸的是遭遇身体不适，在中环地铁晕厥，导致澳门行也取消。
患难见真情，我老婆对我也是真感情。除此之外，还和夫人去了一趟九华山。&lt;/p&gt;
&lt;p&gt;17 年还有一件幸运的事情，上海牌照拍了 17 个月之后终于中了，具备了买车的资格。
唯一遗憾的是，同时中了两张牌照，但是没有这么大的需求，无奈放弃一张，
还被罚款 1000 元。&lt;/p&gt;
&lt;p&gt;17 年让我产生幸福感的几个物件推荐：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ErgoDox 键盘：可编程的分体键盘，用了一遍，手腕再也不疼了。&lt;ul&gt;
&lt;li&gt;我的 ErgoDox 驱动配置：
    &lt;a href="https://github.com/alswl/ergodox-firmware"&gt;alswl/ergodox-firmware: firmware for the ergoDOX keyboard&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;我在知乎回答的感受帖：
    &lt;a href="https://www.zhihu.com/question/52088337/answer/141073759"&gt;使用Ergodox人体工学键盘是什么样的体验？ - 知乎&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;洁成背心式垃圾袋&lt;ul&gt;
&lt;li&gt;解决了要丢垃圾的中年男人担心垃圾袋脏的问题&lt;/li&gt;
&lt;li&gt;&lt;a href="https://item.jd.com/1529913.html"&gt;洁成背心式垃圾袋三卷装&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Toodledo&lt;ul&gt;
&lt;li&gt;&lt;a href="http://www.toodledo.com/index.php?ref=td4d1aebdd0f59e"&gt;Toodledo&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;我认为最好的 GTD 管理软件，这一年我面临的工作频度非常高，
    全就靠 Toodledo 帮我管理任务，基于复杂的 Searches，
    大大提高我上下文切换速度，老工具焕发新春。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Proxifier&lt;ul&gt;
&lt;li&gt;&lt;a href="https://www.proxifier.com/"&gt;Proxifier - Bypass firewall and proxy, tunnel connections through an HTTPS and SOCKS proxy&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Mac 下能够将任何 App 设置代理的工具。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;「得到」的「硅谷来信」- 吴军&lt;ul&gt;
&lt;li&gt;吴军作为成功的工程师、科学家、技术领袖、科技作家、历史作家，
    有太多的思想可以被学习和直接使用&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="2018"&gt;2018&lt;/h2&gt;
&lt;p&gt;2018 年我将迎来自己的三十而立。&lt;/p&gt;
&lt;p&gt;人这种动物，总是在周期性的时间点上比平时更容易思考。
我花了几个周末，加上好几个洗澡的时间思考我接下来的目标是什么。
1 年的目标？5 年的目标？&lt;/p&gt;
&lt;p&gt;我一度没有答案，尤其是在被罗胖等内容创业者贩卖焦虑之后。
我倒是不担心自己像中兴那位 35 岁的同行，在各种压力之下逼得跳楼。
我的压力和焦虑主要是来自我自己未来想象空间太小。
剩下的时间越少，可以调整的变量范围就越小，随着时间巨轮碾过，
不管未来发展是线性还是非线性，都在忙忙碌碌中逐步变成现实。&lt;/p&gt;
&lt;p&gt;有时候也挺恨自己不具备天马行空的想象力和愿景。
我思考的结果是，技术发展速度虽然快，但是核心改变是有限的。
我目前没有足够的想法来做上层的事，那就切入基础领域，花时间补足短板。
在这个思路指导下，新年的 OKR 对基础领域的投入提高了比例：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Direction&lt;/th&gt;
&lt;th&gt;Objective&lt;/th&gt;
&lt;th&gt;Key Result&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;掌握面向未来的技能&lt;/td&gt;
&lt;td&gt;初步掌握机器学习的基本技能&lt;/td&gt;
&lt;td&gt;学完 Coursera Machine Learning&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;学完「集体编程智慧」&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;掌握区块链知识&lt;/td&gt;
&lt;td&gt;读一本区块链的书&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;掌握基础的技能&lt;/td&gt;
&lt;td&gt;数学&lt;/td&gt;
&lt;td&gt;看完「数学之美」&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;看完「什么是数学」&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;看完「如何解题」&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;写一篇关于数学的文章&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;弄清楚概率论的研究对象、范畴、方法论&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;提升英文水平&lt;/td&gt;
&lt;td&gt;扇贝背完 TOFEL 词汇&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;扇贝背完 GAE 词汇&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;写 2 篇英文博客&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;经济管理&lt;/td&gt;
&lt;td&gt;读完「经济学原理」&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;读完吴晓波的一系列书&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;读 3 本关于投资的书&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;通过投资获得 X 元收益&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;提升系统化思考能力&lt;/td&gt;
&lt;td&gt;读 5 本相关书籍&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;学完 Coursera Model Thinking 课程&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;团队管理&lt;/td&gt;
&lt;td&gt;阅读团队管理相关 5 本书籍&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;产出 3 篇相关文章&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;XXX&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;提升专业技能&lt;/td&gt;
&lt;td&gt;Scala 语言深入&lt;/td&gt;
&lt;td&gt;学完 Coursera Scala 课程&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;读完「Akka Cookbook」&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;读完「深入理解 Scala」&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;分布式系统深入&lt;/td&gt;
&lt;td&gt;学习 MIT 课程&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;研究 TiDB，产出文章&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;写一篇 CAP 文章&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;计算机语言和基础&lt;/td&gt;
&lt;td&gt;读完「Java Concurrency in Practice」&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;读完「Go 语言编程」&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;读完「算法新解」&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;读完「SICP」&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;提升家庭生活质量&lt;/td&gt;
&lt;td&gt;旅行&lt;/td&gt;
&lt;td&gt;出国旅行 1 次&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;出江浙沪旅行 2 次&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;父母&lt;/td&gt;
&lt;td&gt;回父母家 10 次&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;小孩&lt;/td&gt;
&lt;td&gt;生 1 个&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;车&lt;/td&gt;
&lt;td&gt;买 1 辆车&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;养成习惯&lt;/td&gt;
&lt;td&gt;运动&lt;/td&gt;
&lt;td&gt;全年跑步或游泳 36 次&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;计划和复盘&lt;/td&gt;
&lt;td&gt;全年做早晨计划 264 次&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;全年做习惯追踪 365 次&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;每周做 Review&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;提升个人 PR&lt;/td&gt;
&lt;td&gt;结实外部朋友&lt;/td&gt;
&lt;td&gt;参会 4 次&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;面向 100+ 人的外部做 1 次分享&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;外部代码贡献&lt;/td&gt;
&lt;td&gt;参与 1 个开源项目，提交核心作用代码&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;提升写作能力&lt;/td&gt;
&lt;td&gt;全年写作 12 篇&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;参加开智的课程&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;从目标执行的可行性上来说，年度 OKR 往往是允许甚至是推荐在执行过程中修改的。
季度的 OKR 在确定之后不允许进行修改。毕竟计划赶不上变化，但是又不能朝令夕改。
希望我今年在大方向保持稳定，每个季度能够执行贯彻到位，将时间价值最大化。&lt;/p&gt;
&lt;p&gt;2017，混乱和秩序相交。2018，进入冰山之下。&lt;/p&gt;
&lt;hr&gt;
&lt;div class="panel"&gt;
&lt;div class="panel-body"&gt;
   &lt;small&gt;原文链接: &lt;a href="https://blog.alswl.com/2018/01/2017-2018/"&gt;https://blog.alswl.com/2018/01/2017-2018/&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;3a1ff193cee606bd1e2ea554a16353ee&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;欢迎关注我的微信公众号：&lt;a href="http://mp.weixin.qq.com/mp/getmasssendmsg?__biz=MzIyNTIwMTU3MQ==#wechat_webview_type=1&amp;wechat_redirect"&gt;窥豹&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/201605/qrcode_for_gh_17e2f9c2caa4_258.jpg"/&gt;&lt;/small&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/meta/wechat-pay-s-crop.png"/&gt;&lt;/small&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="2017"></category><category term="年度"></category></entry><entry><title>工作和热情</title><link href="https://blog.alswl.com/2017/12/enthusiasm/" rel="alternate"></link><published>2017-12-21T23:46:59+08:00</published><updated>2017-12-21T23:46:59+08:00</updated><author><name>alswl</name></author><id>tag:blog.alswl.com,2017-12-21:2017/12/enthusiasm/</id><summary type="html">&lt;p&gt;&lt;img alt="201712/work.jpg" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201712/work.jpg"/&gt;&lt;/p&gt;
&lt;p&gt;最近和一位老朋友吃饭，他说他最近比较苦恼：
「开始有职业危机了，担心自己失去对工作的热情，似乎离油腻的中年人又进了一步」。
作为一名互联网工程师，我深知这个行业技术日新月异，
如果对工作都失去了兴趣，会将自己置于跟不上时代发展、自身得不到提升的危险境地；
从个人生活质量来看，工作占据了一天 1/3 ~ 2/3 的时间，
失去热情的工作会成为人生的桎梏，不是驾驭工作，而是被工作所奴役，
这会进而影响一个人的身心健康，得个抑郁症稀疏平常。&lt;/p&gt;
&lt;p&gt;如何保持对工作的热情，当自己陷入困境时候如何重新调动工作热情？
这是职场人需要深思的问题。&lt;/p&gt;

&lt;h2 id="gong-zuo-dai-lai-shi-yao"&gt;工作带来什么？&lt;/h2&gt;
&lt;p&gt;从因到果，让我们先聊聊工作给我们带来什么？&lt;/p&gt;
&lt;p&gt;对于不是含着金钥匙出生的群众来说，物质上的回报是重要并且第一位的。
如果温饱的需求都没有被满足，就没必要讨论精神世界的热情了。
大部分刚出校园的职场新人可能处于这个状态，一人吃饱全家不愁。
从马斯洛需求层次理论说起：
当「生理需求」、「安全需求」被满足之后，就需要「社交需求」、「尊重需求」
和「自我实现的需求」。
将这些需求映射到工作中，那就是成了「有志同道合的人一起工作」，
「工作能干出成绩，获得认可」，
「有挑战，干出成就感」。&lt;/p&gt;
&lt;p&gt;我有过一段经历：一个优秀工程师突然申请离职，和他沟通离职原因时，
他的反馈是「乏了，觉得工作没劲，甚至怀疑开发工程师是否是自己想要的工作，
想要回家休息一段时间」。
这个小伙子其实很优秀很优秀，FullStack，好奇心强烈，休息了一段时间，去了豆瓣厂。
我们后来分析，可能有这么几个原因导致他对这份工作失去了兴趣：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;他被分配到的工作内容不够有挑战，业务开发在一定程度上面有重复性&lt;/li&gt;
&lt;li&gt;他所做的几个项目，没有被充分发挥价值，没有获得足够的认同感&lt;/li&gt;
&lt;li&gt;公司的业务没有出现迅猛爆发，缺乏业务上的成就感&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;由于这个案例的存在，后期我们也做了一些调整，避免再次发生这样的优秀人才流失悲剧。
当然，这些调整都是从组织的视角出发。但并非所有组织都有这样自省能力。
那么作为个体，有哪些方法可以挽回逝去的热情呢？&lt;/p&gt;
&lt;h2 id="fang-da-yi-you-cheng-ji-de-ying-xiang-li"&gt;放大已有成绩的影响力&lt;/h2&gt;
&lt;p&gt;将已有的工作成绩影响力放大，这是最不耗力气的一种办法。&lt;/p&gt;
&lt;p&gt;我们工作中，应当是取得了一些成绩的，这些成绩是否已经最大化发挥作用了？
还有没有价值可以深挖？&lt;/p&gt;
&lt;p&gt;扩大作用的一种做法就是写作。
将工作内容中有创新、创意的地方，落实为文章进行发表。
不少公司会有和技术相关的宣传平台，比如沪江就有一个「沪江技术学院」公众号。
就比较适合发布公司内的一些技术创新、工程实践。
如果公司没有提供这样的平台，也可以使用自己的公众号或者博客，
唯一要注意的就是敏感信息不要泄露。&lt;/p&gt;
&lt;p&gt;除了使用写文章的方式，还有其他一些思路可以参考：做内部/外部分享；
将成果开源出来。做分享可以给自己带来不少成就感，
内部的分享可以更快速的对自己的成果进行宣传，也能通过这种形式培养信任感。
做开源是一个更大的话题，不少团队有这样的成功经验。比如饿了么的 Element，
我司也开源了 Guice 这样的系统。
这都是在日常工作中的工程实施总结形成的开源项目。&lt;/p&gt;
&lt;p&gt;有同学会问：自己觉得自己的工作亮点太少，缺乏对外部分享的价值。
其实这种担忧大可不必，只要是有价值的输出，总是能找到适合的输出对象，
如果对行业老司机没有帮助，那么对新人是否有帮助呢？
对上下游的 parterner 是否有帮助么？
前两天还看到一个阿里的开源项目 &lt;a href="https://github.com/alibaba/java-dns-cache-manipulator"&gt;alibaba/java-dns-cache-manipulator&lt;/a&gt;，
你能说这个很复杂么？但仍然可以给特定场景的人带来帮助。&lt;/p&gt;
&lt;h2 id="jia-da-shen-du-yan-du-zhui-qiu-ji-zhi"&gt;加大深度广度，追求极致&lt;/h2&gt;
&lt;p&gt;假如工作内容是千篇一律，相信不管是谁都无法长期容忍。
这时候就要考虑一下突破自己固有的职责边界。&lt;/p&gt;
&lt;p&gt;第一种路径是突破工作内容所需要的深度，
将工作关注的问题能够刨根问底。在平凡的工作机会上面做出彩。
牛顿在发现力学三大定律，发明微积分后，还去英国皇家铸币厂工作。
我相信作为物理学家、数学家，他对主持铸币这个工作和他过往的工作无关，
但他仍然投入了极大精力和热情去处理事务，并且变革了从银本位到金本位。&lt;/p&gt;
&lt;p&gt;第二种方式是扩大自己的涉猎面，尝试探索新鲜事务。
在日常工作中，思考一下自己的上游、下游是否有遇到一些瓶颈，可否给予他们帮助？
支撑自己日常工作的基础设施是否足够高效、健壮，能否在上面出一些力量？
更有甚者，一些技术同学可以向前台走，去从技术的视角推动业务的变化。
也有一些同学可以往后走，往 BI 或者 AI 发展。
改变自己的职能变动太大，但是适当扩展自己涉猎面可以增强自己综合素质，
为未来提供更多可能性。&lt;/p&gt;
&lt;p&gt;最后一个路径是以更极致的标准来要求自己。
有些朋友可能会说道：在工程实践中，我们不是不推崇过度设计么？
的确，我们要避免矫枉过正，但如果现在要求达到 60 分，我们做 120 分可能是过度设计，
我并不觉得追求 80 分有什么过分。
以超出需求者期望的姿态做事，技术上面追求极致，业务上追求卓越，
过程可能比较艰辛，但是获得的成就感也会更大。&lt;/p&gt;
&lt;p&gt;积极主动去摸索自己的瓶颈，不要被自己的现状所禁锢。
掌握自己固有知识，挖掘上下游知识，这是保持热情的重要方式。&lt;/p&gt;
&lt;h2 id="xun-zhao-zhi-tong-dao-he-de-peng-you"&gt;寻找志同道合的朋友&lt;/h2&gt;
&lt;p&gt;一个人是孤独的，鲁滨逊尚且需要星期五相伴，
何况我们这些生活在高度复杂社会里的人。
当一个人对方向产生迷茫，对处境有困惑，对问题感到棘手时候，
陪伴在周围的朋友是极其重要的。&lt;/p&gt;
&lt;p&gt;我在前东家曾经有过迷茫的时间段，但是遇到了相当多可以学习的朋友。
我们交流对现状的看法，探索解决问题的思路，畅谈未来发展的可能性。
这个过程中，发挥出了 1+1&amp;gt;2 的效应，互相激励，互相促进。&lt;/p&gt;
&lt;p&gt;如果在团队内找不到合适的伙伴，
那么参加外部活动，加入本地社区就是另外一种寻找朋友的方式。
在豆瓣同城、Meetup 等网络社区中，都可以找到大量同行业的朋友。
我自己曾经深度参与的组织有 CPyUG（Python 社区） / GDG（Google 开发者社区）
/ LUG（Linux 用户组）。&lt;/p&gt;
&lt;p&gt;写作也是一种高效的社交，建立自己的知识输出平台，有利于结实更多同行业人才。
输出自己的经验的同时，还能进行二次思考，并且形成自己的个人品牌。&lt;/p&gt;
&lt;h2 id="yong-jiao-tou-piao"&gt;用脚投票&lt;/h2&gt;
&lt;p&gt;如果经过各种尝试，发现的确无法恢复自己对工作的热情，那么也可能是环境的问题。
给自己一些时间思考，思考清楚原因。
离开对个体和团队来说未必是一件好事。
长期消沉没有战斗力的人，对于团队其实是团队毒药，会将气氛带差。
在一个没有热情的环境中工作，也是浪费个人的时间。「逝者如斯，不舍昼夜」，
一个人的生命何其短暂，不要浪费在没热情的事情上。&lt;/p&gt;
&lt;p&gt;如果离开当前的团队，那么在下次选择时候，一定要慎重考虑之前遇到的问题，
避免悲剧重复发生。&lt;/p&gt;
&lt;h2 id="zui-hou"&gt;最后&lt;/h2&gt;
&lt;p&gt;一个人很难持续保持极高热情，原因是你的工作内容始终会变得熟悉和重复。
这时候即进入一个舒适区，选择适应环境还是挣扎走出来，
这取决于个人的追求。
努力调整自己，通过学习、体验、Review 的方式，来帮助自己成长。
当到达瓶颈期的时候，想办法从自身、外部寻找帮助，重新进入非舒适区，才能让自己持续成长。&lt;/p&gt;
&lt;p&gt;祝你有热情地工作。&lt;/p&gt;
&lt;hr&gt;
&lt;div class="panel"&gt;
&lt;div class="panel-body"&gt;
   &lt;small&gt;原文链接: &lt;a href="https://blog.alswl.com/2017/12/enthusiasm/"&gt;https://blog.alswl.com/2017/12/enthusiasm/&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;3a1ff193cee606bd1e2ea554a16353ee&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;欢迎关注我的微信公众号：&lt;a href="http://mp.weixin.qq.com/mp/getmasssendmsg?__biz=MzIyNTIwMTU3MQ==#wechat_webview_type=1&amp;wechat_redirect"&gt;窥豹&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/201605/qrcode_for_gh_17e2f9c2caa4_258.jpg"/&gt;&lt;/small&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/meta/wechat-pay-s-crop.png"/&gt;&lt;/small&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="Enthusiasm"></category><category term="Passion"></category></entry><entry><title>一个关于 nolock 的故事：深入理解数据库隔离级别</title><link href="https://blog.alswl.com/2017/09/sql-server-nolock/" rel="alternate"></link><published>2017-09-19T16:43:45+08:00</published><updated>2017-09-19T16:43:45+08:00</updated><author><name>alswl</name></author><id>tag:blog.alswl.com,2017-09-19:2017/09/sql-server-nolock/</id><summary type="html">&lt;p&gt;&lt;img alt="sql-server.png" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201709/sql-server.png"/&gt;&lt;/p&gt;
&lt;p&gt;加入沪江不久，我就被扔到一个将集团 SQL Sever 的数据库迁移到 MySQL 的项目里，
同时伴随进行的还有 .net 系统迁移到 Java 系统。
在这个过程中我发现了一个很有趣的现象：历史遗留的 .net 项目中，
几乎所有的 SQL 中都会使用一个关键字：&lt;code&gt;nolock&lt;/code&gt;。
这让我很困惑，&lt;code&gt;nolock&lt;/code&gt; 的字面意思是对当前技术不使用锁技术，为什么要这样用呢？&lt;/p&gt;

&lt;p&gt;我找了一个范例如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;SELECT&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; 
&lt;span class="k"&gt;FROM&lt;/span&gt;   &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;dbo&lt;/span&gt;&lt;span class="p"&gt;].[&lt;/span&gt;&lt;span class="n"&gt;foos&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="k"&gt;WITH&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;nolock&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; 
&lt;span class="k"&gt;WHERE&lt;/span&gt;  &lt;span class="n"&gt;aField&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;42&lt;/span&gt; 
       &lt;span class="k"&gt;AND&lt;/span&gt; &lt;span class="n"&gt;bField&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt; 
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;作为横向支持工程师，开发工程师会问我：「数据库即将从 SQL Server
迁移到 MySQL，我们编码中还需要使用 &lt;code&gt;nolock&lt;/code&gt; 么？
MySQL 里面对应的写法是什么？」。
我并没有 SQL Server 的生产环境使用经验，一时间无法回答。
于是课后做相关知识学习，这里就是这次学习的一点成果。&lt;/p&gt;
&lt;p&gt;这个问题将被拆解成三个小问题进行回答：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;nolock&lt;/code&gt; 是什么？&lt;/li&gt;
&lt;li&gt;为什么会需要在每个 Query 语句使用 &lt;code&gt;nolock&lt;/code&gt;？&lt;/li&gt;
&lt;li&gt;MySQL 的对应写法是什么？&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;让我们一个一个来看。&lt;/p&gt;
&lt;h2 id="di-yi-ge-wen-ti-nolock-shi-shi-yao"&gt;第一个问题：nolock 是什么？&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;nolock&lt;/code&gt; 是 SQL Server 的一个关键字，这类关键字官方将其称之为 Hints。
Hints 的设计目的是为了能够让 SQL 语句在运行时，动态修改查询优化器的行为。
在语法上，Hints 以 &lt;code&gt;WITH&lt;/code&gt; 开头。除了 &lt;code&gt;WITH(nolock)&lt;/code&gt;，
还有 &lt;code&gt;TABLOCK&lt;/code&gt; / &lt;code&gt;INDEX&lt;/code&gt; / &lt;code&gt;ROWLOCK&lt;/code&gt; 等常见的 Hints。&lt;/p&gt;
&lt;p&gt;让我们仔细看看 MSDN 文档上的解释：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;nolock&lt;/code&gt; 的作用等同于 &lt;code&gt;READUNCOMMITTED&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;code&gt;READUNCOMMITTED&lt;/code&gt; 这是一种 RDBMS 隔离级别。
使用 &lt;code&gt;nolock&lt;/code&gt; 这个关键词，可以将当前查询语句隔离级别调整为 &lt;code&gt;READ UNCOMMITTED&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;计算机基础好的同学，应该对 &lt;code&gt;READUNCOMMITTED&lt;/code&gt; 这个关键词还有印象。
而基础不扎实的同学，也许只是觉得这个关键词眼熟，但是讲不清楚这是什么。
如果阅读这句话完全没有理解困难，那恭喜你，你可以直接跳到下一节了。
其他朋友就跟随我继续探索一下 RDMBS 的世界，复习一下隔离级别相关的知识。&lt;/p&gt;
&lt;h3 id="ge-chi-ji-bie"&gt;隔离级别&lt;/h3&gt;
&lt;p&gt;SQL 92 定义了四个隔离级别
（&lt;a href="https://en.wikipedia.org/wiki/Isolation_(database_systems)#Isolation_levels"&gt;Isolation (database systems) - Wikipedia&lt;/a&gt;），
其隔离程度由高到低是：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;可序列化（Serializable）&lt;/li&gt;
&lt;li&gt;可重复读（Repeatable reads）&lt;/li&gt;
&lt;li&gt;提交读（Read committed）&lt;/li&gt;
&lt;li&gt;未提交读（Read uncommitted）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;单单将这几个技术名词简单地罗列出来并没有什么意义，还有这几个问题需要搞清楚：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;隔离级别解决什么问题？&lt;/li&gt;
&lt;li&gt;为什么存在多种隔离级别？&lt;/li&gt;
&lt;li&gt;我们所谓的隔离级别从高到低，是什么含义，如何逐层降低的？&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;首先是「隔离级别解决什么问题？」，
用通俗的语言描述就是：加一个针对数据资源的锁，从而保证数据操作过程中的一致性。&lt;/p&gt;
&lt;p&gt;这是最简单的实现方式，过于粗暴的隔离性将大幅降低性能，
多种隔离级别就是是为了取得两者的平衡。&lt;/p&gt;
&lt;p&gt;接下来我们来回答第二个问题「为什么存在多种粒度的隔离级别？」
这其实是一个需求和性能逐步平衡的过程，&lt;/p&gt;
&lt;p&gt;我们逐层递进，将隔离级别由低到高逐层面临进行分析。&lt;/p&gt;
&lt;h4 id="read-uncommitted"&gt;Read Uncommitted&lt;/h4&gt;
&lt;p&gt;Read Uncommitted 这个隔离级别是最低粒度的隔离级别，
如同它的名字一般，它允许在操作过程中不会锁，从而让当前事务读取到其他事务的数据。&lt;/p&gt;
&lt;p&gt;&lt;img alt="read-uncommitted.png" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201709/read-uncommitted.png"/&gt;&lt;/p&gt;
&lt;p&gt;如上图所示，在 Transaction 2 查询时候，Transaction 1 未提交的数据就已经对外暴露。
如果 Transaction 1 最后 Rollback 了，那么 Transaction 读取的数据就是错误的。&lt;/p&gt;
&lt;p&gt;「读到了其他事务修改了但是未提交的数据」即是&lt;strong&gt;脏读&lt;/strong&gt;。&lt;/p&gt;
&lt;h3 id="read-committed_1"&gt;Read Committed&lt;/h3&gt;
&lt;p&gt;想要避免脏读，最简单的方式就是在事务更新操作上加一把写锁，
其他事务需要读取数据时候，需要等待这把写锁释放。&lt;/p&gt;
&lt;p&gt;&lt;img alt="read-committed-1.png" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201709/read-committed-1.png"/&gt;&lt;/p&gt;
&lt;p&gt;如上图所示，Transaction 1 在写操作时候，对数据 A 加了写锁，
那么 Transaction 2 想要读取 A，就必须等待这把锁释放。
这样就避免当前事务读取其他事务的未提交数据。&lt;/p&gt;
&lt;p&gt;但是除了脏读，一致性的要求还需要「可重复读」，即
「在一个事务内，多次读取的特定数据都必须是一致的
（即便在这过程中该数据被其他事务修改）」。&lt;/p&gt;
&lt;p&gt;&lt;img alt="read-committed-2.png" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201709/read-committed-2.png"/&gt;&lt;/p&gt;
&lt;p&gt;上图就是没能保证「可重复度」，Transaction 2 第一次读取到了数据 A，
然后 Transaction 1 对数据 A 更新到 A'，那么当 Tranction 2 再次读取 A 时候，
它本来期望读到 A，但是却读到了 A'，这和它的预期不相符了。
解决这个问题，就需要提升隔离级别到「Repeatable Read」。&lt;/p&gt;
&lt;h3 id="repeatable-read"&gt;Repeatable Read&lt;/h3&gt;
&lt;p&gt;这个名字非常容易理解，即保障在一个事务内重复读取时，
始终能够读取到相同的内容。来看图：&lt;/p&gt;
&lt;p&gt;&lt;img alt="repeatable-read.png" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201709/repeatable-read.png"/&gt;&lt;/p&gt;
&lt;p&gt;如上所示，当 Transation 2 读取 A 时候，会同时加上一把 Read Lock，
这把锁会阻止 Transaction 1 将 A 更新为 A'，Transaction 1 要么选择等待，
要么就选择结束。&lt;/p&gt;
&lt;p&gt;当我们将隔离级别升到这里是，似乎已经完美无缺了。
不管是写入还是读取，我们都可以保证数据的一致性不被破坏。
但是其实还有漏洞：新增数据的一致性！&lt;/p&gt;
&lt;p&gt;上述的三个隔离级别，都是对特定的一行数据进行加锁，
那假如将要更新的数据还没有写入数据库，如何进行加锁呢？
比如自增表的新键，或者现有数据内的空缺 Key？&lt;/p&gt;
&lt;p&gt;&lt;img alt="repeatable-read-2.png" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201709/repeatable-read-2.png"/&gt;&lt;/p&gt;
&lt;p&gt;如图所示，在上述操作中，Transaction 2 查询了一个范围 Range 之后，Transaction 1
在这个范围内插入了一条新的数据。此时 Transaction 2 再次进行范围查询时候，
会发现查询到的 Range 和上次已经不一样了，多了一个 newA。&lt;/p&gt;
&lt;p&gt;这就是最高隔离级别才能解决的「幻影读」：
当两个完全相同的查询语句执行得到不同的结果集，
这常常在范围查询中出现。&lt;/p&gt;
&lt;h3 id="serializable"&gt;Serializable&lt;/h3&gt;
&lt;p&gt;从字面意思看，该隔离级别需要将被操作的数据加锁加一把锁。
任何读写操作都需要先获得这把锁才能进行。如果操作中带 WHERE 条件，
还需要将 WHERE 条件相关的范围全部加锁。&lt;/p&gt;
&lt;p&gt;&lt;img alt="serializable.png" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201709/serializable.png"/&gt;&lt;/p&gt;
&lt;p&gt;如图所示，在 Transaction 2 操作过程中，会对 Range 进行加锁，
此时其他事务无法操作其中的数据，只能等待或者放弃。&lt;/p&gt;
&lt;h3 id="db-de-mo-ren-ge-chi-ji-bie"&gt;DB 的默认隔离级别&lt;/h3&gt;
&lt;p&gt;现在我们已经理解了隔离级别，那么「SQL Server 默认使用的隔离级别是什么呢？」
根据 &lt;a href="https://msdn.microsoft.com/en-us/library/ms175909.aspx"&gt;Customizing Transaction Isolation Level&lt;/a&gt;
这个文档描述，SQL Server 默认隔离级别是 READ COMMITTED。&lt;/p&gt;
&lt;p&gt;MySQL InnoDB 的默认隔离级别可以在 &lt;a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-transaction-isolation-levels.html"&gt;MySQL :: MySQL 5.7 Reference Manual :: 14.5.2.1 Transaction Isolation Levels&lt;/a&gt;
查询到，是 Read-Repeatable。&lt;/p&gt;
&lt;p&gt;隔离级别并没有最好之说，越高隔离级别会导致性能降低。
隔离级别的设定需要考虑业务场景。&lt;/p&gt;
&lt;h2 id="di-er-ge-wen-ti-wei-shi-yao-yao-shi-yong-nolock_1"&gt;第二个问题：为什么要使用 nolock？&lt;/h2&gt;
&lt;p&gt;我们已经知道 &lt;code&gt;nolock&lt;/code&gt; 的作用是动态调整隔离级别。
那为什么在 SQL Server 的 Query 操作中，需要启用 &lt;code&gt;nolock&lt;/code&gt; 呢？
我问了几个工程师，他们都语焉不详，或者是很泛泛地说：禁用读写锁，可以提升查询性能。&lt;/p&gt;
&lt;p&gt;此时我产生了困惑：「那么此时的数据一致性就不需要考虑了么？
我们的数据库，已经到了需要禁用锁的程度来进行优化了么？」
我于是自己去探索，想知道为何广泛使用 &lt;code&gt;nolock&lt;/code&gt; 会成为一个「最佳实践」？&lt;/p&gt;
&lt;p&gt;由于时代久远，我只能追述到一些相关信息，比如
&lt;a href="https://blogs.msdn.microsoft.com/sqlcat/2013/09/16/top-10-sql-server-integration-services-best-practices/"&gt;Top 10 SQL Server Integration Services Best Practices | SQL Server Customer Advisory Team&lt;/a&gt;
中提到 「Use the NOLOCK or TABLOCK hints to remove locking overhead.」
但这个是针对于 SSIS 查询器，并不是针对业务内部使用。
反而能找到一大堆的文档，在反对使用 &lt;code&gt;nolock&lt;/code&gt; 这个关键字。&lt;/p&gt;
&lt;p&gt;继续追查下去，还从蛛丝马迹中寻找到一个使用 &lt;code&gt;nolock&lt;/code&gt; 的理由，
SQL Server 默认是 Read Committed，
更新操作会产生排它锁，会 block 这个资源的查询操作，
已插入但未提交的数据主键也会产生一个共享锁，
而此时则会 block 这张表的全表查询和 Insert 操作。
为了避免 Insert 被 Block，就会推荐使用 &lt;code&gt;nolock&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;为了验证这是原因，我做一些 &lt;code&gt;nolock&lt;/code&gt; 测试。&lt;/p&gt;
&lt;h3 id="nolock-ce-shi"&gt;nolock 测试&lt;/h3&gt;
&lt;p&gt;检查当前 SQL Server 隔离级别，确认隔离级别是默认的 Read Committed：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;SELECT&lt;/span&gt; &lt;span class="k"&gt;CASE&lt;/span&gt; &lt;span class="n"&gt;transaction_isolation_level&lt;/span&gt;
       &lt;span class="k"&gt;WHEN&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
         &lt;span class="k"&gt;THEN&lt;/span&gt; &lt;span class="s1"&gt;'Unspecified'&lt;/span&gt;
       &lt;span class="k"&gt;WHEN&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;
         &lt;span class="k"&gt;THEN&lt;/span&gt; &lt;span class="s1"&gt;'ReadUncommitted'&lt;/span&gt;
       &lt;span class="k"&gt;WHEN&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;
         &lt;span class="k"&gt;THEN&lt;/span&gt; &lt;span class="s1"&gt;'ReadCommitted'&lt;/span&gt;
       &lt;span class="k"&gt;WHEN&lt;/span&gt; &lt;span class="mi"&gt;3&lt;/span&gt;
         &lt;span class="k"&gt;THEN&lt;/span&gt; &lt;span class="s1"&gt;'Repeatable'&lt;/span&gt;
       &lt;span class="k"&gt;WHEN&lt;/span&gt; &lt;span class="mi"&gt;4&lt;/span&gt;
         &lt;span class="k"&gt;THEN&lt;/span&gt; &lt;span class="s1"&gt;'Serializable'&lt;/span&gt;
       &lt;span class="k"&gt;WHEN&lt;/span&gt; &lt;span class="mi"&gt;5&lt;/span&gt;
         &lt;span class="k"&gt;THEN&lt;/span&gt; &lt;span class="s1"&gt;'Snapshot'&lt;/span&gt; &lt;span class="k"&gt;END&lt;/span&gt; &lt;span class="k"&gt;AS&lt;/span&gt; &lt;span class="n"&gt;TRANSACTION_ISOLATION_LEVEL&lt;/span&gt;
&lt;span class="k"&gt;FROM&lt;/span&gt; &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;dm_exec_sessions&lt;/span&gt;
&lt;span class="k"&gt;WHERE&lt;/span&gt; &lt;span class="n"&gt;session_id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;@@&lt;/span&gt;&lt;span class="n"&gt;SPID&lt;/span&gt;

&lt;span class="c1"&gt;-- ReadCommitted&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;创建表，初始化数据：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;CREATE&lt;/span&gt; &lt;span class="k"&gt;TABLE&lt;/span&gt; &lt;span class="n"&gt;foos&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;
  &lt;span class="n"&gt;id&lt;/span&gt;    &lt;span class="nb"&gt;BIGINT&lt;/span&gt;    &lt;span class="k"&gt;NOT&lt;/span&gt; &lt;span class="k"&gt;NULL&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
  &lt;span class="n"&gt;value&lt;/span&gt; &lt;span class="k"&gt;NCHAR&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;NULL&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
  &lt;span class="k"&gt;CONSTRAINT&lt;/span&gt; &lt;span class="n"&gt;pk&lt;/span&gt; &lt;span class="k"&gt;PRIMARY&lt;/span&gt; &lt;span class="k"&gt;KEY&lt;/span&gt; &lt;span class="n"&gt;clustered&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="k"&gt;INSERT&lt;/span&gt; &lt;span class="k"&gt;INTO&lt;/span&gt; &lt;span class="n"&gt;foos&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;value&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;VALUES&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'1'&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'2'&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在 Transaction 1 中发起 Update 操作（INSERT / DELETE 同理），但是并不做 Commit 提交：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;BEGIN&lt;/span&gt; &lt;span class="n"&gt;TRANSACTION&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;INSERT&lt;/span&gt; &lt;span class="k"&gt;INTO&lt;/span&gt; &lt;span class="n"&gt;foos&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;value&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;VALUES&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'3'&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;开启一个新的 Session，发起全表查询和新增 PK 查询操作：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;SELECT&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="k"&gt;FROM&lt;/span&gt; &lt;span class="n"&gt;foos&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;SELECT&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="k"&gt;FROM&lt;/span&gt; &lt;span class="n"&gt;foos&lt;/span&gt; &lt;span class="k"&gt;WHERE&lt;/span&gt; &lt;span class="n"&gt;id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;不出所料，此时查询果然会被 Block 住。&lt;/p&gt;
&lt;h3 id="mvcc"&gt;MVCC&lt;/h3&gt;
&lt;p&gt;并发控制的手段有这些：封锁、时间戳、乐观并发控制、悲观并发控制。
SQL Server 在 2015 后，引入了 MVCC（多版本控制）。
如果最终数据是一致，会允许数据写入，否则其他事务会被阻止写入。
那么 MVCC 引入是否可以解决 Insert 数据的锁问题？
同样，我做了以下测试：&lt;/p&gt;
&lt;p&gt;查询 SQL Server 使用启用 MVCC ALLOW_SNAPSHOT_ISOLATION：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;SELECT&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;snapshot_isolation_state&lt;/span&gt; &lt;span class="k"&gt;FROM&lt;/span&gt; &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;databases&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;使用 T-SQL 启用测试表的 SNAPSHOT_ISOLATION：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;ALTER&lt;/span&gt; &lt;span class="k"&gt;DATABASE&lt;/span&gt; &lt;span class="n"&gt;HJ_Test3D&lt;/span&gt; &lt;span class="k"&gt;SET&lt;/span&gt; &lt;span class="n"&gt;ALLOW_SNAPSHOT_ISOLATION&lt;/span&gt; &lt;span class="k"&gt;ON&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;接着重复上面里面的 Insert 试验，依然被 Block 住。
看来 MVCC 并不能解决 Insert 锁的问题。&lt;/p&gt;
&lt;h3 id="sql-server-2005-zhi-hou-huan-xu-yao-shi-yong-nolock-yao"&gt;SQL Server 2005 之后还需要使用 nolock 么？&lt;/h3&gt;
&lt;p&gt;从官方文档和上文测试可以看到，在 Insert 时候，由于排它锁的存在，
会导致 &lt;code&gt;SELECT ALL&lt;/code&gt; 以及 &lt;code&gt;SELECT&lt;/code&gt; 新插入数据的相关信息被锁住。
在这两种情景下面是需要使用 &lt;code&gt;nolock&lt;/code&gt; 的。&lt;/p&gt;
&lt;p&gt;除此之外，有这么几类场景可以使用 &lt;code&gt;nolock&lt;/code&gt;：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;在 SSIS 查询器中进行数据分析，不需要精准数据&lt;/li&gt;
&lt;li&gt;历史数据进行查询，没有数据更新操作，也不会产生脏数据&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;我们需要思考一下，性能和数据一致性上的权衡上，
我们是否愿意放弃数据一致性而为了提高一丝丝性能？
以及我们有多少场景，会频繁使用 &lt;code&gt;SELECT ALL&lt;/code&gt; 操作而没有查询条件？&lt;/p&gt;
&lt;p&gt;微软官方在 2015 的特性列表里面，明确地指出 &lt;code&gt;nolock&lt;/code&gt; 特性未来会在某个版本被废除：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Specifying NOLOCK or READUNCOMMITTED in the FROM clause of an UPDATE or DELETE statement.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;而改为推荐：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Remove the NOLOCK or READUNCOMMITTED table hints from the FROM clause.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;事实上，我听过不少团队会禁止在生产环境使用不带 WHERE 条件的 SQL。
那在这种模式下，产生相关的问题的几率也就更小了。
如果有很高的并发需求，那需要考虑一下是否需要其他优化策略：比如使用主从分离、
Snapshot 导出、流式分析等技术。&lt;/p&gt;
&lt;h2 id="di-san-ge-wen-ti-mysql-de-dui-ying-xie-fa-shi-shi-yao_1"&gt;第三个问题：MySQL 的对应写法是什么？&lt;/h2&gt;
&lt;p&gt;终于轮到 MySQL 的讨论了。MySQL，InnoDB 天生支持 MVCC，
并且支持 &lt;code&gt;innodb_autoinc_lock_mode&lt;/code&gt; &lt;a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-auto-increment-handling.html"&gt;AUTO_INCREMENT Handling in InnoDB&lt;/a&gt;。
这样可以避免 Insert 操作锁住全局 Select 操作。
只有在同时 Insert 时候，才会被 Block 住。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;innodb_autoinc_lock_mode&lt;/code&gt; 支持几种模式：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;innodb_autoinc_lock_mode = 0 (&amp;ldquo;traditional&amp;rdquo; lock mode)&lt;ul&gt;
&lt;li&gt;涉及auto-increment列的插入语句加的表级AUTO-INC锁，只有插入执行结束后才会释放锁&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;innodb_autoinc_lock_mode = 1 (&amp;ldquo;consecutive&amp;rdquo; lock mode)&lt;ul&gt;
&lt;li&gt;可以事先确定插入行数的语句，分配连续的确定的 auto-increment 值&lt;/li&gt;
&lt;li&gt;对于插入行数不确定的插入语句，仍加表锁&lt;/li&gt;
&lt;li&gt;这种模式下，事务回滚，auto-increment 值不会回滚，换句话说，自增列内容会不连续&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;innodb_autoinc_lock_mode = 2 (&amp;ldquo;interleaved&amp;rdquo; lock mode)&lt;ul&gt;
&lt;li&gt;同一时刻多条 SQL 语句产生交错的 auto-increment 值&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这里也做了相应的测试。首先检查数据库隔离级别和 &lt;code&gt;innodb_autoinc_lock_mode&lt;/code&gt; 模式：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;SELECT&lt;/span&gt; &lt;span class="o"&gt;@@&lt;/span&gt;&lt;span class="k"&gt;global&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;tx_isolation&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;@@&lt;/span&gt;&lt;span class="k"&gt;session&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;tx_isolation&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;@@&lt;/span&gt;&lt;span class="n"&gt;tx_isolation&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;SHOW&lt;/span&gt; &lt;span class="n"&gt;variables&lt;/span&gt; &lt;span class="k"&gt;LIKE&lt;/span&gt; &lt;span class="s1"&gt;'innodb_autoinc_lock_mode'&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;检查后发现都是 Repeatable Read，&lt;code&gt;innodb_autoinc_lock_mode&lt;/code&gt; 模式是 1。
然后创建测试表：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;CREATE&lt;/span&gt; &lt;span class="k"&gt;TABLE&lt;/span&gt; &lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="n"&gt;foos&lt;/span&gt;&lt;span class="o"&gt;`&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;
  &lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;`&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;11&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;unsigned&lt;/span&gt; &lt;span class="k"&gt;NOT&lt;/span&gt; &lt;span class="k"&gt;NULL&lt;/span&gt; &lt;span class="n"&gt;AUTO_INCREMENT&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
  &lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;`&lt;/span&gt; &lt;span class="nb"&gt;varchar&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;20&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;DEFAULT&lt;/span&gt; &lt;span class="k"&gt;NULL&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
  &lt;span class="k"&gt;PRIMARY&lt;/span&gt; &lt;span class="k"&gt;KEY&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;ENGINE&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;InnoDB&lt;/span&gt; &lt;span class="n"&gt;AUTO_INCREMENT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;18&lt;/span&gt; &lt;span class="k"&gt;DEFAULT&lt;/span&gt; &lt;span class="n"&gt;CHARSET&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;utf8&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在 Transaction 1 中 Insert 数据：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;START&lt;/span&gt; &lt;span class="n"&gt;TRANSACTION&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;INSERT&lt;/span&gt; &lt;span class="k"&gt;INTO&lt;/span&gt; &lt;span class="n"&gt;foos&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;VALUES&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ss"&gt;"a"&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在 Transaction 2 中 Select 数据，可以正常查询：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;SELECT&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="k"&gt;FROM&lt;/span&gt;   &lt;span class="n"&gt;foos&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在 Transaction 2 中 Insert 数据，会被 Block 住：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;START&lt;/span&gt; &lt;span class="n"&gt;TRANSACTION&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;INSERT&lt;/span&gt; &lt;span class="k"&gt;INTO&lt;/span&gt; &lt;span class="n"&gt;foos&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;VALUES&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ss"&gt;"a"&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这个测试可以证明 MySQL 可以在 &lt;code&gt;innodb_autoinc_lock_mode&lt;/code&gt;=1 下，
Insert 同时 Query 不会被 Block，
但是在另外一个事务中 Insert 会被 Block。
结论是，由于 &lt;code&gt;innodb_autoinc_lock_mode&lt;/code&gt; 的存在，MySQL 中可以不需要使用 &lt;code&gt;nolock&lt;/code&gt;
关键词进行查询。&lt;/p&gt;
&lt;h2 id="hui-gu-yi-xia"&gt;回顾一下&lt;/h2&gt;
&lt;p&gt;本文着重去回答这么几个问题：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;为什么要用 &lt;code&gt;noloc&lt;/code&gt;？&lt;/li&gt;
&lt;li&gt;为什么要改变隔离级别？&lt;/li&gt;
&lt;li&gt;为什么 MySQL 不需要做类似的事情？&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;虽然只凑足了三个 「为什么」 的排比，
但是聪明的读者仍然会发现，我是使用了著名的
&lt;a href="https://zh.wikipedia.org/wiki/%E4%BA%94%E4%B8%AA%E4%B8%BA%E4%BB%80%E4%B9%88"&gt;五个为什么&lt;/a&gt;
方法思考问题。
通过使用这个方法，我们最后不但打破了老旧的最佳实践，还了解了本质原理，
并找到了新的最佳实践。&lt;/p&gt;
&lt;p&gt;希望读者朋友在遇到困难时候，多问几个为什么，多抱着打破砂锅问到底的精神，
这样才能让每个困难成为我们成长的垫脚石。&lt;/p&gt;
&lt;h2 id="xiang-guan-zi-liao"&gt;相关资料&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://zh.wikipedia.org/zh-cn/%E4%BA%8B%E5%8B%99%E9%9A%94%E9%9B%A2"&gt;事务隔离 - 维基百科，自由的百科全书&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://docs.microsoft.com/en-us/sql/t-sql/queries/hints-transact-sql-table"&gt;Table Hints (Transact-SQL) | Microsoft Docs&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/sql/snapshot-isolation-in-sql-server"&gt;Snapshot Isolation in SQL Server | Microsoft Docs&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-catalog-views/sys-databases-transact-sql"&gt;sys.databases (Transact-SQL) | Microsoft Docs&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-multi-versioning.html"&gt;MySQL :: MySQL 5.7 Reference Manual :: 15.3 InnoDB Multi-Versioning&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;div class="panel"&gt;
&lt;div class="panel-body"&gt;
   &lt;small&gt;原文链接: &lt;a href="https://blog.alswl.com/2017/09/sql-server-nolock/"&gt;https://blog.alswl.com/2017/09/sql-server-nolock/&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;3a1ff193cee606bd1e2ea554a16353ee&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;欢迎关注我的微信公众号：&lt;a href="http://mp.weixin.qq.com/mp/getmasssendmsg?__biz=MzIyNTIwMTU3MQ==#wechat_webview_type=1&amp;wechat_redirect"&gt;窥豹&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/201605/qrcode_for_gh_17e2f9c2caa4_258.jpg"/&gt;&lt;/small&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/meta/wechat-pay-s-crop.png"/&gt;&lt;/small&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="SQL Server"></category><category term="MySQL"></category></entry><entry><title>当我们在聊监控，我们在聊什么？</title><link href="https://blog.alswl.com/2017/06/monitoring-introducing/" rel="alternate"></link><published>2017-06-08T15:40:41+08:00</published><updated>2017-06-08T15:40:41+08:00</updated><author><name>alswl</name></author><id>tag:blog.alswl.com,2017-06-08:2017/06/monitoring-introducing/</id><summary type="html">&lt;p&gt;最近在团队中给大家做了一个分享，泛泛地聊了一些有关「监控」的话题。
其实做分享对分享者的作用往往大于参与者。
这是一次将自己知识的梳理的过程，于是我将这次分享整理成这篇文章。&lt;/p&gt;
&lt;p&gt;&lt;img alt="201706/stock-exchange.png" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201706/stock-exchange.png"/&gt;&lt;/p&gt;

&lt;h2 id="mu-de"&gt;目的 🎯&lt;/h2&gt;
&lt;p&gt;我们先来聊聊，什么是「监控」，以及我们期望通过「监控」完成哪些目的？&lt;/p&gt;
&lt;p&gt;传统意义上的监控，是指：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;通过一些手段和工具，关注运行中的&lt;strong&gt;硬件、软件、用户体验&lt;/strong&gt;的关键数据，将其暴露出来。
  当关键数据出现异常时候发出警告，进行人工或者自动的响应。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;我们平时看到的最常见的监控系统，比如 Zabbix，提供了丰富的模板，
可以监控服务器的 Load / CPU Usage / Alive 这些常规指标。
并在出现问题时候，对其进行报警通知。
随后运维工程师们会上线进行应急操作，case by case 的处理故障。&lt;/p&gt;
&lt;p&gt;我将上面的使用目的归纳为：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;故障发生时提供数据报警&lt;/li&gt;
&lt;li&gt;提供历史数据以供分析&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;故事到这里似乎可以结束了，可监控真的是这么简单的么？
当然没，随着时代的进步，用户对服务提出了更为严苛的要求，
同时我们也有能力进一步控制平均故障修复时间
（&lt;a href="https://en.wikipedia.org/wiki/Mean_time_between_failures"&gt;MTBF&lt;/a&gt;），
上述描述的做法已经不能满足我们了。&lt;/p&gt;
&lt;p&gt;现在让我们切换一下视角，从传统的 OPS 的视角切换到 SRE
（&lt;a href="https://en.wikipedia.org/wiki/Site_reliability_engineering"&gt;Site Reliability Engineering&lt;/a&gt;）的视角。
当我们在关注网站整体的可用性时，我们会发现：
故障警报处理当然很重要，但是我们根本上想减少甚至避免 MTBF。
我们有两种手段：
一种是去除单点故障，让问题自然发生，但是不对线上造成影响；
另一种是在问题出现的早期就发现并进行及时修复。
前者是高可用范畴，后者就是我们今天关注的「监控」了。&lt;/p&gt;
&lt;p&gt;监控的目的是要&lt;strong&gt;将灾难消灭在襁褓里；在灾难即将出现或者发生问题时， 给大家展示直接的原因&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;那为了达成这两个目标，我们需要回到问题的本质，重新思考两个问题：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;监控哪些对象？&lt;/li&gt;
&lt;li&gt;如何识别故障？&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="dui-xiang"&gt;对象 🐘🐘&lt;/h2&gt;
&lt;p&gt;我们说的监控对象，一般指的都是某个资源，
资源即持有某种其他方需要的某些属性的载体，包括硬件、软件。
除了资源这种类型，还有一种常见的监控对象是「体验」，即终端用户的访问感受，
这块内容我们暂时略去。&lt;/p&gt;
&lt;p&gt;让我们来先看一下常见的资源：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;硬件&lt;ul&gt;
&lt;li&gt;服务器&lt;/li&gt;
&lt;li&gt;网络设备&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;软件&lt;ul&gt;
&lt;li&gt;Application&lt;/li&gt;
&lt;li&gt;Infrastructure&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这个分类是粗粒度的描述，为了落地地描述监控对象对象的健康状况，
我们还要进一步细化。以「服务器」为例，我们可以将其监控的内容细化为以下监控项：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;CPU&lt;/li&gt;
&lt;li&gt;Memory&lt;/li&gt;
&lt;li&gt;Network interface&lt;/li&gt;
&lt;li&gt;Storage devices&lt;/li&gt;
&lt;li&gt;Controllers&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;如何评估这些监控项的健康状况？我们使用
&lt;a href="https://en.wikipedia.org/wiki/Service_level_indicator"&gt;SLI（Service Level Indicator）&lt;/a&gt;。
比如&lt;strong&gt;可用性&lt;/strong&gt;就是一个最容易理解的 SLI。
这里我将资源归为两类，面向用户提供服务的资源和面向存储的资源，
以下是针对这两类资源的常见 SLI：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;User-facing Service&lt;ul&gt;
&lt;li&gt;Availability&lt;/li&gt;
&lt;li&gt;Latency&lt;/li&gt;
&lt;li&gt;Throughput&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Storage System&lt;ul&gt;
&lt;li&gt;Latency&lt;/li&gt;
&lt;li&gt;Throughput&lt;/li&gt;
&lt;li&gt;durability&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;基于 SLI 建立的数字关键指标，称之为
&lt;a href="https://en.wikipedia.org/wiki/Service_level_objective"&gt;Service Level Objective&lt;/a&gt;。
SLO 往往是一组数字范围，比如 CPU 负载的 SLO 可以设置为 0.0-6.0（针对 8 核 CPU）。
不同的资源、不同的业务场景，会有不一样的 SLO 设计。&lt;/p&gt;
&lt;p&gt;看到这里，我们已经聊了要监控哪些指标，那么接下来我们聊聊如何用量化的思想，
帮助指标更易于识别、分析和决策。&lt;/p&gt;
&lt;h2 id="liang-hua-de-si-xiang"&gt;量化的思想 🔢&lt;/h2&gt;
&lt;p&gt;刚开始担任线上救火队成员时候，当有个系统出现问题时候，我经常听到这样的描述：
网站挂了、页面打不开了，CPU 出问题了，内存爆了，线程池炸了等等。
这样的表述虽然没错，但带来的可用价值太少，信息熵太低。
这样的说辞多了，就给人产生一种不靠谱，不科学的感觉。&lt;/p&gt;
&lt;p&gt;那怎样才能成为科学的描述？
古希腊哲学家在思考宇宙的时候，提出了一种心智能力，
从而打开了科学的窗子，这就是 Reasonable，中文名叫理智，这成为了自然科学的基石。
使用 Reasonable 探讨意味着探讨要深入问题的本质，不停留在表象，挖掘出真正有价值的内容。&lt;/p&gt;
&lt;p&gt;但是光有 Reasonable 还不够，B站粉丝建了一个微博，每天会检查
&lt;a href="http://weibo.com/yamanasion?refer_flag=1001030201_&amp;amp;is_hot=1"&gt;今天B站炸了吗&lt;/a&gt;，
他只能告诉我们炸没炸，不能给工程师带来实际的用处。
在科学的发展历史上，我们可以发现在亚里士多德的著作里没有任何数据公式。
他对现象只有描述，只是定性分析，通过描述性状来阐述定理。
这个定性的研究方式到了伽利略那里才出现了突破。
这里我们可以引入第二个关键词是  Quantifier，量化。
伽利略率先使用定量分析的方法，并将其运用到动力学和天文学，从而开创了近代科学。&lt;/p&gt;
&lt;p&gt;如果我们以定量的方式来描述网站挂没挂，就会变成：网站的响应耗时在 30s，基本无法使用。
描述线程池出问题，就会变成：active 线程数量是 200，已经到达 maxCount 数量，无法进行分配。
你看，通过这样的描述，我们一下子就能发现问题出在哪里。&lt;/p&gt;
&lt;h2 id="use"&gt;USE 💡&lt;/h2&gt;
&lt;p&gt;现在我们已经了解了「监控哪些对象？」，以及尝试用「量化」这个法宝来「识别故障」。
那有没有一些最佳实践帮助大家高效的识别故障呢？这里我推荐 Brend Gregg 大神的 &lt;a href="http://www.brendangregg.com/usemethod.html"&gt;USE 方法&lt;/a&gt;。
Brend Gregg 是 Netflix 的首席 SRE，著有 &lt;a href="http://www.brendangregg.com/sysperfbook.html"&gt;Systems Performance Book&lt;/a&gt;，
目前已经出版中文版 &lt;a href="https://www.amazon.cn/%E5%9B%BE%E4%B9%A6/dp/B0140I5WPK"&gt;性能之巅:洞悉系统、企业与云计算&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;USE 分别是三个单词的首字母缩写：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Utilization：使用率，CPU running percent，硬盘的 IO &lt;/li&gt;
&lt;li&gt;Saturation：饱和度，一般偏存储型资源，内存使用，硬盘使用&lt;/li&gt;
&lt;li&gt;Error：错误数&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;我们可以为每个资源找到各自的 USE 度量指标，具体的 Check List 清单可以参考
&lt;a href="http://www.brendangregg.com/USEmethod/use-rosetta.html"&gt;USE Method: Rosetta Stone of Performance Checklists&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;这里举个例子，前段时间在设计 MySQL HA 方案时候，同时关注了 MySQL 的监控方案，
那么针对 MySQL，我们要做哪些监控呢？下面是使用 USE 方法设计出来的 SLI：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Business&lt;ul&gt;
&lt;li&gt;Questions：语句计总，Throughput&lt;/li&gt;
&lt;li&gt;Slow_queries：慢查询计总，Error&lt;/li&gt;
&lt;li&gt;Com_select：查询语句计总，Throughput&lt;/li&gt;
&lt;li&gt;Com_insert：插入语句计总，Throughput&lt;/li&gt;
&lt;li&gt;Com_update：更新语句计总，Throughput&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Threads &amp;amp; Connections&lt;ul&gt;
&lt;li&gt;Threads_connected：当前连接数，Utilization&lt;/li&gt;
&lt;li&gt;Threads_running：当前使用中连接数，Utilization&lt;/li&gt;
&lt;li&gt;Aborted_connects：尝试连接失败数，Error&lt;/li&gt;
&lt;li&gt;Connection_errors_max_connections：由于连接数超标从而失败的连接数，Error&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Buffer&lt;ul&gt;
&lt;li&gt;Innodb_buffer_pool_pages_total：内存使用页数，Utilization&lt;/li&gt;
&lt;li&gt;Innodb_buffer_pool_read_requests：读请求数计总，Utilization&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="wan"&gt;完 🏁&lt;/h2&gt;
&lt;p&gt;如果你对我上面描述的还意犹未尽，建议你可以看 &lt;a href="https://book.douban.com/subject/19992841/"&gt;Effective Monitoring and Alerting&lt;/a&gt;。
虽然本书没有中文版，但是关于监控、报警的原理解析很到位，值得一看。
另外还有一本 &lt;a href="https://book.douban.com/subject/26875239/"&gt;SRE: Google运维解密&lt;/a&gt;，
里面有不少篇幅在讲「SLA」，也是和监控、报警息息相关的。&lt;/p&gt;
&lt;p&gt;这次讲了一些概念性的内容，期望对大家有帮助，下一次我再分享一篇文章，聊聊 Metrics。&lt;/p&gt;
&lt;hr&gt;
&lt;div class="panel"&gt;
&lt;div class="panel-body"&gt;
   &lt;small&gt;原文链接: &lt;a href="https://blog.alswl.com/2017/06/monitoring-introducing/"&gt;https://blog.alswl.com/2017/06/monitoring-introducing/&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;3a1ff193cee606bd1e2ea554a16353ee&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;欢迎关注我的微信公众号：&lt;a href="http://mp.weixin.qq.com/mp/getmasssendmsg?__biz=MzIyNTIwMTU3MQ==#wechat_webview_type=1&amp;wechat_redirect"&gt;窥豹&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/201605/qrcode_for_gh_17e2f9c2caa4_258.jpg"/&gt;&lt;/small&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/meta/wechat-pay-s-crop.png"/&gt;&lt;/small&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="Monitoring"></category></entry><entry><title>XSS 攻击的处理</title><link href="https://blog.alswl.com/2017/05/xss/" rel="alternate"></link><published>2017-05-31T22:04:00+08:00</published><updated>2017-05-31T22:04:00+08:00</updated><author><name>alswl</name></author><id>tag:blog.alswl.com,2017-05-31:2017/05/xss/</id><summary type="html">&lt;p&gt;这是一年前写的项目笔记，一直在我的待办事项里等待做总结，今天偶然翻到，就整理成文章发出来。
谨以此文怀念 &lt;a href="http://wooyun.org/"&gt;乌云&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;&lt;img alt="201705/wooyun.jpg" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201705/wooyun.jpg"/&gt;&lt;/p&gt;
&lt;hr/&gt;
&lt;h2 id="shi-qing-yuan-you"&gt;事情缘由&lt;/h2&gt;
&lt;p&gt;春节前的某一天，收到一封来自乌云（国内知名白帽子团队）的邮件，
告知我厂网站上出现一例 XSS 漏洞。
因为以前对 XSS 输入做过防御，还以为是某个前端 DOM 上的 XSS 漏洞，
后来仔细一看，不妙，是个影响甚大的存储型 XSS 漏洞。&lt;/p&gt;
&lt;p&gt;这里简单科普一下 XSS
&lt;a href="https://zh.wikipedia.org/zh-cn/%E8%B7%A8%E7%B6%B2%E7%AB%99%E6%8C%87%E4%BB%A4%E7%A2%BC"&gt;跨网站脚本 -维基百科，自由的百科全书&lt;/a&gt;
中介绍到：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;跨网站脚本（Cross-site  scripting，通常简称为XSS或跨站脚本或跨站脚本攻击）是一种网站应用程序的安全漏洞攻击，是代码注入的一种。
  它允许恶意用户将代码注入到网页上，其他用户在观看网页时就会受到影响。这类攻击通常包含了HTML以及用户端脚本语言。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;XSS 攻击可以分成两种，反射性 XSS / 存储型 XSS。前者是需要用户触发的 XSS，
针对当前用户的攻击行为。而后者存储型 XSS 则更为严重，一旦攻击代码被保存，
所有访问被攻击的页面，都会触发用户被攻击行为。&lt;/p&gt;
&lt;p&gt;这次爆出的问题就是最严重的存储型 XSS，意味着每个访问到有问题页面的用户都会中招。
时间紧迫，问题必须被解决。&lt;/p&gt;
&lt;h2 id="xss-shi-xian-shou-duan"&gt;XSS 实现手段&lt;/h2&gt;
&lt;p&gt;在解决问题之前，需要对这个问题有必要的基础认识。
我们先看看 XSS 攻击是如何工作的，以及攻击者的目的是什么。&lt;/p&gt;
&lt;p&gt;XSS 的原理是通过构造特殊的数据，并通过传递参数或者保存表单数据的方式，
让这些构建的数据破坏 DOM 结构，从而让自己预先构造数据中的 JS 脚本被执行。&lt;/p&gt;
&lt;p&gt;检查存储型 XSS 漏洞的方法，可以在对应的 input field 里放入一些构造的数据，如果保存后可以被执行，就说明存在 XSS 漏洞。&lt;/p&gt;
&lt;p&gt;常见的检测方法（来自&amp;nbsp;&lt;a href="https://zh.wikipedia.org/zh-cn/%E8%B7%A8%E7%B6%B2%E7%AB%99%E6%8C%87%E4%BB%A4%E7%A2%BC#.E6.A3.80.E6.B5.8B.E6.96.B9.E6.B3.95"&gt;跨网站脚本 - 维基百科，自由的百科全书&lt;/a&gt;：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="o"&gt;&amp;gt;&amp;lt;&lt;/span&gt;&lt;span class="nb"&gt;script&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="nx"&gt;alert&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;document.cookie&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nb"&gt;script&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;'&amp;gt;&amp;lt;script&amp;gt;alert(document.cookie)&amp;lt;/script&amp;gt;&lt;/span&gt;
&lt;span class="s1"&gt;"&amp;gt;&amp;lt;script&amp;gt;alert(document.cookie)&amp;lt;/script&amp;gt;&lt;/span&gt;
&lt;span class="s1"&gt;&amp;lt;script&amp;gt;alert(document.cookie)&amp;lt;/script&amp;gt;&lt;/span&gt;
&lt;span class="s1"&gt;&amp;lt;script&amp;gt;alert (vulnerable)&amp;lt;/script&amp;gt;&lt;/span&gt;
&lt;span class="s1"&gt;%3Cscript%3Ealert('&lt;/span&gt;&lt;span class="nx"&gt;XSS&lt;/span&gt;&lt;span class="s1"&gt;')%3C/script%3E&lt;/span&gt;
&lt;span class="s1"&gt;&amp;lt;script&amp;gt;alert('&lt;/span&gt;&lt;span class="nx"&gt;XSS&lt;/span&gt;&lt;span class="s1"&gt;')&amp;lt;/script&amp;gt;&lt;/span&gt;
&lt;span class="s1"&gt;&amp;lt;img src="javascript:alert('&lt;/span&gt;&lt;span class="nx"&gt;XSS&lt;/span&gt;&lt;span class="s1"&gt;')"&amp;gt;&lt;/span&gt;
&lt;span class="s1"&gt;&amp;lt;img src="http://xxx.com/yyy.png" onerror="alert('&lt;/span&gt;&lt;span class="nx"&gt;XSS&lt;/span&gt;&lt;span class="s1"&gt;')"&amp;gt;&lt;/span&gt;
&lt;span class="s1"&gt;（这个仅限IE有效）&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;攻击者通过 XSS 可以窃取用户的相关信息，如果用户是管理员，那么影响更大。
通过这些身份信息，攻击者可以进一步篡改信息或者进行诈骗，后果不堪设想。
PS：一个有效粗暴的方式，是将对公、对内系统的域名分离，对内部系统进行物理级别隔离。&lt;/p&gt;
&lt;h2 id="wo-han-li-shi-shang-de-chu-li-fang-an"&gt;我厂历史上的处理方案&lt;/h2&gt;
&lt;p&gt;XSS 问题又来已久，咱厂子开了这么久，历史上如何防御的呢？
答案是用了两个策略：第一个是使用&amp;nbsp;&lt;a href="https://www.owasp.org/index.php/Main_Page"&gt;OWASP&lt;/a&gt;
提供的库进行内容过滤，第二个是在存储数据时，存储了转义后的数据。&lt;/p&gt;
&lt;p&gt;在技术上处理 XSS，有两种态度可以选择：第一种是前置过滤，即将用户所有数据都进行转义，
在输出时候在前端（模板渲染）层面直接输出。
第二种是用户输入的数据不经过转义就直接存储起来，前端在使用时候保证对数据进行转义。&lt;/p&gt;
&lt;p&gt;我厂历史上使用的方案的前者，优点是在于前端不需要在每个地方转义，
避免某个地方忘记了转义，从而导致漏洞。缺点则是在输出内容到非 Web 客户端时候，比如
APP，需要进行额外的数据处理过程， 否则 HTMLEncode 的内容，在 APP
上面无法正确输出。&lt;/p&gt;
&lt;p&gt;这个处理方案是稳妥的，那么为什么最近又暴露出问题了？
排查之后发现，原来最近有若干个服务迁移到了一个新系统，
而新系统在安全上面没有全局处理，所以爆出了漏洞。&lt;/p&gt;
&lt;h2 id="ben-ci-chu-li-fang-an"&gt;本次处理方案&lt;/h2&gt;
&lt;p&gt;知道了原因，那么可以快速解决问题了。在这次处理过程中，我们讨论了在当前移动平台增长迅速，Web 平台增长缓慢的大势下，能否直接存储用户原始数据？
而且由于规范制定不严格，目前系统内有些地方存储转码后数据，有些地方存储转码前数据。
导致在一些特殊的字符（颜文字）处理上不一致，从而导致在处理 &lt;code&gt;br&lt;/code&gt; / &lt;code&gt;&amp;lt;&lt;/code&gt; 这类特殊字符时，表现不同。&lt;/p&gt;
&lt;p&gt;由于 DB 中有部分数据转义处理，部分数据原文存储，所以先处理输出后敏感信息，在模板层面启用全局
encode。 将有危险的数据转移为在 HTML 文本。&lt;/p&gt;
&lt;p&gt;PS：现代 Web 框架的模板渲染引擎，一般会默认开启 HTMLEncode，而
Freemarker 居然在 2.3.24-rc01 才支持，现在都没有发布，唉&amp;hellip;&amp;hellip;&lt;/p&gt;
&lt;p&gt;处理方案：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;开启全局 HTML 输出 Encode，有一个&amp;nbsp;&lt;a href="http://watchitlater.com/blog/2011/10/default-html-escape-using-freemarker/"&gt;Default HTML-escape using Freemarker&lt;/a&gt;&amp;nbsp;方案，可以默认开启 Html Encode，在这个处理方案中，需要注意有些地方真的需要输出原始 html，需要&amp;nbsp;&lt;code&gt;noescape&lt;/code&gt;&amp;nbsp;特殊处理&lt;/li&gt;
&lt;li&gt;检查所有前端操作，禁止字符串拼接，使用框架支持的模板进行渲染，拖小菊的福，新系统在这块工作完成度一直比较好&lt;/li&gt;
&lt;li&gt;将&amp;nbsp;&lt;a href="https://www.owasp.org/index.php/Main_Page"&gt;OWASP&lt;/a&gt;&amp;nbsp;方案强制开启&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="qi-ta-tips"&gt;其他 Tips&lt;/h2&gt;
&lt;p&gt;OWASP 有一个很长的 &lt;a href="https://www.owasp.org/index.php/SS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet"&gt;列表&lt;/a&gt;，教导如何避免 XSS，里面提到了：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;为何以及如何进行「积极防御」，对立面是仅仅输出时候转义内容本身&lt;/li&gt;
&lt;li&gt;几条对抗 XSS 的规则&lt;ul&gt;
&lt;li&gt;尽量不在特定地方输出不可信变量：script / comment / attribute / tag / style， 因为逃脱 HTMl 规则的字符串太多了。&lt;/li&gt;
&lt;li&gt;将不可信变量输出到 div / body / attribute / javascript tag / style 之前，对&amp;nbsp;&lt;code&gt;&amp;amp; &amp;lt; &amp;gt; " ' /&lt;/code&gt;&amp;nbsp;进行转义&lt;/li&gt;
&lt;li&gt;将不可信变量输出 URL 参数之前，进行 URLEncode&lt;/li&gt;
&lt;li&gt;使用合适的 HTML 过滤库进行过滤&lt;/li&gt;
&lt;li&gt;预防 DOM-based XSS，见&amp;nbsp;&lt;a href="https://www.owasp.org/index.php/DOM_based_XSS_Prevention_Cheat_Sheet"&gt;DOM based XSS Prevention Cheat Sheet&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;开启 HTTPOnly cookie，让浏览器接触不到 cookie&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;hr/&gt;
&lt;p&gt;最后送上一个 XSS 攻击工具&amp;nbsp;&lt;a href="http://webxss.net/"&gt;http://webxss.net/&lt;/a&gt;，知己知彼，百战不殆。&lt;/p&gt;
&lt;hr&gt;
&lt;div class="panel"&gt;
&lt;div class="panel-body"&gt;
   &lt;small&gt;原文链接: &lt;a href="https://blog.alswl.com/2017/05/xss/"&gt;https://blog.alswl.com/2017/05/xss/&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;3a1ff193cee606bd1e2ea554a16353ee&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;欢迎关注我的微信公众号：&lt;a href="http://mp.weixin.qq.com/mp/getmasssendmsg?__biz=MzIyNTIwMTU3MQ==#wechat_webview_type=1&amp;wechat_redirect"&gt;窥豹&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/201605/qrcode_for_gh_17e2f9c2caa4_258.jpg"/&gt;&lt;/small&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/meta/wechat-pay-s-crop.png"/&gt;&lt;/small&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="security"></category></entry><entry><title>👁️ 预测未来？</title><link href="https://blog.alswl.com/2017/01/prophecy/" rel="alternate"></link><published>2017-01-31T11:12:43+08:00</published><updated>2017-01-31T11:12:43+08:00</updated><author><name>alswl</name></author><id>tag:blog.alswl.com,2017-01-31:2017/01/prophecy/</id><summary type="html">&lt;p&gt;&lt;img alt="201702/clock.jpg" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201702/clock.jpg"/&gt;&lt;/p&gt;
&lt;h2 id="la-pu-la-si-zhi-yao"&gt;拉普拉斯之妖&lt;/h2&gt;
&lt;p&gt;未来是可以被预测的么？&lt;/p&gt;
&lt;p&gt;专家在预测股票趋势变化，天气预报员可以预测未来一周甚至更长时间的天气。
如果给他们更多的信息和参数，是否可以将未来预测的更准确？
如果精确的粒度可以达到基本粒子级别，同时给一个计算力超群的计算器，能否精确的推衍未来变化？&lt;/p&gt;

&lt;p&gt;这些想法在我刚接触经典力学时浮现，学习了牛顿三定律之后，异常激动。
感觉人类可以凭借技术的进步，逐步对未来精确预测。彼时可以解决人类即将遇到的任何问题了，化问题于无形。&lt;/p&gt;
&lt;p&gt;这想法其实在 200 年前就出现了。法国伟大的数学家拉普拉斯（Laplace）在他的著作「概率论」里面，
提出了这样的观点：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;我们可以把宇宙现在的状态视为其过去的果以及未来的因。假若一位智者会知道在某一时刻所有促使自然运动的力和所有组构自然的物体的位置，假若他也能够对这些数据进行分析，则在宇宙里，从最大的物体到最小的粒子，它们的运动都包含在一条简单公式里。对于这位智者来说，没有任何事物会是含糊的，并且未来只会像过去般出现在他眼前。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;「根据当前已知即可预测未来」，这种决定论，就是拉普拉斯之妖。&lt;/p&gt;
&lt;h2 id="da-po"&gt;打破&lt;/h2&gt;
&lt;p&gt;除了拉普拉斯的决定论，这个世纪末还发生了另外一件事情。
开尔文男爵在 19 世纪的最后一天，发表了「物理大厦已经落成，所剩只是一些装饰性工作」的言论。
然而，在随后的岁月里，经典物理大厦却开始被量子力学逐步击破，轰然倒地。&lt;/p&gt;
&lt;p&gt;在决定论这个方面，根据海森堡的不确定性理论，粒子的位置与动量不可同时被确定。
这个结论说明目前技术下面，无法精准测量粒子的状态。
既然无法准确测量粒子的状态，就失去了演算未来可能性的基础，更无法预测未来了。&lt;/p&gt;
&lt;p&gt;那既然是无法预测，是否表示，预测未来这件事情是无稽之谈，未来是不成规律的？&lt;/p&gt;
&lt;h2 id="hun-dun-bei-li-jie-cuo-wu-de-hu-die-xiao-ying"&gt;混沌：被理解错误的「蝴蝶效应」&lt;/h2&gt;
&lt;p&gt;针对未来的预测，动力系统中，有相当多的研究和思考，其中比较注明的一项是：蝴蝶效应。&lt;/p&gt;
&lt;p&gt;&lt;img alt="201702/chaos-butterfly.png" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201702/chaos-butterfly_400.png"/&gt;&lt;/p&gt;
&lt;p&gt;关于「蝴蝶效应」，不用过多解释。命名的来源据说是发现者 Edward Lorenz 觉得图形像是蝴蝶。
而有另一种另一说法是，Edward 的一个比喻「巴西蝴蝶煽动，引起德克萨斯的龙卷风」。&lt;/p&gt;
&lt;p&gt;事实上这种说法是不精准的。Edward 在预测天气模型中，发现起始数据的微小差异，
会导致数日之后计算结果的巨大差异。
从点在于在预测模型上，忽略了一个蝴蝶煽动引起的力量，即起始条件的设定，会导致结果的巨大差异。
而不是表名龙卷风是蝴蝶煽动产生的。&lt;/p&gt;
&lt;p&gt;如果蝴蝶煽动能够产生龙卷风。那么一个普通人的呼吸，也可以造成同样的效果。😂&lt;/p&gt;
&lt;h2 id="fen-xing-he-hun-dun"&gt;分形和混沌&lt;/h2&gt;
&lt;p&gt;和混沌相关的，还有一个重要概念「分形」：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;一个粗糙或零碎的几何形状，可以分成数个部分，且每一部分都（至少近似地）是整体缩小后的形状&amp;rdquo;[2]，即具有自相似的性质。分形的核心是自相似。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;随机从这种自相似的图形中提取样本，样本集表现出不可预测的特性。&lt;/p&gt;
&lt;p&gt;混沌的定义：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;非线性系统在一定参数条件下展现分岔（bifurcation）、周期运动与非周期运动相互纠缠，以至于通向某种非周期有序运动。这种运动是不可预测，呈现出失序的状态。三体问题，即是一例混沌的场景。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;为什么混沌和分形是具有相关性的呢？这里有一个重要概念 IFS。
IFS（Iterated Function System）是迭代函数系统，即在数学上被认为一个完全向量空间上收缩映射的有限集。
分形的图案，部分可以抽象出 IFS 公式。&lt;/p&gt;
&lt;p&gt;这个公式的奇妙之处是在于，在公式渐进推算过程之中，初始看到的结果是混沌无序的，而在逐步运算之后，可以看出分形的特征。&lt;/p&gt;
&lt;p&gt;下图是根据一个 IFS 公式，逐步构造出一个分形图片的过程：&lt;/p&gt;
&lt;p&gt;&lt;img alt="201702/chaosgame.gif" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201702/chaosgame.gif"/&gt;&lt;/p&gt;
&lt;p&gt;图片来自 Wikipedia &lt;a href="https://en.wikipedia.org/wiki/Iterated_function_system"&gt;https://en.wikipedia.org/wiki/Iterated_function_system&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;这种由初期混沌，逐渐表现为分形的情况，被学者总结为：「混沌在（生成）时间上是分形的；而分形的在空间（展示）上是混沌的。」
混沌中可以找到有序，在非线性中找到理性，混沌中可以演化出非规则，也可以演化出在规则中混沌。&lt;/p&gt;
&lt;h2 id="zhe-xue-shang-de-xiang-zheng"&gt;哲学上的象征&lt;/h2&gt;
&lt;p&gt;感谢你迷迷糊糊的读到这里，混沌不仅仅在数学和物理上面，吸引着一代代人的探索。
在哲学生活指导方面，也有重大的意义。早在古人说「分久必合，合久必分」，
就是一种稳定线性的表现，具有预测性的表现。
而「一生二、二生三，三生万物」则体现了古人对分形的理解。
经典的「马蹄毁了一场战争」故事，讲的是混沌理论。&lt;/p&gt;
&lt;p&gt;这些对未来预测能力的渴望，表现了对生活的掌控欲望，对未来可行性的探索，
在低谷期可以带来希望，大跃进时期可以带来警醒。&lt;/p&gt;
&lt;hr/&gt;
&lt;p&gt;对于我个人而言，虽然失去了能够预测未来的理论基础而略感遗憾。
但是反过来想想，如果真的发明了一台机器，能够精确预言到未来，
那么在发明实现的当天，就能够推衍出未来所有出现的科学理论、文学、艺术创作，
那给后人创造了一个多么再无新事物的未来，这该是一个多么无趣的世界啊。&lt;/p&gt;
&lt;hr&gt;
&lt;div class="panel"&gt;
&lt;div class="panel-body"&gt;
   &lt;small&gt;原文链接: &lt;a href="https://blog.alswl.com/2017/01/prophecy/"&gt;https://blog.alswl.com/2017/01/prophecy/&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;3a1ff193cee606bd1e2ea554a16353ee&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;欢迎关注我的微信公众号：&lt;a href="http://mp.weixin.qq.com/mp/getmasssendmsg?__biz=MzIyNTIwMTU3MQ==#wechat_webview_type=1&amp;wechat_redirect"&gt;窥豹&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/201605/qrcode_for_gh_17e2f9c2caa4_258.jpg"/&gt;&lt;/small&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/meta/wechat-pay-s-crop.png"/&gt;&lt;/small&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="Math"></category></entry><entry><title>👷如何做年前大扫除</title><link href="https://blog.alswl.com/2017/01/spring-cleaning/" rel="alternate"></link><published>2017-01-03T23:20:50+08:00</published><updated>2017-01-03T23:20:50+08:00</updated><author><name>alswl</name></author><id>tag:blog.alswl.com,2017-01-03:2017/01/spring-cleaning/</id><summary type="html">&lt;p&gt;今年过年特别早，离春节只剩下二十多天了。
为期 7 天的春节里，工程师们不上班，那万一线上业务出现了故障怎么办？
大公司的朋友们会安排专门的人进行值班（此处心疼一下那些需要大年三十还要值班保证高峰的工程师们），
而作为创业团队人少，难做到在线值守，就需要对线上进行一些整理盘点，找出潜在问题，为春节长假做一些准备。&lt;/p&gt;
&lt;p&gt;我们称之为年前大扫除。&lt;/p&gt;
&lt;p&gt;大扫除需要做些什么呢，且听我一一道来。&lt;/p&gt;
&lt;p&gt;&lt;img alt="201701/saber.jpeg" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201701/saber.jpeg"/&gt;&lt;/p&gt;
&lt;p&gt;PS: 冷知识，大扫除英文是 spring cleaning，所以春节大扫除是 Spring Festival spring cleaning。&lt;/p&gt;
&lt;h2 id="da-sao-chu-de-nei-rong"&gt;大扫除的内容&lt;/h2&gt;
&lt;p&gt;大扫除其实是一个查漏补缺+囤积粮草的事情。&lt;/p&gt;
&lt;p&gt;查漏补缺，即找出潜在的问题。这些问题平时可能不会特意去查看，
借助大扫除这个运动，恰好进行盘点。
计算机的世界里，有一个方法论非常好使，在极多场景可以见到其身影：分层。
TCP 的七层模型，架构设计的 N 层 模型，都是对分层思想的使用。
查漏补缺也不例外，我们可以按照业务访问流程，将需要排查的问题拆分为：业务、应用、中间件、网络、物理、存储 etc。&lt;/p&gt;
&lt;p&gt;通过分层，不仅仅完成了自上而下地遍历整个技术栈，也同时将不同模块的内容交给不同的责任方，
确保任务的分割。&lt;/p&gt;
&lt;p&gt;分完模块，还要告知大家如何具体查找问题。
这里我介绍一个通用的方法：USE&lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1" rel="footnote"&gt;1&lt;/a&gt;&lt;/sup&gt;：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;For every resource, check Utilization, Saturation, and Errors.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;USE 方法是从 Brend Gregg 那里学来的。
在技术设施的领域里，Resource 即是指各种类型的资源，比如 CPU、磁盘、网络、内存，
Utilization 指的是使用率，可以简单分为百分制和非百分制。
Saturation 是指饱和率，支持 queue 的资源，就会有这个指标。
Error 即错误，可以从错误统计和日志得知。&lt;sup id="fnref:2"&gt;&lt;a class="footnote-ref" href="#fn:2" rel="footnote"&gt;2&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;p&gt;业务领域里面，USE 也有相对应的含义。以审核系统举例，
对应的 USE 可以理解为「审核应用实例跑的 CPU 占用如何，任务队列是否塞满，业务日志是否有异常」。&lt;/p&gt;
&lt;p&gt;除了 USE 里面提到的指标，还有几个指标特别重要：
TPS 、Latency 和 Capacity。
这几个指标对性能敏感的尤为重要。
检查 USE 的同时，我们必须关注一下这三个指标，
确保 TPS / Latency 是否满足我们预期的 SLA。
哦？压根没有制定 SLA，不要慌，和历史数据对比，先制定一个粗糙的 SLA。
哦？连历史数据都没有？那只能找你 Leader 让他考量一下了。&lt;/p&gt;
&lt;p&gt;负责每个子系统的同学，记得检查时候将这些收集到的数据列下来。
在 Metric 做的还不够完善时候，这些数据也是很宝贵的。&lt;/p&gt;
&lt;p&gt;在我看来，检查 USE / TPS / Latency ，&lt;strong&gt;&lt;strong&gt;最大的作用是将抽象的可用性指标描述为几个易于理解的数值进行量化。
一旦能够量化，就可以对比、观测、监控，并且 Review 起来也异常轻松&lt;/strong&gt;&lt;/strong&gt;。&lt;/p&gt;
&lt;h2 id="ying-dui-fang-an"&gt;应对方案&lt;/h2&gt;
&lt;p&gt;检查出问题之后，就要考虑应对了。时间急任务多，我们的应对方案是是囤积粮草 / 写救命笔记。&lt;/p&gt;
&lt;p&gt;囤积粮草比较好理解，&lt;strong&gt;&lt;strong&gt;基于已有的容量预估，为容易出问题的系统提供一份冗余&lt;/strong&gt;&lt;/strong&gt;。
有些团队平时做基础设施就比较，做 Scale 就是小轻松。
那平时 Scalable 做的不好的朋友，就只能将应用实例多开一些，以避免临时出现的流量波动。&lt;/p&gt;
&lt;p&gt;无状态的服务好搞，有状态的 DB 就很难在短时间内做 Scale。
检查这些服务的容量，如果重点资源临近阈值，比如 DB 的硬盘资源，缓存的内存容量。
核心服务的余量在检查中真的发现问题的话，那也只能短期内做扩容了。&lt;/p&gt;
&lt;p&gt;对于小团队来说，春节长假的特殊性在于响应会变慢甚至是联系不上。
一旦线上有异常，可能找不到合适的人员来进行处理。
所以第二条写救命笔记则更为重要。
「Google SRE」里面有个小段子，一个绝对不能被按的按钮，
这个按钮会清空内存数据，在飞行过程中被宇航员按了。幸亏美女工程师（下图）写了相关的救命手册，
专门写了针对这种情况的操作，救了这些宇航员的命。&lt;/p&gt;
&lt;p&gt;&lt;img alt="201701/sre.jpeg" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201701/sre.jpeg"/&gt;&lt;/p&gt;
&lt;p&gt;图片来自 「Google SRE」&lt;/p&gt;
&lt;p&gt;从这个故事里面可以看到，一个紧急操作手册是多么重要。
&lt;strong&gt;&lt;strong&gt;所以在大扫除期间，我们还要补一补平时的文档，将一些常见问题 / 常规操作记录下来。&lt;/strong&gt;&lt;/strong&gt;
步骤需要细致到能让让每个远程值班的同学做到 step by step 操作。&lt;/p&gt;
&lt;hr/&gt;
&lt;p&gt;啰嗦了这么多，相信大家对大扫除要做些什么已经有所印象了，祝大家过个好年，流量涨涨涨，还能平平安安的。&lt;/p&gt;
&lt;div class="footnote"&gt;
&lt;hr/&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;[The USE Method] &lt;a href="http://www.brendangregg.com/usemethod.html"&gt;http://www.brendangregg.com/usemethod.html&lt;/a&gt;&amp;nbsp;&lt;a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text"&gt;↩&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:2"&gt;
&lt;p&gt;[USE Method: Linux Performance Checklist] &lt;a href="http://www.brendangregg.com/USEmethod/use-linux.html"&gt;http://www.brendangregg.com/USEmethod/use-linux.html&lt;/a&gt;&amp;nbsp;&lt;a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text"&gt;↩&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;hr&gt;
&lt;div class="panel"&gt;
&lt;div class="panel-body"&gt;
   &lt;small&gt;原文链接: &lt;a href="https://blog.alswl.com/2017/01/spring-cleaning/"&gt;https://blog.alswl.com/2017/01/spring-cleaning/&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;3a1ff193cee606bd1e2ea554a16353ee&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;欢迎关注我的微信公众号：&lt;a href="http://mp.weixin.qq.com/mp/getmasssendmsg?__biz=MzIyNTIwMTU3MQ==#wechat_webview_type=1&amp;wechat_redirect"&gt;窥豹&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/201605/qrcode_for_gh_17e2f9c2caa4_258.jpg"/&gt;&lt;/small&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/meta/wechat-pay-s-crop.png"/&gt;&lt;/small&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="Infrastructure"></category><category term="DevOps"></category></entry><entry><title>🔑 也谈 HTTPS - 如何内测</title><link href="https://blog.alswl.com/2016/12/https-2/" rel="alternate"></link><published>2016-12-08T20:16:26+08:00</published><updated>2016-12-08T20:16:26+08:00</updated><author><name>alswl</name></author><id>tag:blog.alswl.com,2016-12-08:2016/12/https-2/</id><summary type="html">&lt;p&gt;&lt;img alt="201612/mouse.jpeg" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201612/mouse.jpeg"/&gt;
(图片来自 &lt;a href="https://www.duitang.com/blog/?id=48013745"&gt;茶杯中的可爱小白鼠 壁纸 - 2560x1920－堆糖，美好生活研究所&lt;/a&gt;)&lt;/p&gt;
&lt;p&gt;在上篇文章 &lt;a href="https://blog.alswl.com/2016/11/https-1/"&gt;🔒 也谈 HTTPS - HTTPDNS + HTTPS&lt;/a&gt; 中，
我们谈了如何基于 HTTPDNS 来部署无坚不摧的 HTTPS 通信环境，
这次我们讨论另外一个比较头疼的问题：部署。&lt;/p&gt;

&lt;p&gt;小站点部署 HTTPS 相对成本低，改改前端代码，就可以上线了。
但作为业务有一定复杂度的大网站，就没办法这么暴力上线了。&lt;/p&gt;
&lt;p&gt;前端在基础库中调整 Scheme 之后，仍然可能存在很多边边角角没有覆盖到。
比如 JS 里面写死了 HTTP，那在 HTTPS 下请求 HTTP XHR 的话，
浏览器会将请求拦截掉。
一旦出现这种故障，用户就无法正常使用业务，小白用户往往也不懂得自己将 &lt;code&gt;https://&lt;/code&gt; 换成 &lt;code&gt;http://&lt;/code&gt; 使用。&lt;/p&gt;
&lt;p&gt;解决的思路是足够的内测，找一群人帮我在 HTTPS 环境下使用足够长时间。
让他们当小白鼠，提前发现问题并解决。
于是，我把目光转向了身边的一大大群小白鼠，整个办公室的同事~😄&lt;/p&gt;
&lt;p&gt;没错，&lt;strong&gt;&lt;strong&gt;我要强制所有同事使用 HTTPS 的公司网站&lt;/strong&gt;&lt;/strong&gt;，从而靠他们帮我发现问题。&lt;/p&gt;
&lt;p&gt;靠发邮件、QQ 广播呼吁大家使用 HTTPS 站点的方法，估计是不行的。
没有利益驱动，推动力是不足的，我必须想点强制的手段让他们使用 HTTPS。&lt;/p&gt;
&lt;p&gt;有三种方法来达到这个效果：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;业务系统内入口判断用户身份，是雇员的话，切换到 HTTPS&lt;/li&gt;
&lt;li&gt;Nginx 入口系统判断 IP 来源，办公室 IP 则切换到 HTTPS&lt;/li&gt;
&lt;li&gt;改造办公室网络，访问站点时候，自动切换到 HTTPS&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;为了避免对线上业务系统、基础设施造成影响，我采用了第三条方案。&lt;/p&gt;
&lt;p&gt;说干就干，直接对公司网络出口设备是 ROS&lt;a href="http://wiki.mikrotik.com/wiki/Main_Page"&gt;via&lt;/a&gt; 动起刀子。&lt;/p&gt;
&lt;p&gt;实现的原理如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;A：办公室网络的 🐁 们请求站点 http://www.duitang.com&lt;/li&gt;
&lt;li&gt;B：操作 RouterOS 的防火墙，将 dst 为 www.duitang.com IP 的 TCP 请求都 dst-nat 到新的一台 Nginx 服务器 proxy.duitang.com&lt;/li&gt;
&lt;li&gt;C：这台 proxy.duitang.com 做过特别定制，将所有针对 *.duitang.com 请做一次 302 请求，将 http://www.duitang.com 请求都转发到 https://www.duitang.com&lt;/li&gt;
&lt;li&gt;D：Client 收到 302 请求，重新请求 https://www.duitang.com&lt;/li&gt;
&lt;li&gt;E：同 B&lt;/li&gt;
&lt;li&gt;F：proxy.duitang.com 将请求转发到真正的 www.duitang.com 服务器&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;PS：这里要小心的是，需要配置 proxy.duitang.com 的 &lt;code&gt;resolver&lt;/code&gt; 避免 Nginx 内部请求。&lt;/p&gt;
&lt;p&gt;流程图：&lt;/p&gt;
&lt;p&gt;&lt;img alt="201612/https_ros_process.jpg" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201612/https_ros_process.jpg"/&gt;&lt;/p&gt;
&lt;p&gt;这样操作之后，在办公室网络下，所有访问公司网站的 HTTP 流量都会跳转到 HTTPS。&lt;/p&gt;
&lt;p&gt;PS：我原始方案想使用 ROS 的 L7 防火墙 直接抓 HTTP 包，match HTTP 头数据，
再修改返回的 TCP 包。
但测试下来发现 ROS L7 Firewall 不支持写 TCP 数据。
所以我最后只能使用中间跳转的方案。&lt;/p&gt;
&lt;p&gt;如果不是使用 ROS 的朋友也不用担心，原理和流程已经讲清楚了，
无非是使用 Cisco / Huawei 网络设备的防火墙命令实现需要的功能。&lt;/p&gt;
&lt;hr/&gt;
&lt;p&gt;上篇文章发完之后，好几个朋友问我 IP 证书供应商的事情。我就简单说一下我了解的情况。&lt;/p&gt;
&lt;p&gt;国内 SSL 证书供应商们会给他们兜售的产品起各种各样花里胡哨的名字，
什么超真、超强、超安、超快，国外有些企业也会搞什么 Pro / Super / Premium / Essential，
其实 SSL 证书的区分，笼统来说就三种类型：DV / OV / EV，
Domain Validation / Orgnization Validation / Extented Validation。
他们区别除了字面意思，就是所有权审核流程一个比一个麻烦。&lt;/p&gt;
&lt;p&gt;想基于 IP 直接搞所有权审核，要看对应供应商的证书是否支持。
去年年底我做了一个调查，支持 IP 证书的厂家如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Rapid SSL 不支持 ip&lt;/li&gt;
&lt;li&gt;wosign OV 级别支持&lt;ul&gt;
&lt;li&gt;OV 需要验证 需要验证申请单位的营业执照、等其他证明文件&lt;/li&gt;
&lt;li&gt;浏览器支持情况&lt;ul&gt;
&lt;li&gt;Firefox 32 &lt;a href="https://mozillacaprogram.secure.force.com/CA/IncludedCACertificateReport"&gt;https://mozillacaprogram.secure.force.com/CA/IncludedCACertificateReport&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;交叉认证了 Startcom 的证书，可以支持老版本&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;GlobalSign OV 支持&lt;ul&gt;
&lt;li&gt;$349 * 6 * 8 = 16752&lt;/li&gt;
&lt;li&gt;&lt;a href="https://support.globalsign.com/customer/portal/articles/1216536-securing-a-public-ip-address---ssl-certificates"&gt;https://support.globalsign.com/customer/portal/articles/1216536-securing-a-public-ip-address---ssl-certificates&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;需要认证 RIPE ip， &lt;a href="https://apps.db.ripe.net/search/query.html?searchtext=221.228.82.178#resultsAnchor"&gt;https://apps.db.ripe.net/search/query.html?searchtext=221.228.82.178#resultsAnchor&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Geotrust 明确表示不支持 https://www.geocerts.com/faq#Q47&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;现在 Wosign 爆了丑闻，于是支持 IP SSL 又少了一家。
只剩下 GlobalSign 了，但是 GlobalSign OV 又贵审核又麻烦，
不知道看到此文的大神们有没有更好的推荐。&lt;/p&gt;
&lt;hr/&gt;
&lt;p&gt;参考链接：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="http://serverfault.com/questions/193775/ssl-certificate-for-a-public-ip-address"&gt;domain name - SSL certificate for a public IP address? - Server Fault&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://wiki.mikrotik.com/wiki/Manual:IP/Firewall/Filter"&gt;ROS Filter&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://wiki.mikrotik.com/wiki/Manual:IP/Firewall/NAT"&gt;ROS NAT&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://wiki.mikrotik.com/wiki/Manual:IP/Firewall/L7"&gt;ROS Firewall L7&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://forum.mikrotik.com/viewtopic.php?f=13&amp;amp;t=62152"&gt;How to block and redirect website - MikroTik RouterOS&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://forum.mikrotik.com/viewtopic.php?t=39837"&gt;Mikrotik IP REDIRECT using firewall - MikroTik RouterOS&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://forum.mikrotik.com/viewtopic.php?t=88049"&gt;Redirect all traffic from a spesific ip number to a web page - MikroTik RouterOS&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;div class="panel"&gt;
&lt;div class="panel-body"&gt;
   &lt;small&gt;原文链接: &lt;a href="https://blog.alswl.com/2016/12/https-2/"&gt;https://blog.alswl.com/2016/12/https-2/&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;3a1ff193cee606bd1e2ea554a16353ee&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;欢迎关注我的微信公众号：&lt;a href="http://mp.weixin.qq.com/mp/getmasssendmsg?__biz=MzIyNTIwMTU3MQ==#wechat_webview_type=1&amp;wechat_redirect"&gt;窥豹&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/201605/qrcode_for_gh_17e2f9c2caa4_258.jpg"/&gt;&lt;/small&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/meta/wechat-pay-s-crop.png"/&gt;&lt;/small&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="HTTPS"></category><category term="HTTPDNS"></category><category term="MikroTik"></category></entry><entry><title>教你在上海挑房子</title><link href="https://blog.alswl.com/2016/12/house/" rel="alternate"></link><published>2016-12-05T21:29:37+08:00</published><updated>2016-12-05T21:29:37+08:00</updated><author><name>alswl</name></author><id>tag:blog.alswl.com,2016-12-05:2016/12/house/</id><summary type="html">&lt;p&gt;&lt;img alt="201612/shanghai.jpg" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201612/shanghai.jpg"/&gt;&lt;/p&gt;
&lt;p&gt;点开的同学别失望，这并不是教你如何快速致富的 😂 &amp;hellip;&amp;hellip;&lt;/p&gt;
&lt;hr/&gt;
&lt;p&gt;上海政府在 11-28 出了房屋新政 &lt;a href="http://sh.xinhuanet.com/2016-11/28/c_135864791.htm"&gt;via&lt;/a&gt;，对房价进行进一步调控。
其核心思想是「认房又认贷」。3 月份的政策 &lt;a href="http://www.shanghai.gov.cn/nw2/nw2314/nw2319/nw10800/nw11408/nw39426/u26aw46965.html"&gt;via&lt;/a&gt; 是限制购房资格。
这次 11 月份调整则是提高二套房首付比例。
双管齐下，进一步给上海房市进行降温。&lt;/p&gt;
&lt;p&gt;在这种严苛的政策下面，如何挑选一套自己满意，家人住得安心的房子就尤为关键了。
我对房市一直比较关注，也曾有几位朋友咨询我的一些经验。之前我是将 Evernote
笔记链接贴给别人，这次我就详细讲讲，如何在上海挑房子。&lt;/p&gt;
&lt;p&gt;第一步，&lt;strong&gt;&lt;strong&gt;是建立有价值的 Indicator，并对具体房源进行计算&lt;/strong&gt;&lt;/strong&gt;。
Indicator 的含义是建立一系列评价指标，比如价格、户型、位置，
再根据这些 Indicator 给房源进行打分。
如果我是一个购房者，我挺希望我的置业顾问告诉我这套房有哪些优点、缺点，综合评价得几份。
（当然实际情况下这些置业顾问都是吹得天花乱坠，尽睁眼说瞎话。）
看房的过程可能长达数月，而人的记忆会随着时间逐步失真，只对最近看到的事物有深刻印象。
使用客观的数字评价房源，则可以进行精准的评价，避免产生主观臆断。&lt;/p&gt;

&lt;p&gt;我使用的 Indicator 和评价细项罗列如下，供参考：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;价格&lt;/li&gt;
&lt;li&gt;面积&lt;/li&gt;
&lt;li&gt;地理位置：内环、中环、外环&lt;/li&gt;
&lt;li&gt;交通：离地铁距离，换乘便利性；多地铁线换乘；&lt;/li&gt;
&lt;li&gt;户型：南北通透；客厅朝南；全明；户型方正；无暗室&lt;/li&gt;
&lt;li&gt;装修：毛胚；简装；普通；精装；豪装&lt;/li&gt;
&lt;li&gt;商圈：购物中心；超市；菜场&lt;/li&gt;
&lt;li&gt;学区房&lt;/li&gt;
&lt;li&gt;产权：满五唯一&lt;/li&gt;
&lt;li&gt;楼层&lt;/li&gt;
&lt;li&gt;房龄：5 / 10 / 15 / 20&lt;/li&gt;
&lt;li&gt;政策发展前景&lt;/li&gt;
&lt;li&gt;停车&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;第二步，&lt;strong&gt;&lt;strong&gt;就是和家人达成一致的期望&lt;/strong&gt;&lt;/strong&gt;，避免潜在的纠纷。
每个人对未来的住房有自己的期望，即便是一家人，
各自看中的点也不会太一样。不管平时家庭决策是什么流程，我都建议坐下来一起讨论讨论。
将 Indicator 依次列出，大家讨论各自心中的优先级。&lt;/p&gt;
&lt;p&gt;除了优先级的讨论，还要考虑一下各自对 Indicator 划分等级的理解。
比如对房型、装修这两项，评价标准就会很模糊，这一切都需要讨论清楚。&lt;/p&gt;
&lt;p&gt;我个人最为看中价格、位置、交通，可以放弃的有学区房、停车、户型。&lt;/p&gt;
&lt;p&gt;第三步，&lt;strong&gt;&lt;strong&gt;划定圈子，判断趋势&lt;/strong&gt;&lt;/strong&gt;。
众多 Indicator 里面，价格是固定的，户型、楼层等是和具体房源相关的，
我们能够撬动的最重要因素，其实就是位置。&lt;/p&gt;
&lt;p&gt;作为上海这个拥有 2500w 人口的超大型城市，是不可能把各个位置的房源都扫一遍的，
所以必须重点规划自己准备实地考察的区域。
那么我们就在上海地图上面划几个圈了，数据可以通过链家、中原地产等多网站收集。
安居客有一个大颗粒度的圈子，展示了社区集中点 &lt;a href="http://shanghai.anjuke.com/"&gt;via&lt;/a&gt;，
下图是我筛选条件之后形成的几个簇：&lt;/p&gt;
&lt;p&gt;&lt;img alt="201612/map_thumb.png" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201612/map_thumb.png"/&gt;&lt;/p&gt;
&lt;p&gt;（数据爬取分析这一块，我只服一个人，他专门写了一堆爬虫捞数据然后分析，
如果对杭州的房地产投资感兴趣，可以私信我，我可以帮忙问问。）&lt;/p&gt;
&lt;p&gt;从城市级别来看，其实不同区域的变化趋势基本是一致的，但是局部地区可能受外部因素而出现较大波动。
比如上海闸北并入静安，价格就大涨；大宁板块产生一个地王，也会让这片区域价格大幅波动；
甚至新开业一个 Mall，都会让周边价格波动。
这些外部因素，必须提前关注政府市政规划方案、房产网站、公众号、房产微博。
政策相关推荐阅读：「上海市城市总体规划（2015-2040）纲要概要」 
&lt;a href="http://2040.shgtj.net/web/"&gt;via&lt;/a&gt; 规划了整体发展格调。
「上海市商业网点布局规划（2013-2020）」&lt;a href="http://www.scofcom.gov.cn/zxxxgk/235081.htm"&gt;via&lt;/a&gt; 规划了 14 个市级商圈，之前只有 10 个，还有若干区级商圈。 &lt;/p&gt;
&lt;p&gt;第四步，&lt;strong&gt;&lt;strong&gt;快速行动，快速决策&lt;/strong&gt;&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;还记得捡西瓜的故事么，小猴子一直想找个大西瓜，但一路看过去最后什么都没捡到。
看房不仅仅是一个体力活，而且非常讲究时效性的，必须能够快速响应，快速决策。
在上海这中刚需强需求旺盛的城市，一套评价都不错的房源，半天内就会被别人拿下。
所以前期观察一段时间之后，必须摸清楚自己的需求和承受能力，遇到合适的房源，
就速战速决。&lt;/p&gt;
&lt;p&gt;速战速决还依赖实地看房源的效率。
从我的经验来看，一天至多可以看 10 套左右的房源。
出发前一天约好中介、房东，列一个清单，时间、地点、联系方式全部罗列下来，第二天依照清单行动。
另外为了提高速度，全程应该打车，对于上海这样的一线城市，出租车费用和房产价格相比，真的是小钱。&lt;/p&gt;
&lt;p&gt;在看中合适的房源之后，有些人可能面对这笔巨额交易摇摆不定，而错失了良机。
收益于 Indicator + 前期数据准备，我们在看房时候应该具有了客观的评价能力。
一旦各方面满意，不要犹豫，快速决策。
但也不要因为几次擦肩而过就冲动决策，要相信客观的 Indicator 数据。&lt;/p&gt;
&lt;p&gt;我推荐上班族看房时间安排是，频繁看房两个月，每周末两天出动。
前期一个月看房，不管看中多中意的，都不做决策，
但要计算出一个自己心理预期。一个月后，看到合适的立刻上手。&lt;/p&gt;
&lt;hr/&gt;
&lt;p&gt;OK 写完了。回顾其实这四个步骤，其实就是选一个开源软件的流程嘛。
设定特性需求 -&amp;gt; 设定期望 -&amp;gt; 调研候选者 -&amp;gt; 快速测试上线。
嚯嚯嚯。&lt;/p&gt;
&lt;p&gt;最后，如果你恰好在看房，希望你看完本文有些收获，收获自己中意的住房。&lt;/p&gt;
&lt;hr&gt;
&lt;div class="panel"&gt;
&lt;div class="panel-body"&gt;
   &lt;small&gt;原文链接: &lt;a href="https://blog.alswl.com/2016/12/house/"&gt;https://blog.alswl.com/2016/12/house/&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;3a1ff193cee606bd1e2ea554a16353ee&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;欢迎关注我的微信公众号：&lt;a href="http://mp.weixin.qq.com/mp/getmasssendmsg?__biz=MzIyNTIwMTU3MQ==#wechat_webview_type=1&amp;wechat_redirect"&gt;窥豹&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/201605/qrcode_for_gh_17e2f9c2caa4_258.jpg"/&gt;&lt;/small&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/meta/wechat-pay-s-crop.png"/&gt;&lt;/small&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="Shanghai"></category></entry><entry><title>🔒 也谈 HTTPS - HTTPDNS + HTTPS</title><link href="https://blog.alswl.com/2016/11/https-1/" rel="alternate"></link><published>2016-11-30T22:02:23+08:00</published><updated>2016-11-30T22:02:23+08:00</updated><author><name>alswl</name></author><id>tag:blog.alswl.com,2016-11-30:2016/11/https-1/</id><summary type="html">&lt;p&gt;最近谈论 HTTPS 的文章很多，其原因之一是运营商作恶底线越来越低，动不动就插播广告，
前两天小米还联合几家公司发文 &lt;a href="http://weibo.com/1771925961/Da1aopxLQ?refer_flag=1001030103_&amp;amp;type=comment#_rnd1480392491936"&gt;关于抵制流量劫持等违法行为的联合声明&lt;/a&gt; 痛斥某些运营商。
另一方面也是苹果 &lt;a href="https://techcrunch.com/2016/06/14/apple-will-require-https-connections-for-ios-apps-by-the-end-of-2016/"&gt;ATS&lt;/a&gt; 政策的大力推动，逼迫大家在 APP 中全部使用 HTTPS 通信。
上 HTTPS 的好处很多：保护用户的数据不外泄，避免中间人篡改数据，
对企业信息进行鉴权。&lt;/p&gt;
&lt;p&gt;&lt;img alt="201611/https.png" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201611/https.png"/&gt;&lt;/p&gt;
&lt;p&gt;关于 HTTPS 如何购买证书，如何部署，网上的教程已经太多了，实践起来没有太大的难处。
我们在部署 HTTPS 的时候，遇到了一些新问题，首当其冲的就是 HTTPS 部分网络不可访问的问题：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;尽管使用了 HTTPS 技术，部分邪恶的运营商，仍然使用 DNS 污染技术，让域名指向的他们自己服务器
  而这些服务器并没有部署 SSL 服务（就算部署了，也会触发 SSL 证书 Common name 不一致报警），
  导致 443 端口直接被拒绝。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;这个问题不解决，强行上 HTTPS 的话，会导致一部分用户出现无法访问网站
一旦用户不爽了，轻则对产品不信任，重则直接导致用户流失。&lt;/p&gt;
&lt;p&gt;运营商为了赚广告钱、省网间结算是不择手段的。
他们普遍使用的劫持手段是通过 ISP提供的 DNS 伪造域名。
那有没有什么方法可以解决 DNS 劫持呢？
业界有一套解决这类场景的方案，即 HTTPDNS。&lt;/p&gt;
&lt;p&gt;HTTPDNS 的原理很简单，将 DNS 这种容易被劫持的协议，转为使用 HTTP 协议请求 Domain &amp;lt;-&amp;gt; IP 映射。
获得正确 IP 之后，Client 自己组装 HTTP 协议，从而避免 ISP 篡改数据。&lt;/p&gt;
&lt;p&gt;有两篇文章很清晰的讲解了 HTTPDNS 的细节：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="http://mp.weixin.qq.com/s?__biz=MzA3ODgyNzcwMw==&amp;amp;mid=201837080&amp;amp;idx=1&amp;amp;sn=b2a152b84df1c7dbd294ea66037cf262&amp;amp;scene=2&amp;amp;from=timeline&amp;amp;isappinstalled=0#rd"&gt;【鹅厂网事】全局精确流量调度新思路-HttpDNS服务详解&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;腾讯这篇文章时间点是 2014 年，说明这个方案上线更早，也较为成熟&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="https://developers.google.com/speed/public-dns/docs/dns-over-https"&gt;DNS-over-HTTPS &amp;nbsp;|&amp;nbsp; Public DNS &amp;nbsp;|&amp;nbsp; Google Developers&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;该方案更为先进，使用 HTTP 替换为 HTTPS，减少一个隐患点&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img alt="201611/httpdnsjbyl.png" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201611/httpdnsjbyl.png"/&gt;&lt;/p&gt;
&lt;p&gt;点击 &lt;a href="https://dns.google.com/resolve?name=www.duitang.com"&gt;https://dns.google.com/resolve?name=www.duitang.com&lt;/a&gt; /
&lt;a href="http://119.29.29.29/d?dn=www.duitang.com"&gt;http://119.29.29.29/d?dn=www.duitang.com&lt;/a&gt; 感受一下 DNS-over-HTTPS / HTTPDNS。&lt;/p&gt;
&lt;h2 id="dan-ip-duo-yu-ming-zhi-chi"&gt;单 IP 多域名支持&lt;/h2&gt;
&lt;p&gt;这个方案看似完美，但是在实际生产中，会遇到一个问题。&lt;/p&gt;
&lt;p&gt;Android / iOS 在操作系统级别对 HTTPS 通信是提供了封装。
APP 无法在发起连接时候，也没有权限直接操作 socket。
所以尽管 APP 拿到了域名对应的 IP，却没有办法让这个 IP 在 HTTPS 里生效。&lt;/p&gt;
&lt;p&gt;解决的思路很暴力：&lt;strong&gt;彻底放弃域名系统，完全使用基于 IP 系统的通讯。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;原本请求 &lt;code&gt;https://www.duitang.com&lt;/code&gt; 的 request，
调整为请求 &lt;code&gt;https://221.228.82.181&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;OK，做到这一步，我们就可以跟运营商劫持说拜拜了。&lt;/p&gt;
&lt;p&gt;不，还没结束。&lt;/p&gt;
&lt;p&gt;完全搞定运营商之后，这 IP 方案给我们自己带来一个困扰：
&lt;strong&gt;Nginx 服务器无法通过 Host 来识别不同域名下面的请求了！！！&lt;/strong&gt;
在由于使用一个独立 IP，会导致所有域名请求混在一起，无法分别。
大公司可以 dedicated IP，小公司就玩不起了。&lt;/p&gt;
&lt;p&gt;为了解决同一个 IP 下面多个域名的问题，我们引入了一个URL参数： &lt;code&gt;__domain&lt;/code&gt;。
当请求 IP 域名时候，必须带着这个参数，服务器会将请求域名解析出来，再分发到对应的域名。&lt;/p&gt;
&lt;p&gt;实现这个逻辑的 Nginx 核心代码：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;set&lt;/span&gt; &lt;span class="err"&gt;$&lt;/span&gt;&lt;span class="n"&gt;query_domain&lt;/span&gt; &lt;span class="err"&gt;$&lt;/span&gt;&lt;span class="n"&gt;arg___domain&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="err"&gt;$&lt;/span&gt;&lt;span class="n"&gt;query_domain&lt;/span&gt; &lt;span class="o"&gt;!~&lt;/span&gt; &lt;span class="err"&gt;'&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;www&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="err"&gt;\&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;example&lt;/span&gt;&lt;span class="err"&gt;\&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;com&lt;/span&gt;&lt;span class="err"&gt;'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;rewrite&lt;/span&gt; &lt;span class="o"&gt;^&lt;/span&gt; &lt;span class="n"&gt;http&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="c1"&gt;//www.example.com/404/ redirect;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="n"&gt;set&lt;/span&gt; &lt;span class="err"&gt;$&lt;/span&gt;&lt;span class="n"&gt;my_host&lt;/span&gt; &lt;span class="err"&gt;$&lt;/span&gt;&lt;span class="n"&gt;query_domain&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="n"&gt;location&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;proxy_set_header&lt;/span&gt; &lt;span class="n"&gt;Host&lt;/span&gt; &lt;span class="err"&gt;$&lt;/span&gt;&lt;span class="n"&gt;my_host&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="n"&gt;proxy_set_header&lt;/span&gt; &lt;span class="n"&gt;X&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;REAL&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;IP&lt;/span&gt; &lt;span class="err"&gt;$&lt;/span&gt;&lt;span class="n"&gt;remote_addr&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="n"&gt;proxy_pass&lt;/span&gt; &lt;span class="err"&gt;$&lt;/span&gt;&lt;span class="n"&gt;scheme&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="c1"&gt;//127.0.0.1;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;最后一个注意事项是，记得调整 Nginx 配置的 remote_addr，否则都变成了 127.0.0.1，
也许会导致其他一些策略失效。&lt;/p&gt;
&lt;p&gt;完美收工，效果如下：&lt;a href="https://221.228.82.181/?__domain=www.duitang.com"&gt;https://221.228.82.181/?__domain=www.duitang.com&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;恭喜你，已经掌握核心科技了，再也不怕运营商瞎折腾了，从此走上了业务蓬勃发展的金光大道&amp;hellip;&amp;hellip;☀️&lt;/p&gt;
&lt;p&gt;下一篇文章，我会再谈谈如何做 HTTPS 的「内测」，避免将线上业务一次性切到 HTTPS 导致不少边边角角业务无法正常使用。&lt;/p&gt;
&lt;hr/&gt;
&lt;hr&gt;
&lt;div class="panel"&gt;
&lt;div class="panel-body"&gt;
   &lt;small&gt;原文链接: &lt;a href="https://blog.alswl.com/2016/11/https-1/"&gt;https://blog.alswl.com/2016/11/https-1/&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;3a1ff193cee606bd1e2ea554a16353ee&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;欢迎关注我的微信公众号：&lt;a href="http://mp.weixin.qq.com/mp/getmasssendmsg?__biz=MzIyNTIwMTU3MQ==#wechat_webview_type=1&amp;wechat_redirect"&gt;窥豹&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/201605/qrcode_for_gh_17e2f9c2caa4_258.jpg"/&gt;&lt;/small&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/meta/wechat-pay-s-crop.png"/&gt;&lt;/small&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="HTTPS"></category><category term="HTTPDNS"></category></entry><entry><title>API 集成测试实践</title><link href="https://blog.alswl.com/2016/08/api-integration-test/" rel="alternate"></link><published>2016-08-14T19:08:20+08:00</published><updated>2016-08-14T19:08:20+08:00</updated><author><name>alswl</name></author><id>tag:blog.alswl.com,2016-08-14:2016/08/api-integration-test/</id><summary type="html">&lt;p&gt;&lt;img alt="abao.png" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201608/abao_thumbnail.png"/&gt;&lt;/p&gt;
&lt;p&gt;为了提高测试，工程师需要对自己提交的产物进行测试，一般是单元测试、集成测试。
之后提交物流转到 QA 团队，QA 团队根据需求描述对提交物进行测试，
这个测试过程非常耗费人力。
尤其是当开发交付的质量不高时候，很可能自身没有经过测试，会遇到主干流程都无法进行的状况。&lt;/p&gt;
&lt;p&gt;如果在 QA 人工介入测试之前，就进行一轮黑盒自动化集成测试，可以大大地提高 QA 团队的工作效率。
基于这样的判断，我们团队花了一些时间，将基于 API 的自动化测试系统搭建起来。
现在将这个系统的选型和运行状况拎出来，和大家分享。&lt;/p&gt;
&lt;h2 id="que-ren-ce-shi-fan-wei-mu-biao-he-yi-yi"&gt;确认测试范围、目标和意义&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;范围&lt;ul&gt;
&lt;li&gt;后台输出的 API 级别 URL&lt;/li&gt;
&lt;li&gt;使用场景&lt;ul&gt;
&lt;li&gt;打包时候的冒烟&lt;/li&gt;
&lt;li&gt;Dev / QA 手工添加添加新特性用例&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;目标&lt;ul&gt;
&lt;li&gt;覆盖大部分的 URL，当期设计为 top 10 URL，仅包含 GET 接口&lt;/li&gt;
&lt;li&gt;选型时，需要考虑非幂等（POST / DELETE / PUT）等接口&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;意义&lt;ul&gt;
&lt;li&gt;提高开发效率，一种自动化的 IT 测试方案&lt;/li&gt;
&lt;li&gt;提高测试效率，减少人工集成测试成本&lt;/li&gt;
&lt;li&gt;提高工程质量，通过覆盖率提升，保证工程质量逐步提升，放心开发新功能&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="te-xing-xu-qiu"&gt;特性需求&lt;/h2&gt;
&lt;p&gt;选型一个系统，不是看市面上有哪些可以供选择，而是看我需要什么样特性的一款产品。
如果自己的需求和市面上的现成产品差异过大，也可以考虑自己定制。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Required&lt;ul&gt;
&lt;li&gt;开源&lt;/li&gt;
&lt;li&gt;免费&lt;/li&gt;
&lt;li&gt;使用 DSL 或者简单代码描述测试用例&lt;/li&gt;
&lt;li&gt;支持细粒度的单 API 测试和构建带过程的测试用例&lt;/li&gt;
&lt;li&gt;HTTP API&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Optional&lt;ul&gt;
&lt;li&gt;CI 集成&lt;/li&gt;
&lt;li&gt;UI&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="tiao-xuan-chu-lai-de-xuan-xing-he-ping-jie"&gt;挑选出来的选型和评价&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://www.runscope.com/"&gt;API Monitoring and Testing &amp;middot; Runscope&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;收费&lt;/li&gt;
&lt;li&gt;非开源&lt;/li&gt;
&lt;li&gt;有监控特性&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.atlassian.com/software/bamboo"&gt;Bamboo - Continuous integration, deployment &amp;amp; release management | Atlassian&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;收费&lt;/li&gt;
&lt;li&gt;CI&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="https://circleci.com/features/"&gt;Continuous Integration Product and Features - CircleCI&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;CI&lt;/li&gt;
&lt;li&gt;收费&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Sauce Labs&lt;ul&gt;
&lt;li&gt;客户端测试，收费&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Apiary&lt;ul&gt;
&lt;li&gt;API 设计工具 + API Test&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="http://frisbyjs.com/"&gt;http://frisbyjs.com/&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;code&lt;/li&gt;
&lt;li&gt;npm&lt;/li&gt;
&lt;li&gt;open source&lt;/li&gt;
&lt;li&gt;NO UI&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/vowsjs/api-easy"&gt;https://github.com/vowsjs/api-easy&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;同上&lt;/li&gt;
&lt;li&gt;真是热爱造轮子的 JS 生态圈&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/visionmedia/supertest"&gt;https://github.com/visionmedia/supertest&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;同上&lt;/li&gt;
&lt;li&gt;从 Star 看，这个质量最高&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="http://dareid.github.io/chakram/"&gt;http://dareid.github.io/chakram/&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;code&lt;/li&gt;
&lt;li&gt;npm&lt;/li&gt;
&lt;li&gt;open source&lt;/li&gt;
&lt;li&gt;NO UI&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="https://vrest.io/"&gt;https://vrest.io/&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;收费&lt;/li&gt;
&lt;li&gt;不开源&lt;/li&gt;
&lt;li&gt;无插件&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="http://swagger.io/open-source-integrations/"&gt;http://swagger.io/open-source-integrations/&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;for API&lt;/li&gt;
&lt;li&gt;生态环境强大&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/cachecontrol/hippie-swagger"&gt;https://github.com/cachecontrol/hippie-swagger&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;用户端似乎在尝试用 swagger&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="http://robotframework.org/"&gt;http://robotframework.org/&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;一个通用自动化测试工具&lt;/li&gt;
&lt;li&gt;DSL&lt;/li&gt;
&lt;li&gt;扩展性较强&lt;/li&gt;
&lt;li&gt;活跃度在降低&amp;nbsp;&lt;a href="https://github.com/robotframework/robotframework/graphs/contributors"&gt;https://github.com/robotframework/robotframework/graphs/contributors&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="https://cucumber.io/"&gt;https://cucumber.io/&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href="https://cucumber.io/docs/reference"&gt;https://cucumber.io/docs/reference&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;和 Robotframework 相似，通用自动化测试工具&lt;/li&gt;
&lt;li&gt;DSL&lt;/li&gt;
&lt;li&gt;活跃度降低&amp;nbsp;&lt;a href="https://github.com/cucumber/cucumber-jvm/graphs/contributors"&gt;https://github.com/cucumber/cucumber-jvm/graphs/contributors&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.solanolabs.com/"&gt;https://www.solanolabs.com/&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;Airbnb 在用&lt;/li&gt;
&lt;li&gt;收费&lt;/li&gt;
&lt;li&gt;云端的通用测试环境&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/christophd/citrus"&gt;https://github.com/christophd/citrus&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href="http://www.citrusframework.org/"&gt;http://www.citrusframework.org/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;依赖 mvn / ant，离代码太近&lt;/li&gt;
&lt;li&gt;项目不够活跃&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;代码内测试&lt;ul&gt;
&lt;li&gt;src/it/com/duitang/xxx&lt;/li&gt;
&lt;li&gt;eg. tritornis&lt;/li&gt;
&lt;li&gt;Spring&lt;ul&gt;
&lt;li&gt;&lt;a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/integration-testing.html"&gt;http://docs.spring.io/spring/docs/current/spring-framework-reference/html/integration-testing.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://docs.spring.io/autorepo/docs/spring-framework/3.2.x/spring-framework-reference/html/testing.html"&gt;http://docs.spring.io/autorepo/docs/spring-framework/3.2.x/spring-framework-reference/html/testing.html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这部分工作，是和团队的其他成员一起去看的，大家各自分头寻找一些产品，然后进行评测，给出结论。&lt;/p&gt;
&lt;p&gt;经过讨论，我们将重点关注放在这么几款下面：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;supertest&lt;/li&gt;
&lt;li&gt;robotframework&lt;/li&gt;
&lt;li&gt;swagger&lt;/li&gt;
&lt;li&gt;讨论时候的新发现&amp;nbsp;&lt;a href="https://github.com/svanoort/pyresttest"&gt;https://github.com/svanoort/pyresttest&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="da-jian-demojin-xing-shi-yong"&gt;搭建 demo，进行试用&lt;/h2&gt;
&lt;p&gt;在确定选用那几款产品之后，就可以集中精力在几款候选者里面。搭建相应的环境，对他们进行实际测试。&lt;/p&gt;
&lt;p&gt;supertest：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;功能太简单了，简单到几乎可以自己写掉，不算一个 test framework&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;pyresttest：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;哈哈哈，YAML based，dreamed feature&lt;/li&gt;
&lt;li&gt;支持 YAML / extractor / validator&lt;/li&gt;
&lt;li&gt;天生支持 host 为参数&lt;/li&gt;
&lt;li&gt;create for me!!!&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;hippie-swagger：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;在使用上，和 supertest 差异不大&lt;/li&gt;
&lt;li&gt;仍然需要自己定义，在 swagger 描述文件不存在时候会抛错，描述文件不符合时会抛错&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;robotframework：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;较为复杂&lt;/li&gt;
&lt;li&gt;有 YAML 了，不用试了&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="shi-yong-gan-jue"&gt;使用感觉&lt;/h2&gt;
&lt;p&gt;经过一个季度的试用，我们基于 pyresttest 的项目 abao 运行较稳定。
尽量在工程师提交代码之后，运行一次，从而可以在早期发现问题。&lt;/p&gt;
&lt;p&gt;由于是基于 Python 的源代码，我们还给 pyresttest 开发了几款插件：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;cookie_extractor：用来解析特定的 cookie&lt;/li&gt;
&lt;li&gt;file_choice_generator：从文件随机选择预设数据&lt;/li&gt;
&lt;li&gt;file_seq_generator：从文件顺序选择预设数据&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在和 CI 的配合方面，我们在 Jinkins 搭建了 abao / abao-master 项目，
前者响应每次 Push 请求，都会自动构建一遍，后者每天凌晨会将 master 运行一遍。&lt;/p&gt;
&lt;p&gt;感谢项目贡献者：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;project&lt;/span&gt;  &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;abao&lt;/span&gt;
 &lt;span class="n"&gt;repo&lt;/span&gt; &lt;span class="n"&gt;age&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;5&lt;/span&gt; &lt;span class="n"&gt;months&lt;/span&gt;
 &lt;span class="n"&gt;active&lt;/span&gt;   &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;32&lt;/span&gt; &lt;span class="n"&gt;days&lt;/span&gt;
 &lt;span class="n"&gt;commits&lt;/span&gt;  &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;109&lt;/span&gt;
 &lt;span class="n"&gt;authors&lt;/span&gt;  &lt;span class="o"&gt;:&lt;/span&gt;
    &lt;span class="mi"&gt;39&lt;/span&gt;  &lt;span class="n"&gt;Chery&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Peng&lt;/span&gt;  &lt;span class="mf"&gt;35.8&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;
    &lt;span class="mi"&gt;33&lt;/span&gt;  &lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt;          &lt;span class="mf"&gt;30.3&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;
    &lt;span class="mi"&gt;17&lt;/span&gt;  &lt;span class="n"&gt;yanqi&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;chen&lt;/span&gt;  &lt;span class="mf"&gt;15.6&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;
    &lt;span class="mi"&gt;11&lt;/span&gt;  &lt;span class="err"&gt;橙子&lt;/span&gt;        &lt;span class="mf"&gt;10.1&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;
     &lt;span class="mi"&gt;7&lt;/span&gt;  &lt;span class="n"&gt;fiona66&lt;/span&gt;     &lt;span class="mf"&gt;6.4&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;
     &lt;span class="mi"&gt;2&lt;/span&gt;  &lt;span class="err"&gt;雪糕&lt;/span&gt;        &lt;span class="mf"&gt;1.8&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;hr/&gt;
&lt;p&gt;参考文档&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://github.com/integrations"&gt;Integrations Directory&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://www.infoq.com/cn/search.action?queryString=%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95&amp;amp;page=1&amp;amp;searchOrder=&amp;amp;sst=guKeEhPzzhUs7xpS"&gt;http://www.infoq.com/cn/search.action?queryString=%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95&amp;amp;page=1&amp;amp;searchOrder=&amp;amp;sst=guKeEhPzzhUs7xpS&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://www.infoq.com/cn/news/2014/02/autotest-2013"&gt;http://www.infoq.com/cn/news/2014/02/autotest-2013&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://www.infoq.com/cn/articles/cucumber-robotframework-comparison"&gt;http://www.infoq.com/cn/articles/cucumber-robotframework-comparison&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://www.infoq.com/cn/articles/http-api-automated-test-from-manual-to-platform"&gt;http://www.infoq.com/cn/articles/http-api-automated-test-from-manual-to-platform&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://nerds.airbnb.com/testing-at-airbnb/"&gt;http://nerds.airbnb.com/testing-at-airbnb/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Google keywords&lt;ul&gt;
&lt;li&gt;integration api test framework&lt;/li&gt;
&lt;li&gt;github intergration test&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;div class="panel"&gt;
&lt;div class="panel-body"&gt;
   &lt;small&gt;原文链接: &lt;a href="https://blog.alswl.com/2016/08/api-integration-test/"&gt;https://blog.alswl.com/2016/08/api-integration-test/&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;3a1ff193cee606bd1e2ea554a16353ee&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;欢迎关注我的微信公众号：&lt;a href="http://mp.weixin.qq.com/mp/getmasssendmsg?__biz=MzIyNTIwMTU3MQ==#wechat_webview_type=1&amp;wechat_redirect"&gt;窥豹&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/201605/qrcode_for_gh_17e2f9c2caa4_258.jpg"/&gt;&lt;/small&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/meta/wechat-pay-s-crop.png"/&gt;&lt;/small&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="Test"></category><category term="API"></category></entry><entry><title>搞定暴涨的流量</title><link href="https://blog.alswl.com/2016/06/capacity-planning/" rel="alternate"></link><published>2016-06-19T23:57:39+08:00</published><updated>2016-06-19T23:57:39+08:00</updated><author><name>alswl</name></author><id>tag:blog.alswl.com,2016-06-19:2016/06/capacity-planning/</id><summary type="html">&lt;p&gt;2013 年左右，我司业务发展迅速，每天晚上都会面临服务器濒临崩溃情况。
我相信每个高速发展的互联网企业在某个阶段都会面临这样的情形，比如去年爆红的「足迹」。
过程往往是：线上出现故障，手机会收到报警，然后登录到服务器上去解决问题。
处理这种问题工种现在有一个时髦的名称，叫做「SRE（Site Reliability Engineer）」系统可用性工程师。&lt;/p&gt;
&lt;p&gt;虽然我常常救火，但是我还是想尽可能避免线上发生故障。「最好的消息，就是没有消息。」
减少故障出现概率，增强系统可用性，降低故障处理时间是 SRE 的最大课题。
在这里有最常用的两个手段，一个是优化性能，一个是做好容量规划和扩展。
这里我着重讨论后者「容量规划」。&lt;/p&gt;
&lt;p&gt;&lt;img alt="看我的一堆报警消息" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201606/message.png"/&gt;&lt;/p&gt;
&lt;p&gt;^ 看我的一堆报警消息&lt;/p&gt;

&lt;h2 id="mian-lin-de-wen-ti"&gt;面临的问题&lt;/h2&gt;
&lt;p&gt;面对暴涨流量，一边是业务方的满心欢喜，一边就是工程师的烦恼和压力了。
也许是一个受欢迎的功能上线了，或者是某个社会活动导致流量爆发，系统开始出现高延迟，磁盘 IO 不够用了。
也许是 DB 第一个倒下，也许是 RPC 系统第一个倒下&amp;hellip;&amp;hellip;
呃，大神可能会说，我艹，RPC 系统第一个倒下还搞个屁啊，赶紧倒闭算了。&lt;/p&gt;
&lt;p&gt;核心的问题就是，在现有性能下面，在面临可能的大流量冲击时候，如何做到不慌不忙，能够 handle 住突如其来的流量？&lt;/p&gt;
&lt;h2 id="she-ding-rong-liang-mu-biao"&gt;设定容量目标&lt;/h2&gt;
&lt;p&gt;在解决这个问题之前，我们得先考虑清楚，我们到底要多强的流量处理能力。
如果今天我们只是一个两三台服务器的小团队，却企图设计一个能够抗住 1 亿 pv 访问的系统，
显然是不现实的，至少是不经济的。&lt;/p&gt;
&lt;p&gt;衡量系统容量的指标可以简化为在什么流量下面，提供什么样的可用性保证。
一个实际的样例是，在 1 亿 pv 下面，提供 99.99% 的可用性，
其可用性的评判标准是「服务器在 200ms 内返回正确的数据」。&lt;/p&gt;
&lt;p&gt;这里有一个重要的概念，可用性保证，术语是服务等级协议（SLA）。
这个指标可以从大部分标准云供应商的标准条款里看到，比如我司机房供应商提供的可用性保证是 99.9%。
阿里云 ECS 的 SLA 是「99.95%」，统计周期是 1 个月
（如果故障时间低于 5 min，不计入故障时间，云供应商都这样，特别霸权）。&lt;/p&gt;
&lt;p&gt;一个对 SLA 的直观认识是（具体数据来自 &lt;a href="https://en.wikipedia.org/wiki/High_availability#Percentage_calculation"&gt;High availability - Wikipedia, the free encyclopedia&lt;/a&gt;）：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;99.0% 意味着一年有 87 天不可用&lt;/li&gt;
&lt;li&gt;99.5% 意味着一年 1.83 天不可用&lt;/li&gt;
&lt;li&gt;99.9% 意味着一年 8.76 小时不可用&lt;/li&gt;
&lt;li&gt;99.99% 意味着一年 52.56 分钟不可用&lt;/li&gt;
&lt;li&gt;99.999% 意味着一年 5 分 15 秒不可用，这是高可用的一般标准&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;设定越高的 SLA 的成本越高，具体 SLA 的设定是成本、收益、期望的平衡。
不同的业务需要的 SLA 也不一样，一般认为 99.9% 基本可用，99.99% 可用性较高，
99.999% 为高可用。&lt;/p&gt;
&lt;p&gt;有些云供应商号称 8 个 9，9 个 9，那往往都是对于存储服务里面的数据不丢失这个指标。
除了忽悠忽悠人，这个 SLA 没什么用的。&lt;/p&gt;
&lt;h2 id="ce-liang"&gt;测量&lt;/h2&gt;
&lt;p&gt;做一件伟大事情时候，先有目标，下一步如果是迈出脚步出去闯荡，那么往往换来的是一个身心疲惫的自己。
更稳当的做法是，先摸摸清楚，自己有几把刷子，是不是还要再练练，有没有资格上战场。
没有 Profiling，就是瞎子，根本不用谈优化和容量规划。&lt;/p&gt;
&lt;p&gt;对于一般的业务场景而言，常见的测量指标分为三类：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;服务器的硬件指标（CPU、内存、硬盘 IO、硬盘容量、网络）&lt;/li&gt;
&lt;li&gt;服务的软件指标（QPS / latency / pool）&lt;/li&gt;
&lt;li&gt;业务的数据指标（核心业务指标，比如注册数，核心动作次数）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;我司的实践情况是这样的，我们使用 Zabbix 测量服务器，用自己设计的系统收集服务数据，使用 Grafana 呈现。
后者被设计到 RPC 系统内部，数据是全量收集。
我司在业务层面的数据监控做的还不足，这种不足不仅仅体现在数据的全面性上面，还体现在相关成员（比如产品汪）对数据的利用率上面。&lt;/p&gt;
&lt;p&gt;除了测量线上的实施数据，了解某个设施的性能极限也是很重要，目前常见的测量方式是：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;模拟流量进行测试&lt;/li&gt;
&lt;li&gt;在线上进行测试，并实时跟踪进展情况，出现异常时候，停止流量切入&lt;/li&gt;
&lt;li&gt;从线上引入流量到测试环境进行测试&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;我发现，第一种方法往往不准，第三种方法对于小团队来说，成本太高。第二种方法是最粗暴和有效的。&lt;/p&gt;
&lt;h2 id="yu-jing-he-ti-xing"&gt;预警和提醒&lt;/h2&gt;
&lt;p&gt;仅仅知道当前系统的性能表现是不足的，重要的如何将这些数据利用起来，对未来系统增长进行预估。
流量增长 vs 资源消耗，这个曲线大部分情况是线性的，有些情况确实指数增长的。&lt;/p&gt;
&lt;p&gt;常见的做法是，给核心指标设置一个阈值（比如 80% 磁盘使用率，40% 磁盘 IO 利用率），当监控的数据到达这个阈值时候。
就必须进行容量扩充，进行负载均衡。&lt;/p&gt;
&lt;p&gt;一个从运维同学身上学到的是，提前采购一些设备放到机房里面，比如硬盘、内存，别到时候供应商来不及供货。
必要库存可以降低 MTBF。&lt;/p&gt;
&lt;p&gt;除了设定阈值报警，应当定期跑一些脚本获得数据。定期检查报警系统，避免报警系统失效。&lt;/p&gt;
&lt;h2 id="bi-xuan-xiang-scalable"&gt;必选项 - Scalable&lt;/h2&gt;
&lt;p&gt;上文写到，「必要时候进行容量扩充，进行负载均衡」。
这点的提出，意味这需要&lt;strong&gt;保证基础设施是可扩展的，支持负载均衡，支持硬件扩容&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;Web 系统比较容易做到横向扩容，使用 Nginx / LVS 等负载均衡即可。
中间件服务一般也是在设计时候就考虑了扩展。（什么？你们家 RPC 系统设计调用不支持扩展？什么脑残设计？！）&lt;/p&gt;
&lt;p&gt;DB 级别的服务，往往就要花一些心思了，一些技术（比如 MySQL）想要做到横向扩展，
需要进行提前设计。而一些设施虽然容易进行扩展，比如 ES / Kafka 等现代化设施，
但在部署的时候仍然要进行一些提前准备。&lt;/p&gt;
&lt;p&gt;除了提前做好 Scalable，还有几个和部署相关的 tips 可以供参考：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;使用工具：自动化部署，现在有太多工具可以供选择，比如 ansible 就是一个很好的工具&lt;/li&gt;
&lt;li&gt;automatic everything：避免登录服务器操作才能保证未来自动化&lt;/li&gt;
&lt;li&gt;工程化：用最佳实践去维护部署系统，用工程化的态度去写部署代码&lt;/li&gt;
&lt;li&gt;保持同质，避免花样：避免使用 shell 级别的操作原语操作部署系统，使用预设的 module 去操作&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="end"&gt;End&lt;/h2&gt;
&lt;p&gt;好了，现在去预测一下当大流量来临之际，你的服务会在哪些环节失败。
想不出来的话，就一点点去测量各个环节性能，然后做一把容量规划吧。&lt;/p&gt;
&lt;p&gt;调优和增加容量，这是两个手段，这两个手段互相作用，互相影响。使用时候需要根据成本和收益进行选择。&lt;/p&gt;
&lt;p&gt;关于容量规划的更多细节，可以看看 &lt;a href="https://book.douban.com/subject/4200645/"&gt;Web容量规划的艺术 (豆瓣)&lt;/a&gt;
这里看看。只是这本书写在 2010 年，并且作者介绍的过于传统运维视角一些。&lt;/p&gt;
&lt;hr&gt;
&lt;div class="panel"&gt;
&lt;div class="panel-body"&gt;
   &lt;small&gt;原文链接: &lt;a href="https://blog.alswl.com/2016/06/capacity-planning/"&gt;https://blog.alswl.com/2016/06/capacity-planning/&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;3a1ff193cee606bd1e2ea554a16353ee&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;欢迎关注我的微信公众号：&lt;a href="http://mp.weixin.qq.com/mp/getmasssendmsg?__biz=MzIyNTIwMTU3MQ==#wechat_webview_type=1&amp;wechat_redirect"&gt;窥豹&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/201605/qrcode_for_gh_17e2f9c2caa4_258.jpg"/&gt;&lt;/small&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/meta/wechat-pay-s-crop.png"/&gt;&lt;/small&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="Capacity"></category><category term="SRE"></category><category term="Architect"></category></entry><entry><title>一次「分答」记录</title><link href="https://blog.alswl.com/2016/06/q-and-a/" rel="alternate"></link><published>2016-06-15T09:59:16+08:00</published><updated>2016-06-15T09:59:16+08:00</updated><author><name>alswl</name></author><id>tag:blog.alswl.com,2016-06-15:2016/06/q-and-a/</id><summary type="html">&lt;p&gt;尝试在团队内部发起一次类似「分答」的沟通方式，一对一面聊。
回答其他工程师的问题，这种沟通的方式暨在提供一个特定的场合，帮助加强双方了解，
解决团队中其他工程师的一些实际的问题。&lt;/p&gt;
&lt;p&gt;在征得对方同意之后，我将他的问题和我的回答 PO 出来。&lt;/p&gt;
&lt;p&gt;&lt;img alt="201606/questions-and-answers.jpg" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201606/questions-and-answers.jpg"/&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;喜欢什么游戏，玩游戏的问题&lt;ul&gt;
&lt;li&gt;喜欢和人玩游戏，不喜欢和不认识网友玩游戏&lt;/li&gt;
&lt;li&gt;小学从红月开始玩，传奇、CS、魔兽、真三、DOTA，大学时候和舍友玩游戏，毕业后不玩&lt;/li&gt;
&lt;li&gt;minecraft 尝试着玩过，没有玩下去，找不到人&lt;/li&gt;
&lt;li&gt;日活的桌面游戏，三国杀等蛮喜欢&lt;/li&gt;
&lt;li&gt;不喜欢浪费时间，怕没控制&lt;/li&gt;
&lt;li&gt;从玩游戏里面学习什么么？不，就是纯粹享受游戏，不会想这么多&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;喜欢什么语言&lt;ul&gt;
&lt;li&gt;看场合，小东西，小场景用 Python，生产环境用 Java，生产环境又有时间，考虑 Scala&lt;/li&gt;
&lt;li&gt;只允许选一门语言，就用 Python&lt;/li&gt;
&lt;li&gt;最吸引的特点，熟悉程度高，生产效率高，第三方库丰富，粘合性强&lt;/li&gt;
&lt;li&gt;为 Python 做一些功能扩展？不同时期答案会不一样，目前来说，希望有一个开发效率更高的 framework；有时间的话，会考虑如何绕过底层 GIL 问题 &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;有什么事情投入精力，铩羽而归&lt;ul&gt;
&lt;li&gt;工具向重的人，推广 git 花了两年，推广 Restful 不利&lt;/li&gt;
&lt;li&gt;做业务开发 leader，和 tsu、小管一起做，项目管理、团队管理没做好，没做好，有挫败感。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;职业迷茫期&lt;ul&gt;
&lt;li&gt;我作为一个学渣，并且长期以来没有人给予职业生涯规划，一直对自己未来发展有困惑&lt;/li&gt;
&lt;li&gt;如何在无领导的情况之下，探索未来道路，规划自己工作内容？跟优秀的人聊，跟外部的人聊，看博客，看书&lt;/li&gt;
&lt;li&gt;迷茫是客观存在的，并且可能持续存在很久，正视它&lt;/li&gt;
&lt;li&gt;现实中一定会遇到各种挑战和困难的，用挑战和困难填充自己，丰富自己的生活&lt;/li&gt;
&lt;li&gt;迷茫是未知，有恐惧，有兴奋。对当前的我来说，恐惧可能更多，但是要面对&lt;/li&gt;
&lt;li&gt;职业生涯里面，前期的同质度更高，资深工程师可以会给初级工程师规划清晰一些，但是越往后期，越难规划，需要自己探索&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;推荐书&lt;ul&gt;
&lt;li&gt;&lt;a href="https://book.douban.com/people/alswl/collect?sort=rating&amp;amp;start=0&amp;amp;filter=all&amp;amp;mode=list&amp;amp;tags_sort=count"&gt;https://book.douban.com/people/alswl/collect?sort=rating&amp;amp;start=0&amp;amp;filter=all&amp;amp;mode=list&amp;amp;tags_sort=count&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;学习来源&lt;ul&gt;
&lt;li&gt;博客，infoq 等专业信息来源&lt;/li&gt;
&lt;li&gt;书籍&lt;/li&gt;
&lt;li&gt;周围的人&lt;/li&gt;
&lt;li&gt;尽可能从每天时间挤出时间阅读&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;生活和工作平衡点&lt;ul&gt;
&lt;li&gt;不同的人，同一个人的不同时期所需要的平衡不一样&lt;/li&gt;
&lt;li&gt;对自己人生期望不一样的人，平衡点不一样&lt;/li&gt;
&lt;li&gt;对我来说，目前阶段不存在明显边界，尽可能投入工作&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;如何保持激情&lt;ul&gt;
&lt;li&gt;人总是有低谷期的，不可能一直保持亢奋，除非是甲亢&lt;/li&gt;
&lt;li&gt;短期情绪会有起伏，长期来看，保持梦想和对自己高要求，可以帮助保持激情&lt;/li&gt;
&lt;li&gt;我有低谷期，低谷期适合反思&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;如何擦屁股&lt;ul&gt;
&lt;li&gt;现实是残酷的，总有屁股要擦，自己也有脏屁股，今天要给昨天的自己擦屁股&lt;/li&gt;
&lt;li&gt;现实中存在脏屁股，尽可能了解它，看代码、文档，设计方案，了解的人，让自己变舒服&lt;/li&gt;
&lt;li&gt;责任心的体现，做好当下的事情；解决这样的问题，解决当前的问题；避免留下脏屁股，设计好，规划好&lt;/li&gt;
&lt;li&gt;责任心的话很虚。一个人做擦屁股、低产值的事情，从长远来看，是错的；短期需要撑下来；并且帮助团队避免这样的事情发生&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;最有成就感的事情&lt;ul&gt;
&lt;li&gt;顶着家庭压力，到上海来&lt;/li&gt;
&lt;li&gt;在堆糖改造环境，提升自己心智水平，不害怕问题，自信，自省&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;hr&gt;
&lt;div class="panel"&gt;
&lt;div class="panel-body"&gt;
   &lt;small&gt;原文链接: &lt;a href="https://blog.alswl.com/2016/06/q-and-a/"&gt;https://blog.alswl.com/2016/06/q-and-a/&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;3a1ff193cee606bd1e2ea554a16353ee&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;欢迎关注我的微信公众号：&lt;a href="http://mp.weixin.qq.com/mp/getmasssendmsg?__biz=MzIyNTIwMTU3MQ==#wechat_webview_type=1&amp;wechat_redirect"&gt;窥豹&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/201605/qrcode_for_gh_17e2f9c2caa4_258.jpg"/&gt;&lt;/small&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/meta/wechat-pay-s-crop.png"/&gt;&lt;/small&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="Team"></category><category term="Startup"></category></entry><entry><title>海贼王和创业团队</title><link href="https://blog.alswl.com/2016/04/onepiece-startup/" rel="alternate"></link><published>2016-04-27T00:36:10+08:00</published><updated>2016-04-27T00:36:10+08:00</updated><author><name>alswl</name></author><id>tag:blog.alswl.com,2016-04-27:2016/04/onepiece-startup/</id><summary type="html">&lt;p&gt;一个同事在知乎提了一个问题 &lt;a href="https://www.zhihu.com/question/35037806"&gt;如果把草帽海贼团比作一个创业团队,这个Team的组织架构是怎样的?有哪些优势,又有哪些不足?&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img alt="201604/onepiece.jpg" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201604/onepiece.jpg"/&gt;&lt;/p&gt;
&lt;p&gt;这个话题很有趣，作为追了多年的 fans ，又是身处互联网创业团队的我要来强答一记。&lt;/p&gt;
&lt;p&gt;海贼王的世界很大，富有个性的角色和团队也很多，恰好可以和显示世界中的互联网创业团队进行对比。
柳传志讲的好，做大事，要「建班子，定战略，带队伍」，我们就着金句来看看草帽这个团队怎么样。&lt;/p&gt;

&lt;h2 id="chan-pin-he-zhan-lue"&gt;产品和战略&lt;/h2&gt;
&lt;p&gt;我先讲产品和战略。&lt;/p&gt;
&lt;p&gt;由于海贼王世界的设定，以及作为一个全年段漫画动画的原因。
海贼王世界的整体战略是较为简单，海贼团的目标都较为单一，即「找到 哥尔 D 罗杰 留下的宝藏」。
海贼团们实现目标的路径也较为单一，打斗增强战斗力，不断寻找线索，去伟大航道寻找宝藏。&lt;/p&gt;
&lt;p&gt;所以故事的开展反而是围绕另外一条隐秘的线索「历史的真相」，尾田大神埋坑很深。
「历史的真相」并不是作为大部分人努力和前进的目标，所以「海贼王」世界的故事虽然曲折跌宕，
但是产品模型极为单一，不具备太多可以讨论的点。&lt;/p&gt;
&lt;h2 id="tuan-dui"&gt;团队&lt;/h2&gt;
&lt;p&gt;接着讲团队，一个团队第一重要的是创始人，这必须要是一位领袖人物。&lt;/p&gt;
&lt;p&gt;评价领袖优秀程度，从这么几个角度评价：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;意志力：打不死的小强，不达目标誓不罢休&lt;/li&gt;
&lt;li&gt;专业技能：能打、脑子灵光、心灵手巧、一技之长&lt;/li&gt;
&lt;li&gt;规划能力：除了体力值和专业智慧，也要讲讲战略和谋略&lt;/li&gt;
&lt;li&gt;管理能力：沟通协调、团队管理促进能力，能够带领团队实现目标，促进他人成长&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;以这个标准来看几个具有领袖气质的角色：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;路飞&lt;ul&gt;
&lt;li&gt;意志力：5&lt;/li&gt;
&lt;li&gt;专业技能：5&lt;/li&gt;
&lt;li&gt;规划能力：1（率性而为的大爷）&lt;/li&gt;
&lt;li&gt;管理能力：1（团队自由生长）&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;白胡子&lt;ul&gt;
&lt;li&gt;意志力：5&lt;/li&gt;
&lt;li&gt;专业技能：5&lt;/li&gt;
&lt;li&gt;规划能力：4（顶上之战的过程证明）&lt;/li&gt;
&lt;li&gt;管理能力：5（队长们的成长和忠诚度证明）&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;多弗朗明哥&lt;ul&gt;
&lt;li&gt;意志力：5&lt;/li&gt;
&lt;li&gt;专业技能：5&lt;/li&gt;
&lt;li&gt;规划能力：5&lt;/li&gt;
&lt;li&gt;管理能力：5&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;艾斯&lt;ul&gt;
&lt;li&gt;意志力：5&lt;/li&gt;
&lt;li&gt;专业技能：4（以牺牲的时间点战斗力打分）&lt;/li&gt;
&lt;li&gt;规划能力：2（追踪黑胡子，一个人冒进，被黑胡子摆了一道）&lt;/li&gt;
&lt;li&gt;管理能力：2（也就混到一个队长，能够鼓励其他人，但是没发现黑胡子成长的问题）&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;唐僧（乱入一个对比）&lt;ul&gt;
&lt;li&gt;意志力：5+&lt;/li&gt;
&lt;li&gt;专业技能：4（熟读经书算不算专业能力？）&lt;/li&gt;
&lt;li&gt;规划能力：0&lt;/li&gt;
&lt;li&gt;管理能力：0&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;从上面的判断可以看出，对于一个领袖而言，路飞仅仅是不错，但是谈不上多么优秀，
倒是白胡子，典范啊典范。&lt;/p&gt;
&lt;p&gt;根据上面提到的能力模型，草帽海贼团的其他角色大家也可以心里评估出来了：
大部分人都是意志力、专业技能强悍（即便是乌索普，射击能力也是可以评上 3），但是同时也在规划能力和管理能力上面较弱。&lt;/p&gt;
&lt;p&gt;唉，这么弱，很难继续支撑草帽海贼团继续走下去啊，怎么办呢？&lt;/p&gt;
&lt;h2 id="dai-dui-wu"&gt;带队伍&lt;/h2&gt;
&lt;p&gt;草帽海贼团，一个极为漂亮的「自组织团队」。&lt;/p&gt;
&lt;p&gt;什么是「自组织团队」？来自 InfoQ 的一篇文章 &lt;a href="http://www.infoq.com/cn/articles/what-are-self-organising-teams"&gt;什么是自组织团队？&lt;/a&gt; 里面讲到团队的特性：&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;分散式的控制，也就是说与集中式的控制截然相反，&lt;/li&gt;
&lt;li&gt;不断适应改变的环境，&lt;/li&gt;
&lt;li&gt;在局部相互作用下自然浮现出来的结构,&lt;/li&gt;
&lt;li&gt;反馈，包括肯定的和否定的&lt;/li&gt;
&lt;li&gt;弹性，归结于系统修复和调整的能力。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;用简单的关键词概括，其实是这么几个关键词：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;自行决策&lt;/li&gt;
&lt;li&gt;自己成长&lt;/li&gt;
&lt;li&gt;适应环境变化&lt;/li&gt;
&lt;li&gt;团队内部信任并且沟通顺畅&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;从这几个关键词来看，草帽海贼团和这种自组织模式极为匹配。路飞从来不会发号施令，统一调度，顶多喊几句口号振奋一下大家。
路飞自身的规划能力和帮助他人成长的能力也远不及格。团队里面其他的成员，索隆、香吉士等的成长，完全是靠自己，
甚至在「两年」跨度这么长的时间，尾田也是借外部力量帮助团队这些成员成长，而不是依靠领袖来培养成员。&lt;/p&gt;
&lt;p&gt;路飞选择这种自组织模式，不仅仅是一种巧合，更多的是一种逼不得已。尾田大神写的就是青春热血漫画，要是换成一个有勇有谋，
那就成主旋律电视剧了，大家可能也是因为路飞这种优点和缺点喜欢他。&lt;/p&gt;
&lt;h3 id="anti-zi-zu-zhi-mo-shi"&gt;Anti-自组织模式&lt;/h3&gt;
&lt;p&gt;和「自组织模式」相反的情况，可以参照一下多弗朗明哥的团队。我们可以看到，在多弗朗明哥团里里面，有严密的等级关系（四大干部，家族干部，普通小兵），
有帮助人才成长的流程（培训罗的一系列流程）。
这种设定也是多弗朗明哥的战略能力和管理能力的体现。&lt;/p&gt;
&lt;p&gt;还有一种更极致的组织模式「集权模式」，由核心层发号施令，协同作战。
海贼王的世界里，较少发现这样的模式，反派角色海军有一点点像。
倒是另外一部作品「星球大战」，其中的帝国、第一秩序，都是典型的 Manager 发号施令，底层士兵只要好好作战即可。
统一培养成行的克隆人，就可以支撑这样的团队发挥十足战力。&lt;/p&gt;
&lt;p&gt;这种集权模式，缺少向上反馈能力，缺少自发的创新能力。在业务发展顺利规模扩张阶段，也许可以发展不错，但是长久以往，
核心层必然会发觉创新力和驱动力不足，花费大量的精力在管理、制度建设、奖惩机制上面。&lt;/p&gt;
&lt;p&gt;路飞的缺点和优点一样鲜明，他很幸运的（可能也完全不知道）使用了「自组织团队」这种模式，完成了创业的起步阶段。
但是这种模式有也有自带的缺陷，需要目标一致性很高，团队成员自身有极高成长度。一旦遇到业务爆炸（顶上之战这种规模的战役），
这团队就完蛋了。期望路飞在未来的航道上，注意培养一下自己不善于的能力。好消息是，从最近的「庞克哈撒德篇」和「德雷斯罗撒篇」战况来看，
路飞已经开始学会制定「寻找友军结盟」、「树立竞争对手标杆」这样的初级战略方案了。&lt;/p&gt;
&lt;h2 id="mo_1"&gt;末&lt;/h2&gt;
&lt;p&gt;海贼王的世界，真的就是现实中「海盗」的正式写照吧。完成不可能的目标，成就团队，成就自己。&lt;/p&gt;
&lt;p&gt;「世代传承的意志，时代的变迁，人们的梦，只要人们继续追求自由的答案，这一切的一切都将永不停止.这世界&amp;hellip;&amp;hellip;没错！一个追求自由任凭选择的世界，就在我们的眼前无限地延伸，如果我们的梦想可以引导你的方向的话，就去追寻吧！在名为信念的旗帜下」&lt;/p&gt;
&lt;hr&gt;
&lt;div class="panel"&gt;
&lt;div class="panel-body"&gt;
   &lt;small&gt;原文链接: &lt;a href="https://blog.alswl.com/2016/04/onepiece-startup/"&gt;https://blog.alswl.com/2016/04/onepiece-startup/&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;3a1ff193cee606bd1e2ea554a16353ee&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;欢迎关注我的微信公众号：&lt;a href="http://mp.weixin.qq.com/mp/getmasssendmsg?__biz=MzIyNTIwMTU3MQ==#wechat_webview_type=1&amp;wechat_redirect"&gt;窥豹&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/201605/qrcode_for_gh_17e2f9c2caa4_258.jpg"/&gt;&lt;/small&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/meta/wechat-pay-s-crop.png"/&gt;&lt;/small&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="Startup"></category><category term="Comics"></category><category term="OnePiece"></category></entry><entry><title>Windows management for hacker</title><link href="https://blog.alswl.com/2016/04/windows-management-for-hacker/" rel="alternate"></link><published>2016-04-24T16:36:16+08:00</published><updated>2016-04-24T16:36:16+08:00</updated><author><name>alswl</name></author><id>tag:blog.alswl.com,2016-04-24:2016/04/windows-management-for-hacker/</id><summary type="html">&lt;p&gt;团队里的同学有时看见我键指如飞，可以用快捷键将 Mac 的窗口玩转于手心。他们表示酷炫非常，
心生羡慕的同时，希望掌握这门技艺，我就把使用的 Phoenix 介绍给大家。结果过了一段时间，
发现普及率并不高，本着好为人师的精神，今天我就来八一八这款优秀的桌面管理工具。&lt;/p&gt;
&lt;p&gt;在介绍我使用的工具之前，我要先介绍一下我选择的原因和历史。&lt;/p&gt;
&lt;p&gt;&lt;img alt="201604/ergodox_infinity.jpg" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201604/ergodox_infinity.jpg"/&gt;&lt;/p&gt;
&lt;p&gt;ps：配图是我长草多年的 Ergodox Infinity。（@夫人，看到这里的时候，请留步思考 5s）。&lt;/p&gt;
&lt;h2 id="alttab-ku-nan-de-li-shi"&gt;Alt+Tab = 苦难的历史&lt;/h2&gt;
&lt;p&gt;当我还年轻的时候，曾经对 Alt+Tab 这个快捷键愤慨无比，觉得这种设计虽然简单但是很蠢。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;命中率低&lt;/strong&gt;。要在茫茫图标中查找自己需要的窗口，如果开了 20 个应用，切换到一个非常用窗口至多可能需要 20-1 次按键。
    不要跟我说有 Alt+Shift+Tab 的反向循环操作，估计大部分用户都不知道。而且 正向/反向 切换伤脑子。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;交互方式耗时&lt;/strong&gt;。由于 Alt+Tab 的操作需要用户进行反馈才能进行，是 &lt;code&gt;眼-手-眼-手&lt;/code&gt; 的操作反馈方式，
    这种交互模式费时费脑子。跟这种需要实时反馈对立的交互模式应当是类似「一键呼出」的操作。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;在大显示器、多显示器的环境下面，Alt-Tab 模式没有做任何优化&lt;/strong&gt;。&lt;/li&gt;
&lt;li&gt;频繁切出窗口进行切换，容易让人分神，比如切换时候看到某个播放器的标题，在放一首喜欢的歌，很可能吸引过去。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;有人会问，难道不优化都是缺陷么？
    我的答案是肯定的。Alt+Tab 是几乎除鼠标之外的唯一一种窗口操作方式。如果它不能跟上时代的步伐，
    对大显示器、多显示器做优化，那就是不作为，不努力，不上进。跟不上变化是要被淘汰的！&lt;/p&gt;
&lt;p&gt;&lt;img alt="201604/alt_tab_windows.jpeg" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201604/alt_tab_windows.jpeg"/&gt;&lt;/p&gt;
&lt;h2 id="ping-pu-shi-chuang-kou-guan-li-qi"&gt;平铺式窗口管理器&lt;/h2&gt;
&lt;p&gt;在被 Windows Alt-Tab 虐了多年之后，我长大了，开始接触 Linux，但是这种痛苦仍然时刻包围着我。
当我分期购买一个外置显示器之后，这种痛苦到达到了顶端。
恰好彼时我是 &lt;a href="https://www.archlinux.org/"&gt;ArchLinux&lt;/a&gt; 的信徒，很快就发现了一片桃源：
自己安装 &lt;a href="https://wiki.archlinux.org/index.php/window_manager"&gt;Window manager&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;我重新认识了桌面系统世界，除了介绍常规的 Gnome / KDE / xfce 之外，还有一类窗口管理系统，他们叫做「平铺式窗口管理器」。
（严格来说，Gnome / KDE / xfce 属于 Desktop environment，层级比「窗口管理系统」要高，我这里不做严格区分）。&lt;/p&gt;
&lt;p&gt;什么是平铺式窗口管理器？来一个直观的认识：&lt;/p&gt;
&lt;p&gt;&lt;img alt="201604/awesome_1.jpeg" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201604/awesome_1.jpeg"/&gt;&lt;/p&gt;
&lt;p&gt;&lt;img alt="201604/awesome_2.jpeg" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201604/awesome_2.jpeg"/&gt;&lt;/p&gt;
&lt;p&gt;官方的解释是&amp;hellip;&amp;hellip;呵呵，自己点进去看解释吧。平铺式桌面管理器（包括同时支持平铺式和堆叠式的混合式桌面管理器）给我带来了新的认知，
原来桌面系统是可以进行接口编程的，我不那么 care 到底是哪种风格，我 care 的是，
能否通过编程定制来解决我的 Alt-Tab 问题。&lt;/p&gt;
&lt;h2 id="wo-qi-wang-de-chuang-kou-guan-li-mo-shi"&gt;我期望的窗口管理模式&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;快速启动最常用的应用，同时也能将其快速呼出&lt;/li&gt;
&lt;li&gt;对大屏幕友好，现在显示器普遍是大屏幕，可以自由控制窗体的移动，方便多个窗口同时进行操作&lt;/li&gt;
&lt;li&gt;对多屏幕友好，多屏幕间的切换，要友好。可以快速屏幕间切换&lt;/li&gt;
&lt;li&gt;对键盘友好，对鼠标友好，全键盘操作模式，但同时要对鼠标友好，比如鼠标跟随焦点功能，毕竟一些操作还是鼠标方便&lt;/li&gt;
&lt;li&gt;帮助集中注意力，将操作界面隔离成多个目的区分的空间，比如写作时候，期望只有一个 Evernote + Chrome 在眼前&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="wo-zai-mac-xia-mian-de-fang-an"&gt;我在 Mac 下面的方案&lt;/h2&gt;
&lt;p&gt;呜呼，感谢伟大的 &lt;a href="https://github.com/jasonm23/"&gt;Jason Milkins&lt;/a&gt; 做了一堆尝试，
创造了一堆乱七八糟的桌面管理器。然后感谢 &lt;a href="https://github.com/kasper"&gt;Kasper Hirvikoski&lt;/a&gt;
在 Jason 拍拍屁股走人之后，接过了 Jason 的棒子，将 Phoenix 这个项目快速推进，解决了一堆导致不可用的 bug，
并新增了很多特性。&lt;/p&gt;
&lt;p&gt;回到要介绍的主角身上，&lt;a href="https://github.com/kasper/phoenix"&gt;Phoenix&lt;/a&gt;：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;A lightweight OS X window and app manager scriptable with JavaScript&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;基本特性是：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Javascript 作为配置文件，定制性超级强&lt;/li&gt;
&lt;li&gt;支持 App / Window / Space / Screen 等对象的操作&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;基于 Phoenix，我达成了我的窗口管理模式的目标：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;快速启动&lt;ul&gt;
&lt;li&gt;使用 &lt;code&gt;Option&lt;/code&gt; + ` / 1 / 2 / 3 / 4 / 8 / 9 / e / a / s / z /, / . / / 启动&lt;/li&gt;
&lt;li&gt;iTerm / Chrome / Safari / QQ / Bearychat / Wechat / Neteasy Music / MacVim / IntelliJ IDEA / Macdown / Mail / Evernote / Finder&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;窗口操作&lt;ul&gt;
&lt;li&gt;Option + - / =&lt;ul&gt;
&lt;li&gt;大小控制&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Option + m&lt;ul&gt;
&lt;li&gt;窗口移动到屏幕中央&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Option + Space&lt;ul&gt;
&lt;li&gt;鼠标找回到窗口中央&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;屏幕内操作&lt;ul&gt;
&lt;li&gt;Option + J / K&lt;ul&gt;
&lt;li&gt;焦点在同屏幕窗口切换&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Ctrl + Option + J / K / H / L&lt;ul&gt;
&lt;li&gt;窗口移动&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;屏幕间操作&lt;ul&gt;
&lt;li&gt;Option + H / L&lt;ul&gt;
&lt;li&gt;焦点左右屏幕切换&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Space 操作&lt;ul&gt;
&lt;li&gt;Option + I / O&lt;ul&gt;
&lt;li&gt;Space 左右切换&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Option + Ctrl + I / O&lt;ul&gt;
&lt;li&gt;将当前窗口移动到相邻 Space&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Option + Enter&lt;ul&gt;
&lt;li&gt;将当前窗口移动到 Work Space&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Option + Delete&lt;ul&gt;
&lt;li&gt;将当前窗口移动到 Park Space&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Work / Park Space 就是用来帮助我集中精力的&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;我的配置文件在 &lt;a href="https://github.com/alswl/.oOo./blob/master/mac/.phoenix.js"&gt;.oOo./.phoenix.js at master &amp;middot; alswl/.oOo.&lt;/a&gt;
我的配置文件可以开箱即用，但这是我自己的工作模式，想要获得自己最舒适的效果，需要自己进行一些研究和定制。&lt;/p&gt;
&lt;h2 id="qi-ta-yi-xie-ti-dai-fang-an"&gt;其他一些替代方案&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Mac&lt;ul&gt;
&lt;li&gt;SizeUp  # 简单的桌面平铺工具，不支持一键切换&lt;/li&gt;
&lt;li&gt;Spectacle  # 类 SizeUp&lt;/li&gt;
&lt;li&gt;Divvy  # 类 SizeUp，收费&lt;/li&gt;
&lt;li&gt;Slate  # 支持配置，支持一键切换（推荐）&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Linux&lt;ul&gt;
&lt;li&gt;Awesome&lt;ul&gt;
&lt;li&gt;&lt;a href="http://hahack.com/tools/awesome/"&gt;平铺式窗口管理器-Awesome | HaHack&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/alswl/awesome"&gt;我的 Awesome 配置文件（停止位置）&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;xmonad&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Windows&lt;ul&gt;
&lt;li&gt;&lt;a href="https://github.com/fuhsjr00/bug.n"&gt;fuhsjr00/bug.n: Tiling Window Manager for Windows&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;hr/&gt;
&lt;p&gt;我曾经写过一篇 &lt;a href="http://blog.alswl.com/2013/12/mac/"&gt;Linux 程序员的 Mac 安装记录&lt;/a&gt;，
告诉大家我在 Mac 上面常用的工具、包管理器。&lt;/p&gt;
&lt;hr&gt;
&lt;div class="panel"&gt;
&lt;div class="panel-body"&gt;
   &lt;small&gt;原文链接: &lt;a href="https://blog.alswl.com/2016/04/windows-management-for-hacker/"&gt;https://blog.alswl.com/2016/04/windows-management-for-hacker/&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;3a1ff193cee606bd1e2ea554a16353ee&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;欢迎关注我的微信公众号：&lt;a href="http://mp.weixin.qq.com/mp/getmasssendmsg?__biz=MzIyNTIwMTU3MQ==#wechat_webview_type=1&amp;wechat_redirect"&gt;窥豹&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/201605/qrcode_for_gh_17e2f9c2caa4_258.jpg"/&gt;&lt;/small&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/meta/wechat-pay-s-crop.png"/&gt;&lt;/small&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="Mac"></category></entry><entry><title>技术之外</title><link href="https://blog.alswl.com/2016/02/team-geek/" rel="alternate"></link><published>2016-02-28T18:16:01+08:00</published><updated>2016-02-28T18:16:01+08:00</updated><author><name>alswl</name></author><id>tag:blog.alswl.com,2016-02-28:2016/02/team-geek/</id><summary type="html">&lt;p&gt;这是一天一本书的第二次执行，这次选了一本比较薄的书，上周的书看了一天，脑仁疼。&lt;/p&gt;
&lt;hr/&gt;
&lt;p&gt;在我组织团队新兵训练营（入职之后一段时间内容集中的培训）时候，
经常和新同事聊到一个词：软实力。
我将其描述为专业技能之外的能力。每个人都这种能力的解读可能会不一样，
我将其拆解为：「对工作的热情；观察力和反思能力；做计划和决策是否周全」。&lt;/p&gt;
&lt;p&gt;这种拆解是不全面的，「多年」以后，我意识到，硬实力考衡的是专业的能力，
而软实力则是考衡人的因素。这种晚来的意识让我在一段时间里面，
将自己的工作陷入困境，并且得不到解药。&lt;/p&gt;
&lt;p&gt;Google 的两位工程师 Brian W. Fitzpatrick 和 Ben Collins-Sussman
写了一本书&lt;a href="http://book.douban.com/subject/21372237/"&gt;极客与团队&lt;/a&gt;，通过他们的视角，
告诉大家想要在团队中获得成功的另一面。不要被书名误解，我觉得「开发者和团队」是更好的名字，
虽然没那么酷。&lt;/p&gt;
&lt;p&gt;&lt;img alt="s26354473.jpg" src="https://ohsolnxaa.qnssl.com/upload_dropbox/201602/s26354473.jpg"/&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;要在团队中获得成功，你必须以&lt;strong&gt;谦虚&lt;/strong&gt;、&lt;strong&gt;尊重&lt;/strong&gt;和&lt;strong&gt;信任&lt;/strong&gt;为核心原则。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;要做的第一件事情，应该就是沟通了。让自己成为一个玻璃玲珑人，
其他人可以看到你的方向、目标和里程碑，同时可以看到你的进展和问题点。
这样不但可以获得工作中的肯定，当个人的目标设定和团队出现偏差，
又或是开发过程中在一个点停顿了太久，可以有其他人参与进来或直接伸出援手。&lt;/p&gt;
&lt;p&gt;这种透明度对上对下都应该如此。团队的领导，
应当在开发周期内的早期就明确告知团队愿景、目标和设定的里程碑。
产生共鸣的愿景可以让人对目标有渴望，对自己工作有认同。
各位还记得中国中小学开学第一周里，大多都有一个开学典礼讲话。讲的好的领导，
会阐述自己的教学理念，去年取得的成绩，今年的教学着重点。
讲的差的领导就是泛泛而谈，每年都是一套话术，完全看不到长进。&lt;/p&gt;
&lt;p&gt;缺失沟通，还会将个人陷于单打独斗的境地，一个篮球队需要 5 个人大，
一个人牛逼没屁用。&lt;/p&gt;
&lt;p&gt;提高工程质量的一个有效手段就是 CI（持续集成），将开发过程中一点点的小进展都以一种机械的方式呈现出来，
并进行测试。另一个有效手段是 Code Review，不但推荐要 CR，更是要尽早、快速的 CR。
避免屎积压多了拉，太臭。&lt;/p&gt;
&lt;p&gt;我突然想到一条实践：即便是做一个人的项目，在精简程度上也保持最小的一个阈值，
想象明天就要长假，工作要交给别人维护，如何在交付物里面有足够的信息让其他人知晓细节。
而不是丢给后继维护者一句冰冷的话：「看代码」。&lt;/p&gt;
&lt;p&gt;沟通必须是有效的，我想任何人都不想听一个嘴碎的人在那边逼逼一下午。
有很多结构化、一部的沟通可以显著提高沟通效率：
项目看板、设计文档、Code Review、代码注释、数据字典等。&lt;/p&gt;
&lt;p&gt;第二个重要的观点是，接受失败，承认自己不是无能的。你可能很聪明，但所做的事情不一定完全都是正确的，
连上帝都会犯错，何况是普通人。犯错不可怕，但是犯错还认识不到可怕。犯错并且认识到了，
但是拒绝承认错误的人，不是可怕，而是应该要被淘汰，这类人会极其难以合作。
如何你周围都是这样的人，或者你上司是这样的人，也许你可以考虑换一个地方，在拉钩搜索「堆糖」试试吧。&lt;/p&gt;
&lt;p&gt;关于接受失败的另外一个隐含后续发展就是「成长」。意识到这个世界是动态发展的，
「要以发展的眼光看待事物」是一个非常非常有用的认知。
能自己意识到失败，并且会主动复盘，重新认知自己的人，往往会成长的极为迅速。
关于成长的话题可以讨论很深，以后可以单独拎出来讨论。&lt;/p&gt;
&lt;p&gt;书中提到一个失败后回顾的清单：&lt;/p&gt;
&lt;blockquote&gt;
&lt;ol&gt;
&lt;li&gt;简要&lt;/li&gt;
&lt;li&gt;时间的时间线，从发现到调查，再到最终见过&lt;/li&gt;
&lt;li&gt;事件发生的主因&lt;/li&gt;
&lt;li&gt;影响和损失评估&lt;/li&gt;
&lt;li&gt;立即修正问题的步骤&lt;/li&gt;
&lt;li&gt;防止事件再次发生的步骤&lt;/li&gt;
&lt;li&gt;得到的教训&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;p&gt;我就哈哈哈了，这不就是我大堆糖的故障报告模板么？&lt;/p&gt;
&lt;p&gt;第三点，如何成长？简单来说，去冒险，去承担自己能力之外的任务，
去挑战没有经历过的任务。有一条&lt;a href="https://zh.wikipedia.org/wiki/%E5%BD%BC%E5%BE%97%E5%8E%9F%E7%90%86"&gt;彼得定律&lt;/a&gt;：「在组织或企业的等级制度中，
人会因其某种特质或特殊技能，令他在被擢升到不能胜任的职位，相反变成组织的障碍物（冗员）及负资产。」。
前半段含义是，大部分情况下面，并不是具有了相应能力才去承担，而是试着去承担任务。
无论成功与否，对当前去挑战的人来说，都能够得到历练，从而能力得到提升。&lt;/p&gt;
&lt;p&gt;第四点是：成为 Leader，而不是 Manager。
一个团队是一艘危机四伏的海面上一只船，如果没有一个船长，那么就前途叵测。
在职业生涯的某些阶段，你可能自然成为船长，也许是一个项目的船长，也许是一个小 Team 的船长。
那么切记，船长是 Leader，而不是 Manager，是能力综合，可守可攻，顺风时候会把舵，
缺人时候可以顶任何岗位的船长。而不是手持大鞭的 Manager。
我觉得新闻联播里面描述的人民公仆，就是一个很好的 Leader。&lt;/p&gt;
&lt;p&gt;一年多前之前和铁柱聊过，一个 Leader 是否需要要以能力服众。
我仍然保持当初的观点：「是的」。在目标管理、方向把握上面，
强大的技术背景可以有魄力的开展工作，挖掘新技术，推动变化。
在遇到困难时候，可以决策、解决问题。
这是由这个行业特质决定的，互联网是依赖创造力的脑力劳动，而不是根据人数线性增加产出的体力劳动。&lt;/p&gt;
&lt;p&gt;但毕竟不是每个人都一定拥有 Leader 特质，难道就要一辈子做技术得不到上升？
Google 的一种做法，可以很好解决这个问题。分离 TL（techlead）和 TLM（techleadmanager），
前者更着重技术，后者不但关心技术，还关心手下工程师的成长。
用国内互联网的职责分工描述，大概就是有技术专家和团队负责人的区别。&lt;/p&gt;
&lt;p&gt;关于这条，书中的几点最佳实践非常棒：&lt;/p&gt;
&lt;blockquote&gt;
&lt;ol&gt;
&lt;li&gt;放下自负&lt;/li&gt;
&lt;li&gt;做一个禅师（保持冷静和理性）&lt;/li&gt;
&lt;li&gt;成为催化剂&lt;/li&gt;
&lt;li&gt;当一个导师&lt;/li&gt;
&lt;li&gt;设置明确的目标&lt;/li&gt;
&lt;li&gt;坦诚（三明治赞美法）&lt;/li&gt;
&lt;li&gt;记录快乐程度&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;p&gt;最后聊一下对书本身的评价。黄易山在 Quora 写过一段非常有名的
&lt;a href="https://www.quora.com/What-makes-engineering-management-hard"&gt;为什么工程师管理这么难？&lt;/a&gt;。
这本书讨论的内容要比黄易山那篇回答范围更大，讲述的也更详细（废话，这是书）。
作者是典型的工程师，书目结构易读，第五章从反模式来思考问题非常赞。&lt;/p&gt;
&lt;p&gt;我读过几本技术管理相关的书籍，印象深刻的有两本，一本是温伯格的&lt;a href="http://book.douban.com/subject/1132623/"&gt;成为技术领导者&lt;/a&gt;，另外一本是此书。温伯格的行文比较跳跃、比较抽象，不容易读。
而这本书不但通俗异动，也添加了非常具有可操作性的最佳实践。
从创造力驱动的角度出发，技术开发者都是管理者。因为他们需要设计方案，创造价值，而不是重复劳动，
所以我推荐每个开发者阅读。&lt;/p&gt;
&lt;p&gt;好了，学习够了充分的理论，下面就是做起来了，「知行合一」。&lt;/p&gt;
&lt;hr/&gt;
&lt;p&gt;开给自己的处方：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;上面提到的最佳实践&lt;/li&gt;
&lt;li&gt;谦逊：谦逊一些，低调一些，向他人学习&lt;/li&gt;
&lt;li&gt;坚毅：认准目标，稳步前行，不放弃&lt;/li&gt;
&lt;li&gt;信心：信念也许可以重建，但是对自己始终保有信心，也许会错，但是要相信自己的判断&lt;/li&gt;
&lt;li&gt;开会技巧：超过 5 人的会用单向宣讲更有效&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;div class="panel"&gt;
&lt;div class="panel-body"&gt;
   &lt;small&gt;原文链接: &lt;a href="https://blog.alswl.com/2016/02/team-geek/"&gt;https://blog.alswl.com/2016/02/team-geek/&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;3a1ff193cee606bd1e2ea554a16353ee&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;欢迎关注我的微信公众号：&lt;a href="http://mp.weixin.qq.com/mp/getmasssendmsg?__biz=MzIyNTIwMTU3MQ==#wechat_webview_type=1&amp;wechat_redirect"&gt;窥豹&lt;/a&gt;&lt;/small&gt;&lt;br&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/201605/qrcode_for_gh_17e2f9c2caa4_258.jpg"/&gt;&lt;/small&gt;
   &lt;small&gt;&lt;img src="https://ohsolnxaa.qnssl.com/upload_dropbox/meta/wechat-pay-s-crop.png"/&gt;&lt;/small&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="读书笔记"></category></entry></feed>